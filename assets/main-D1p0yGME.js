(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();const F={MAX_TEAM_ID_LENGTH:6,MAX_DEBUG_MESSAGES:50,ANIMATION_DURATION:200,MODE_TOGGLE_SCALE:1.1,SCAN_SIMULATION_DELAY:1e3,NFC_PULSE_INTERVAL:2e3};class Z{constructor(){this.messages=[]}log(e,t=!1){const a=`[${new Date().toLocaleTimeString()}] ${t?"‚ùå":"‚úì"} ${e}`;this.messages.push(a),this.messages.length>F.MAX_DEBUG_MESSAGES&&this.messages.shift(),this.updatePanel(),t?console.error(e):console.log(e)}updatePanel(e=null){const t=document.getElementById("debugContent");t&&(t.textContent=this.messages.join(`
`),e?.viewController?.currentView==="debug"&&(t.scrollTop=t.scrollHeight))}toggle(e=null){e?.viewController?e.viewController.currentView==="debug"?e.viewController.switchView("scanner"):e.viewController.switchView("debug"):console.warn("Debug view not available in this mode")}clear(){this.messages=[],this.updatePanel()}}const h=new Z;let q=class{constructor({settings:e,dataManager:t,sessionModeManager:s,app:n}={}){this.settings=e,this.dataManager=t,this.sessionModeManager=s,this.app=n,this.screens={},this.previousScreen=null,this.errorContainer=null}init(){this.screens={loading:document.getElementById("loadingScreen"),gameModeScreen:document.getElementById("gameModeScreen"),teamEntry:document.getElementById("teamEntryScreen"),scan:document.getElementById("scanScreen"),result:document.getElementById("resultScreen"),history:document.getElementById("historyScreen"),scoreboard:document.getElementById("scoreboardScreen"),teamDetails:document.getElementById("teamDetailsScreen")},this.initErrorDisplay()}initErrorDisplay(){if(!document.getElementById("error-container")){const e=document.createElement("div");e.id="error-container",e.className="error-container",document.body.appendChild(e)}this.errorContainer=document.getElementById("error-container")}showError(e,t=5e3){this.errorContainer||this.initErrorDisplay();const s=document.createElement("div");s.className="error-message",s.textContent=e,this.errorContainer.appendChild(s),setTimeout(()=>{s.style.animation="slideOut 0.3s ease-out forwards",setTimeout(()=>s.remove(),300)},t)}showToast(e,t="info",s=3e3){this.errorContainer||this.initErrorDisplay();const n=document.createElement("div");n.className=`toast toast-${t}`,n.textContent=e,this.errorContainer.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease-out forwards",setTimeout(()=>n.remove(),300)},s)}showScreen(e){const t=document.querySelector(".screen.active");t&&t.id!=="historyScreen"&&t.id!=="scoreboardScreen"&&t.id!=="teamDetailsScreen"&&t.id!=="gameModeScreen"&&t.id!=="loadingScreen"&&e!=="history"&&e!=="scoreboard"&&e!=="teamDetails"&&(this.previousScreen=t.id.replace("Screen","")),Object.values(this.screens).forEach(s=>{s&&s.classList.remove("active")}),this.screens[e]&&this.screens[e].classList.add("active"),e==="teamEntry"&&this.app?.initTeamEntryUI&&this.app.initTeamEntryUI(),e==="scoreboard"&&this.renderScoreboard(),e==="result"&&this._enableResultScreenQuickDismiss()}_enableResultScreenQuickDismiss(){const e=this.screens.result;if(!e)return;const t=s=>{s.target.closest("button")||(e.removeEventListener("click",t),this.showScreen("scan"))};e._quickDismissHandler&&e.removeEventListener("click",e._quickDismissHandler),e._quickDismissHandler=t,e.addEventListener("click",t)}updateModeDisplay(e){const t=document.getElementById("modeIndicator"),s=document.getElementById("modeText"),n=document.getElementById("modeToggle");t&&(e==="blackmarket"?(t.className="mode-indicator mode-blackmarket",t.textContent="Black Market Mode",s&&(s.textContent="Black Market Mode"),n&&(n.checked=!0)):(t.className="mode-indicator mode-detective",t.textContent="Detective Mode",s&&(s.textContent="Detective Mode"),n&&(n.checked=!1)),this.updateNavigationButtons())}updateNavigationButtons(){const e=document.getElementById("scoreboardButton");e&&this.settings&&(e.style.display=this.settings.mode==="blackmarket"?"block":"none")}updateTeamDisplay(e){const t=document.getElementById("teamDisplay");t&&(t.textContent=e||"_")}updateSessionStats(){const e=this.dataManager;if(!e||!this.settings)return;const t=e.getSessionStats(),s=document.getElementById("teamTokenCount"),n=document.getElementById("teamTotalValue"),a=document.getElementById("teamValueLabel");s&&(s.textContent=t.count),n&&(this.settings.mode==="blackmarket"?(n.textContent=`$${t.totalScore.toLocaleString()}`,a&&(a.textContent="Score")):(n.textContent=t.totalValue,a&&(a.textContent="Total Value")))}updateHistoryBadge(){const e=this.dataManager;if(!e)return;const t=document.getElementById("historyBadge");if(!t)return;if(!e.getActiveStrategyType()){t.style.display="none";return}const s=e.getTransactions().length;s>0?(t.textContent=s,t.style.display="inline"):t.style.display="none"}updateHistoryStats(){const e=this.dataManager;if(!e)return;const t=e.getGlobalStats(),s=document.getElementById("totalScans"),n=document.getElementById("uniqueTeams"),a=document.getElementById("totalValue"),i=document.getElementById("avgValue");s&&(s.textContent=t.total),n&&(n.textContent=t.teams),a&&(a.textContent=t.totalValue),i&&(i.textContent=t.avgValue)}renderScoreboard(e=null){const t=this.dataManager;if(!t||!this.app)return;const s=e||document.getElementById("scoreboardContainer");if(!s)return;const n=t.getTeamScores();if(n.length===0){s.innerHTML=`
        <div class="empty-state">
          <h3>No Teams Yet</h3>
          <p>Teams will appear here after scanning tokens</p>
        </div>
      `;return}const a=n[0]?.isFromBackend?'<div class="score-source" style="text-align: center; margin: 10px 0; padding: 10px; background: rgba(103,126,234,0.1); border-radius: 8px; font-size: 14px;">üîó Live from Orchestrator</div>':'<div class="score-source" style="text-align: center; margin: 10px 0; padding: 10px; background: rgba(255,152,0,0.1); border-radius: 8px; font-size: 14px;">üì± Local Calculation</div>';s.innerHTML=a+n.map((i,o)=>{const r=o+1,d=r<=3?`rank-${r}`:"",l=r===1?"ü•á":r===2?"ü•à":r===3?"ü•â":`#${r}`;return`
        <div class="scoreboard-entry ${d}" data-action="app.showTeamDetails" data-arg="${i.teamId}" style="cursor: pointer;">
          <div class="scoreboard-rank">${l}</div>
          <div class="scoreboard-team">
            Team ${i.teamId}
            <span class="scoreboard-tokens">(${i.tokenCount} tokens)</span>
          </div>
          <div class="scoreboard-score">$${i.score.toLocaleString()}</div>
        </div>
      `}).join("")}renderSessionStatus(e){if(!e)return;const t=this.dataManager?.getCurrentSession?.();if(!t){e.innerHTML=`
        <div class="session-status session-status--empty">
          <p class="session-status__message">No Active Session</p>
          <p class="session-status__hint">Create a new session to begin tracking gameplay</p>
          <button class="btn btn-primary" data-action="app.adminCreateSession">
            Create New Session
          </button>
        </div>
      `;return}const s=t.startTime?new Date(t.startTime):null,n=s?this._formatDuration(Date.now()-s.getTime()):"‚Äî";if(t.status==="paused"){e.innerHTML=`
        <div class="session-status session-status--paused">
          <h4 class="session-status__header">
            <span class="session-status__icon">‚è∏Ô∏è</span>
            <span>${this.escapeHtml(t.name||"Session")}</span>
            <span class="session-status__badge session-status__badge--paused">Paused</span>
          </h4>
          <div class="session-status__details">
            <span>Started: ${s?s.toLocaleTimeString():"‚Äî"}</span>
            <span>Duration: ${n}</span>
          </div>
          <div class="session-status__actions">
            <button class="btn btn-primary" data-action="app.adminResumeSession">
              Resume Session
            </button>
            <button class="btn btn-danger" data-action="app.adminEndSession">
              End Session
            </button>
          </div>
        </div>
      `;return}e.innerHTML=`
      <div class="session-status session-status--active">
        <h4 class="session-status__header">
          <span class="session-status__icon">üéÆ</span>
          <span>${this.escapeHtml(t.name||"Session")}</span>
          <span class="session-status__badge session-status__badge--active">Active</span>
        </h4>
        <div class="session-status__details">
          <span>Started: ${s.toLocaleTimeString()}</span>
          <span>Duration: ${n}</span>
        </div>
        <div class="session-status__actions">
          <button class="btn btn-secondary" data-action="app.adminPauseSession">
            Pause Session
          </button>
          <button class="btn btn-danger" data-action="app.adminEndSession">
            End Session
          </button>
        </div>
      </div>
    `}_formatDuration(e){if(!e||e<0)return"0m";const t=Math.floor(e/1e3),s=Math.floor(t/60),n=Math.floor(s/60);return n>0?`${n}h ${s%60}m`:s>0?`${s}m`:`${t}s`}renderTeamDetails(e,t){const s=this.dataManager;if(!s)return;const n=s.getEnhancedTeamTransactions(e),a=s.calculateTeamScoreWithBonuses(e),i=this.sessionModeManager?.isNetworked(),o=document.getElementById("teamDetailsTitle"),r=document.getElementById("teamDetailsSummary");o&&(o.textContent=`Team ${e}`),r&&(r.textContent=`${t.length} token${t.length!==1?"s":""} collected`);let d="";if(n.hasCompletedGroups&&(d+='<div class="section-divider">‚úÖ Completed Groups</div>',n.completedGroups.forEach(y=>{d+=`
          <div class="group-section">
            <div class="group-header completed">
              <div class="group-title">
                <span class="completion-badge">üèÜ</span>
                <span class="group-name">${y.displayName}</span>
                <span class="completion-text">COMPLETE</span>
              </div>
              <div class="bonus-amount">
                +$${y.bonusValue.toLocaleString()} bonus (${y.multiplier}x)
              </div>
            </div>`;const k=this.sessionModeManager?.isNetworked()||this.sessionModeManager?.isStandalone();y.tokens.forEach(T=>{d+=this.renderTokenCard(T,!0,!1,k)}),d+="</div>"})),n.hasIncompleteGroups&&(d+='<div class="section-divider">üî∂ In Progress Groups</div>',n.incompleteGroups.forEach(y=>{d+=`
          <div class="group-section">
            <div class="group-header in-progress">
              <div class="group-title">
                <span class="progress-badge">‚è≥</span>
                <span class="group-name">${y.displayName}</span>
                <span class="progress-text">${y.progress}</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${y.percentage}%"></div>
              </div>
            </div>`;const k=this.sessionModeManager?.isNetworked()||this.sessionModeManager?.isStandalone();y.tokens.forEach(T=>{d+=this.renderTokenCard(T,!1,!1,k)}),d+="</div>"})),n.hasUngroupedTokens){d+='<div class="section-divider">üì¶ Individual Tokens</div>';const y=this.sessionModeManager?.isNetworked()||this.sessionModeManager?.isStandalone();n.ungroupedTokens.forEach(k=>{d+=this.renderTokenCard(k,!1,!1,y)})}n.hasUnknownTokens&&(d+='<div class="section-divider">‚ùì Unknown Tokens</div>',n.unknownTokens.forEach(y=>{d+=this.renderTokenCard(y,!1,!0,i)})),d===""&&(d=`
        <div class="empty-state">
          <h3>No Tokens</h3>
          <p>This team hasn't scanned any tokens yet</p>
        </div>
      `);const l=document.getElementById("teamDetailsContainer");l&&(l.innerHTML=d);const u=i&&this.dataManager?.backendScores?.get(e);let g=a.baseScore,m=a.bonusScore,f=a.totalScore;i&&u&&(g=u.baseScore,m=u.bonusPoints,f=u.currentScore);const S=document.getElementById("teamBaseScore"),w=document.getElementById("teamBonusScore"),E=document.getElementById("teamTotalScore");S&&(S.textContent=`$${g.toLocaleString()}`),w&&(w.textContent=`$${m.toLocaleString()}`),E&&(E.textContent=`$${f.toLocaleString()}`);const _=document.getElementById("teamAdminAdjustmentsSection");if(_&&i&&u?.adminAdjustments?.length>0){const y=u.adminAdjustments,k=y.reduce((M,B)=>M+B.delta,0);let T=`
        <div class="transaction-detail" style="margin: 8px 0; padding: 12px; background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; border-radius: 4px;">
          <label style="color: #856404; font-weight: bold;">‚ö†Ô∏è Admin Adjustments:</label>
          <span class="value" style="color: ${k>=0?"#28a745":"#dc3545"}; font-weight: bold;">
            ${k>=0?"+":""}$${Math.abs(k).toLocaleString()}
          </span>
        </div>
        <div style="margin-left: 20px; font-size: 12px; color: #666;">
      `;y.forEach(M=>{const B=new Date(M.timestamp).toLocaleString();T+=`
          <div style="margin: 4px 0; padding: 6px; background: #f8f9fa; border-radius: 3px;">
            <span style="color: ${M.delta>=0?"#28a745":"#dc3545"}; font-weight: bold;">
              ${M.delta>=0?"+":""}$${Math.abs(M.delta).toLocaleString()}
            </span>
            - ${M.reason||"No reason provided"}
            <br><span style="font-size: 10px; color: #999;">${B} by ${M.gmStation}</span>
          </div>
        `}),T+="</div>",_.innerHTML=T,_.style.display="block"}else _&&(_.style.display="none");const G=document.getElementById("teamInterventionControls");if(G){const y=this.sessionModeManager?.isNetworked()||this.sessionModeManager?.isStandalone();G.style.display=y?"block":"none"}this.app&&(this.app.currentInterventionTeamId=e)}renderTokenCard(e,t=!1,s=!1,n=!1){const a=this.dataManager;if(!a)return"";const i=a.calculateTokenValue(e),o=e.status==="duplicate";let r=s?"unknown":t?"bonus-applied":"";o&&(r+=" duplicate");let d="";if(!s&&!e.isUnknown){const m=a.SCORING_CONFIG.BASE_VALUES[e.valueRating]||0,f=a.SCORING_CONFIG.TYPE_MULTIPLIERS[e.memoryType]||1;if(t){const S=a.parseGroupInfo(e.group),w=i*S.multiplier;d=`
          <strong>${m.toLocaleString()}</strong> √ó
          <strong>${f}x</strong> ${e.memoryType} √ó
          <strong>${S.multiplier}x</strong> group =
          <strong>$${w.toLocaleString()}</strong>`}else d=`
          <strong>${m.toLocaleString()}</strong> √ó
          <strong>${f}x</strong> ${e.memoryType} =
          <strong>$${i.toLocaleString()}</strong>`}else d="Unknown token - No value";const l=n&&e.id?`
      <button class="btn" data-action="app.deleteTeamTransaction" data-arg="${e.id}"
              style="background: #dc3545; color: white; padding: 4px 8px; font-size: 12px; margin-left: 8px; cursor: pointer;">
        üóëÔ∏è Delete
      </button>
    `:"",u=a.parseGroupInfo(e.group),g=t?i*u.multiplier:i;return`
      <div class="token-detail-card ${r}">
        <div class="token-detail-header">
          <span>${e.group}</span>
          <span class="token-detail-value" style="display: flex; align-items: center;">
            <span style="margin-right: 8px;">$${g.toLocaleString()}</span>
            ${l}
          </span>
        </div>
        <div class="token-detail-grid">
          <div class="token-detail-item">
            <span class="token-detail-label">RFID</span>
            <span class="token-detail-info">${e.rfid}</span>
          </div>
          <div class="token-detail-item">
            <span class="token-detail-label">Memory Type</span>
            <span class="token-detail-info">${e.memoryType}</span>
          </div>
          <div class="token-detail-item">
            <span class="token-detail-label">Base Rating</span>
            <span class="token-detail-info">
              ${s?"N/A":`‚≠ê${"‚≠ê".repeat(Math.max(0,e.valueRating-1))}`}
            </span>
          </div>
          <div class="token-detail-item">
            <span class="token-detail-label">Status</span>
            <span class="token-detail-info">
              ${o?"‚ö†Ô∏è Duplicate":t?"‚úÖ Bonus Applied":s?"‚ùì Unknown":"‚è≥ No Bonus"}
            </span>
          </div>
          <div class="token-calculation">
            ${d}
          </div>
        </div>
      </div>
    `}showGroupCompletionNotification(e){const t=document.createElement("div");t.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
      max-width: 350px;
    `,t.innerHTML=`
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">üèÜ</span>
        <div>
          <div style="font-weight: bold; margin-bottom: 5px;">Group Completed!</div>
          <div style="font-size: 14px;">Team ${e.teamId} - ${e.groupId}</div>
          <div style="font-size: 14px;">Bonus: +$${e.bonus.toLocaleString()} (${e.multiplier}x)</div>
        </div>
      </div>
    `,document.body.appendChild(t),setTimeout(()=>{t.style.animation="fadeOut 0.3s ease-out forwards",setTimeout(()=>t.remove(),300)},5e3)}showTokenResult(e,t,s){const n=this.dataManager;if(!n||!this.settings)return;const a=document.getElementById("resultStatus"),i=document.getElementById("resultRfid"),o=document.getElementById("resultType"),r=document.getElementById("resultGroup"),d=document.getElementById("resultValue"),l=document.getElementById("resultSummaryContainer"),u=document.getElementById("resultSummary");if(!(!a||!i||!o||!r||!d)){if(s)a.className="status-message error",a.innerHTML=`
        <h2>Unknown Token</h2>
        <p style="font-size: 14px;">Not in database</p>
      `,i.textContent=t,o.textContent="UNKNOWN",o.style.color="#FF5722",r.textContent=`Raw ID: ${t}`,this.settings.mode==="blackmarket"?d.textContent="$0":d.textContent="No Value",l&&(l.style.display="none");else{if(a.className="status-message success",a.innerHTML="<h2>Transaction Complete!</h2>",i.textContent=t,o.textContent=e.SF_MemoryType,o.style.color="#333",r.textContent=e.SF_Group,this.settings.mode==="blackmarket"){const g=n.calculateTokenValue({valueRating:e.SF_ValueRating,memoryType:e.SF_MemoryType,isUnknown:!1});d.textContent=`$${g.toLocaleString()}`}else d.textContent="‚≠ê".repeat(e.SF_ValueRating||0);e.summary&&l&&u?(l.style.display="flex",u.textContent=e.summary):l&&(l.style.display="none")}this.showScreen("result")}}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}_formatTime(e){return e?new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):""}renderGameActivity(e,t={}){if(!e)return;const{showSummary:s=!0,showFilters:n=!0}=t,a=this.dataManager;if(!a)return;if(typeof a.getGameActivity!="function"){e.innerHTML=`
        <div class="empty-state">
          <h3>Game Activity</h3>
          <p>No activity data available</p>
        </div>
      `;return}const{tokens:i,stats:o}=a.getGameActivity();let r="";if(s&&(r+=`
        <div class="activity-summary">
          <span class="stat">${o.totalTokens} tokens</span>
          <span class="stat available">${o.available} available</span>
          <span class="stat claimed">${o.claimed} claimed</span>
          ${o.claimedWithoutDiscovery>0?`
            <span class="stat warning" title="Tokens claimed by GM without player discovery">
              ${o.claimedWithoutDiscovery} GM-only
            </span>
          `:""}
        </div>
      `),n&&(r+=`
        <div class="activity-filters">
          <input type="text" id="activitySearch" placeholder="Search tokens..." class="search-input">
          <select id="activityFilter" class="filter-select">
            <option value="all">All Tokens</option>
            <option value="available">Available Only</option>
            <option value="claimed">Claimed Only</option>
          </select>
        </div>
      `),r+='<div class="activity-grid">',i.length===0)r+='<div class="empty-state">No token activity yet</div>';else{const d=l=>!l.events||!l.events.length?0:new Date(l.events[l.events.length-1].timestamp);i.sort((l,u)=>d(u)-d(l)).forEach(l=>{r+=this._renderActivityTokenCard(l)})}r+="</div>",e.innerHTML=r,this._attachActivityFilterHandlers(e)}_renderActivityTokenCard(e){const{tokenId:t,tokenData:s,events:n,status:a,discoveredByPlayers:i,potentialValue:o}=e,r=s?.SF_MemoryType||"Unknown",d=s?.SF_ValueRating||0,l=n.filter(f=>f.type==="scan"),u=l.length>0,g=n.find(f=>f.type==="claim");let m;return a==="claimed"&&g?.mode==="blackmarket"?m=`<span class="status-icon">üí∞</span> SOLD to ${this.escapeHtml(g?.teamId||"Unknown")}
        <span class="points">$${(g?.points||0).toLocaleString()}</span>`:a==="claimed"&&g?.mode==="detective"?m=`<span class="status-icon">üîç</span> EXPOSED by ${this.escapeHtml(g?.teamId||"Unknown")}
        <span class="points potential">Worth: $${(o||0).toLocaleString()}</span>`:m=`‚óã AVAILABLE
        <span class="points potential">Worth: $${(o||0).toLocaleString()}</span>`,`
      <div class="token-card ${a}" data-token-id="${t}">
        <!-- Header: Token ID + Type + Rating -->
        <div class="token-card__header">
          <span class="token-id">${this.escapeHtml(t)}</span>
          <span class="token-type type-${r.toLowerCase()}">${r}</span>
        </div>
        <div class="token-card__rating">${"‚òÖ".repeat(d)}${"‚òÜ".repeat(5-d)}</div>

        <!-- Status Bar: Quick-glance current state with mode-specific styling -->
        <div class="token-card__status status-${a} ${g?.mode||""}">
          ${m}
        </div>

        ${s?.summary?`
          <div class="token-card__summary">
            <button class="summary-toggle" onclick="this.parentElement.classList.toggle('expanded')">Intel</button>
            <div class="summary-content">${this.escapeHtml(s.summary)}</div>
          </div>
        `:""}

        <!-- Timeline: Full event history (expandable) -->
        <div class="token-card__timeline ${u?"expandable":""}"
             data-expanded="false">

          ${!i&&a==="claimed"?`
            <div class="event warning">
              <span class="icon">‚ö†Ô∏è</span>
              <span class="label">Not discovered by players</span>
            </div>
          `:""}

          ${n.map((f,S)=>this._renderTimelineEvent(f,S,n.length)).join("")}

          ${a==="available"?`
            <div class="event status-available">
              <span class="status-badge">AWAITING CLAIM</span>
            </div>
          `:""}
        </div>

        ${u?`
          <button class="timeline-toggle" onclick="this.parentElement.querySelector('.token-card__timeline').dataset.expanded =
            this.parentElement.querySelector('.token-card__timeline').dataset.expanded === 'true' ? 'false' : 'true'">
            <span class="expand-text">Show ${l.length} more scans</span>
            <span class="collapse-text">Collapse</span>
          </button>
        `:""}
      </div>
    `}_renderTimelineEvent(e,t,s){const n=this._formatTime(e.timestamp);switch(e.type){case"discovery":return`
          <div class="event discovery">
            <span class="icon">üëÅ</span>
            <span class="label">Discovered</span>
            <span class="device">${this.escapeHtml(e.deviceId)}</span>
            <span class="time">${n}</span>
          </div>
        `;case"scan":return`
          <div class="event scan collapsible">
            <span class="icon">üëÅ</span>
            <span class="label">Scanned</span>
            <span class="device">${this.escapeHtml(e.deviceId)}</span>
            <span class="time">${n}</span>
          </div>
        `;case"claim":return`
          <div class="event claim ${e.mode}">
            <span class="icon">${e.mode==="blackmarket"?"üí∞":"üîç"}</span>
            <span class="label">${e.mode==="blackmarket"?"Black Market":"Detective"}</span>
            <span class="team">${this.escapeHtml(e.teamId)}</span>
            <span class="time">${n}</span>
            <span class="points">$${(e.points||0).toLocaleString()}</span>
            ${e.groupProgress?`
              <div class="group-progress">
                ${this.escapeHtml(e.groupProgress.name)} (${e.groupProgress.found}/${e.groupProgress.total})
              </div>
            `:""}
            ${e.summary?`
              <div class="exposed-summary">
                <span class="summary-label">Intel:</span>
                <span class="summary-text">${this.escapeHtml(e.summary)}</span>
              </div>
            `:""}
          </div>
        `;default:return""}}_attachActivityFilterHandlers(e){const t=e.querySelector("#activitySearch"),s=e.querySelector("#activityFilter");t&&t.addEventListener("input",()=>this._filterGameActivity(e)),s&&s.addEventListener("change",()=>this._filterGameActivity(e))}_filterGameActivity(e){const t=e.querySelector("#activitySearch"),s=e.querySelector("#activityFilter"),n=e.querySelectorAll(".token-card"),a=t?.value?.toLowerCase()||"",i=s?.value||"all";n.forEach(o=>{const r=o.dataset.tokenId?.toLowerCase()||"",d=o.classList.contains("claimed")?"claimed":"available",l=!a||r.includes(a),u=i==="all"||d===i;o.style.display=l&&u?"block":"none"})}};class ee extends EventTarget{constructor(){super(),this.deviceId="001",this.mode="detective"}load(){this.deviceId=localStorage.getItem("deviceId")||"001",this.mode=localStorage.getItem("mode")||"detective",this.dispatchEvent(new CustomEvent("settings:loaded",{detail:{deviceId:this.deviceId,mode:this.mode}}))}save(){const e=localStorage.getItem("deviceId")||"001",t=localStorage.getItem("mode")||"detective";localStorage.setItem("deviceId",this.deviceId),localStorage.setItem("mode",this.mode);const s=document.getElementById("deviceIdDisplay");s&&(s.textContent=this.deviceId),this.dispatchEvent(new CustomEvent("settings:saved",{detail:{deviceId:this.deviceId,mode:this.mode}})),(e!==this.deviceId||t!==this.mode)&&this.dispatchEvent(new CustomEvent("settings:changed",{detail:{deviceId:this.deviceId,mode:this.mode,oldDeviceId:e,oldMode:t}}))}}const x=new ee;class te{constructor(){this.database={},this.groupInventory=null,this._dataManagerHelpers=null}setDataManagerHelpers(e){this._dataManagerHelpers=e}async loadDatabase(){try{let e=await fetch("data/tokens.json");if(!e.ok&&(h.log("Trying root directory for tokens.json"),e=await fetch("tokens.json"),!e.ok))throw new Error("Failed to load tokens.json from data/ or root");return this.database=await e.json(),h.log(`‚úÖ Loaded ${Object.keys(this.database).length} tokens from ${e.url}`),h.log(`Sample keys: ${Object.keys(this.database).slice(0,3).join(", ")}`),this.groupInventory=this.buildGroupInventory(),this.logGroupStats(),!0}catch(e){return h.log(`Token database error: ${e.message}`,!0),!1}}buildGroupInventory(){const e={},t=[];return Object.entries(this.database).forEach(([s,n])=>{const a=this._dataManagerHelpers?this._dataManagerHelpers.parseGroupInfo(n.SF_Group):this._parseGroupInfoFallback(n.SF_Group),i=this._dataManagerHelpers?this._dataManagerHelpers.normalizeGroupName(a.name):this._normalizeGroupNameFallback(a.name);e[i]||(e[i]={displayName:a.name,normalizedName:i,multiplier:a.multiplier,tokens:new Set,rawGroupNames:new Set,memoryTypes:new Set}),e[i].tokens.add(s),e[i].rawGroupNames.add(n.SF_Group),e[i].memoryTypes.add(n.SF_MemoryType),e[i].multiplier!==a.multiplier&&(t.push(`Group "${a.name}" has inconsistent multipliers`),e[i].multiplier=Math.max(e[i].multiplier,a.multiplier)),(a.name.length>e[i].displayName.length||a.name.length===e[i].displayName.length&&a.name>e[i].displayName)&&(e[i].displayName=a.name)}),t.length>0&&(h.log("=== Group Inventory Issues ===",!0),t.forEach(s=>h.log(s,!0))),e}_parseGroupInfoFallback(e){if(!e)return{name:"",multiplier:1};const t=e.match(/^(.+?)\s*\(x(\d+)\)$/i);return t?{name:t[1].trim(),multiplier:parseInt(t[2],10)}:{name:e.trim(),multiplier:1}}_normalizeGroupNameFallback(e){return e.toLowerCase().trim().replace(/\s+/g," ")}logGroupStats(){if(!this.groupInventory)return;h.log("=== Group Inventory Summary ===");const e=Object.values(this.groupInventory);h.log(`Total Groups: ${e.length}`);const t=e.filter(n=>n.multiplier>1&&n.tokens.size>1),s=e.filter(n=>n.tokens.size===1);h.log(`Completable Groups: ${t.length}`),h.log(`Single Token Groups: ${s.length}`),e.sort((n,a)=>a.tokens.size-n.tokens.size).forEach(n=>{h.log(`"${n.displayName}": ${n.tokens.size} tokens, ${n.multiplier}x`),n.tokens.size===1&&n.multiplier>1&&h.log(`  ‚ö†Ô∏è Only 1 token but ${n.multiplier}x multiplier`,!0)})}getGroupInventory(){return this.groupInventory||(this.groupInventory=this.buildGroupInventory()),this.groupInventory}getAllTokens(){return Object.values(this.database)}findToken(e){if(h.log(`üîç findToken called with: "${e}"`),h.log(`Database has ${Object.keys(this.database).length} tokens`),h.log(`First 5 keys: ${Object.keys(this.database).slice(0,5).join(", ")}`),this.database[e])return h.log(`‚úÖ Direct match: ${e}`),{token:this.database[e],matchedId:e};const t=e.replace(/[:-]/g,"").toLowerCase();for(const[s,n]of Object.entries(this.database)){const a=s.replace(/[:-]/g,"").toLowerCase();if(t===a)return h.log(`‚úÖ Fuzzy match: "${e}" -> "${s}"`),{token:n,matchedId:s}}return h.log(`No match found for: ${e}`,!0),null}}const H=new te;class U extends EventTarget{constructor(){super()}async initialize(){throw new Error("IStorageStrategy.initialize() must be implemented")}async addTransaction(e){throw new Error("IStorageStrategy.addTransaction() must be implemented")}async removeTransaction(e){throw new Error("IStorageStrategy.removeTransaction() must be implemented")}getTransactions(){throw new Error("IStorageStrategy.getTransactions() must be implemented")}getTeamScores(){throw new Error("IStorageStrategy.getTeamScores() must be implemented")}async adjustTeamScore(e,t,s){throw new Error("IStorageStrategy.adjustTeamScore() must be implemented")}getGameActivity(){throw new Error("IStorageStrategy.getGameActivity() must be implemented")}async createSession(e,t){throw new Error("IStorageStrategy.createSession() must be implemented")}async endSession(){throw new Error("IStorageStrategy.endSession() must be implemented")}async pauseSession(){throw new Error("IStorageStrategy.pauseSession() must be implemented")}async resumeSession(){throw new Error("IStorageStrategy.resumeSession() must be implemented")}async resetScores(){throw new Error("IStorageStrategy.resetScores() must be implemented")}getCurrentSession(){throw new Error("IStorageStrategy.getCurrentSession() must be implemented")}isReady(){throw new Error("IStorageStrategy.isReady() must be implemented")}dispose(){}}const se={1:1e4,2:25e3,3:5e4,4:75e3,5:15e4},ne={Personal:1,Business:3,Technical:5,UNKNOWN:0},P={baseValues:se,typeMultipliers:ne},$={BASE_VALUES:Object.fromEntries(Object.entries(P.baseValues).map(([c,e])=>[parseInt(c),e])),TYPE_MULTIPLIERS:{...P.typeMultipliers}};function D(c){if(!c)return{name:"Unknown",multiplier:1};const e=c.trim(),t=e.match(/^(.+?)\s*\(x(\d+)\)$/i);if(t){const s=t[1].trim(),n=parseInt(t[2])||1;return n<1?(console.warn(`[scoring] Invalid multiplier ${n} for "${s}", using 1`),{name:s,multiplier:1}):{name:s,multiplier:n}}return{name:e,multiplier:1}}function ae(c){return c?c.trim().toLowerCase().replace(/\s+/g," ").replace(/['\u2018\u2019]/g,"'"):""}function L(c){if(c.isUnknown)return 0;const e=$.BASE_VALUES[c.valueRating]||0,t=$.TYPE_MULTIPLIERS[c.memoryType]??$.TYPE_MULTIPLIERS.UNKNOWN??0;return e*t}function j({transactions:c,playerScans:e,tokenManager:t,options:s={}}){const{transactionFilter:n,pointsFallback:a}=s,i=new Map;e.forEach(r=>{if(i.has(r.tokenId))i.get(r.tokenId).events.push({type:"scan",timestamp:r.timestamp,deviceId:r.deviceId});else{const d=r.tokenData||{};i.set(r.tokenId,{tokenId:r.tokenId,tokenData:d,potentialValue:L({valueRating:d.SF_ValueRating,memoryType:d.SF_MemoryType}),events:[{type:"discovery",timestamp:r.timestamp,deviceId:r.deviceId}],status:"available",discoveredByPlayers:!0})}}),c.forEach(r=>{if(n&&!n(r))return;let d=i.get(r.tokenId);if(!d){const u=t?.findToken(r.tokenId),g=u?{SF_MemoryType:u.SF_MemoryType,SF_ValueRating:u.SF_ValueRating,SF_Group:u.SF_Group||null,summary:u.summary||null}:{SF_MemoryType:r.memoryType,SF_ValueRating:r.valueRating};d={tokenId:r.tokenId,tokenData:g,potentialValue:L({valueRating:g.SF_ValueRating,memoryType:g.SF_MemoryType}),events:[],status:"claimed",discoveredByPlayers:!1},i.set(r.tokenId,d)}const l=a&&!r.points?a(r):r.points||0;d.events.push({type:"claim",timestamp:r.timestamp,mode:r.mode,teamId:r.teamId,points:l,summary:r.summary||d.tokenData?.summary||null}),d.status="claimed"}),i.forEach(r=>{r.events.sort((d,l)=>new Date(d.timestamp)-new Date(l.timestamp))});const o=Array.from(i.values());return{tokens:o,stats:{totalTokens:o.length,available:o.filter(r=>r.status==="available").length,claimed:o.filter(r=>r.status==="claimed").length,claimedWithoutDiscovery:o.filter(r=>r.status==="claimed"&&!r.discoveredByPlayers).length,totalPlayerScans:e.length}}}class ie extends U{constructor({tokenManager:e,debug:t}={}){super(),this.tokenManager=e,this.debug=t,this.SCORING_CONFIG=$,this.sessionData={sessionId:this._generateSessionId(),startTime:new Date().toISOString(),transactions:[],teams:{},mode:"standalone"},this.scannedTokens=new Set,this.playerScans=[]}_generateSessionId(){return`LOCAL_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}isReady(){return!0}async initialize(){this._loadSession()}_loadSession(){const e=localStorage.getItem("standaloneSession");if(e)try{const t=JSON.parse(e),s=new Date(t.startTime).toDateString(),n=new Date().toDateString();s===n&&(this.sessionData=t,this._repopulateScannedTokens(),this.debug?.log(`Loaded session: ${t.sessionId}`))}catch{this.debug?.log("Failed to load session",!0)}}_repopulateScannedTokens(){this.scannedTokens.clear(),this.sessionData.transactions.forEach(e=>{const t=e.tokenId||e.rfid;t&&this.scannedTokens.add(t)})}_saveSession(){localStorage.setItem("standaloneSession",JSON.stringify(this.sessionData))}getTransactions(){return this.sessionData.transactions}getTeamScores(){return Object.values(this.sessionData.teams).map(e=>({teamId:e.teamId,score:e.score,baseScore:e.baseScore,bonusScore:e.bonusPoints,tokenCount:e.tokensScanned,completedGroups:e.completedGroups?.length||0,isFromBackend:!1})).sort((e,t)=>t.score-e.score)}getCurrentSession(){return{sessionId:this.sessionData.sessionId,name:this.sessionData.name,startTime:this.sessionData.startTime,status:this.sessionData.status||"active"}}async createSession(e,t){return this.sessionData={sessionId:this._generateSessionId(),name:e,status:"active",startTime:new Date().toISOString(),transactions:[],teams:{},mode:"standalone"},this.scannedTokens.clear(),this._saveSession(),this.getCurrentSession()}async endSession(){this._saveSession()}async pauseSession(){return!this.sessionData?.sessionId||!this.sessionData?.status?{success:!1,error:"No active session to pause"}:this.sessionData.status==="paused"?{success:!1,error:"Session already paused"}:(this.sessionData.status="paused",this.sessionData.pausedAt=new Date().toISOString(),this._saveSession(),this.dispatchEvent(new CustomEvent("session:updated",{detail:{session:this.getCurrentSession()}})),{success:!0})}async resumeSession(){return!this.sessionData?.sessionId||!this.sessionData?.status?{success:!1,error:"No session to resume"}:this.sessionData.status!=="paused"?{success:!1,error:"Session is not paused"}:(this.sessionData.status="active",delete this.sessionData.pausedAt,this._saveSession(),this.dispatchEvent(new CustomEvent("session:updated",{detail:{session:this.getCurrentSession()}})),{success:!0})}async resetScores(){return Object.keys(this.sessionData.teams).forEach(e=>{const t=this.sessionData.teams[e];t.score=0,t.baseScore=0,t.bonusPoints=0,t.adminAdjustments=[]}),this._saveSession(),this.dispatchEvent(new CustomEvent("scores:cleared",{detail:{}})),{success:!0}}async addTransaction(e){if(this.sessionData?.status==="paused")return{success:!1,error:"Cannot add transaction: session is paused"};if(!e||!e.teamId)return{success:!1,error:"Transaction must have teamId"};this.sessionData.transactions.push(e);const t=e.tokenId||e.rfid;return t&&this.scannedTokens.add(t),this._updateTeamScore(e),this._saveSession(),this.dispatchEvent(new CustomEvent("transaction:added",{detail:{transaction:e,teamScore:this.sessionData.teams[e.teamId]}})),{success:!0,transaction:e,teamScore:this.sessionData.teams[e.teamId]}}_updateTeamScore(e){const t=e.teamId;this.sessionData.teams[t]||(this.sessionData.teams[t]={teamId:t,score:0,baseScore:0,bonusPoints:0,tokensScanned:0,completedGroups:[],lastScanTime:null});const s=this.sessionData.teams[t];e.mode==="blackmarket"&&e.points&&(s.baseScore+=e.points,s.score=s.baseScore+s.bonusPoints),s.tokensScanned++,s.lastScanTime=e.timestamp,e.mode==="blackmarket"&&e.group&&this._checkGroupCompletion(t,e.group)}_checkGroupCompletion(e,t){const s=D(t);if(s.multiplier<=1)return;const n=this.sessionData.teams[e];if(n.completedGroups.includes(s.name))return;const i=this.sessionData.transactions.filter(g=>g.teamId===e&&g.mode==="blackmarket").filter(g=>D(g.group).name===s.name);if(!this.tokenManager)return;const r=this.tokenManager.getAllTokens().filter(g=>g.SF_Group?D(g.SF_Group).name===s.name:!1),d=i.map(g=>g.tokenId);if(r.map(g=>g.SF_RFID).every(g=>d.includes(g))&&r.length>0){const g=i.reduce((f,S)=>f+(S.points||0),0),m=(s.multiplier-1)*g;n.bonusPoints+=m,n.score=n.baseScore+n.bonusPoints,n.completedGroups.push(s.name),this.debug?.log(`Group completed: ${s.name}, bonus: ${m}`)}}async removeTransaction(e){const t=this.sessionData.transactions.findIndex(o=>o.id===e);if(t===-1)return{success:!1,error:`Transaction not found: ${e}`};const s=this.sessionData.transactions.splice(t,1)[0],n=s.tokenId||s.rfid,a=s.teamId;return!this.sessionData.transactions.some(o=>(o.tokenId||o.rfid)===n)&&n&&this.scannedTokens.delete(n),a&&this.sessionData.teams[a]&&this._recalculateTeamScores(a),this._saveSession(),{success:!0,transaction:s}}_recalculateTeamScores(e){const t=this.sessionData.teams[e];t.baseScore=0,t.bonusPoints=0,t.score=0,t.tokensScanned=0,t.completedGroups=[],this.sessionData.transactions.filter(s=>s.teamId===e).forEach(s=>this._updateTeamScore(s))}async adjustTeamScore(e,t,s="Manual adjustment"){if(!this.sessionData.teams[e])return{success:!1,error:`Team not found: ${e}`};const n=this.sessionData.teams[e];n.adminAdjustments||(n.adminAdjustments=[]);const a={delta:parseInt(t),reason:s,timestamp:new Date().toISOString()};return n.adminAdjustments.push(a),n.score+=a.delta,this._saveSession(),{success:!0,teamScore:{...n}}}getGameActivity(){return j({transactions:this.sessionData.transactions,playerScans:this.playerScans,tokenManager:this.tokenManager})}dispose(){}}class oe extends U{constructor({socket:e,tokenManager:t,debug:s}={}){super(),this.socket=e,this.tokenManager=t,this.debug=s,this.transactions=[],this.backendScores=new Map,this.scannedTokens=new Set,this.playerScans=[],this.currentSessionId=null}isReady(){return this.socket?.connected===!0}async initialize(){}async addTransaction(e){return!e||!e.teamId?{success:!1,error:"Transaction must have teamId"}:this.isReady()?(this.debug?.log(`[NetworkedStorage] Submitting transaction: ${e.tokenId} for team ${e.teamId}`),this.socket.emit("transaction:submit",{tokenId:e.tokenId,teamId:e.teamId,deviceId:e.deviceId,deviceType:"gm",mode:e.mode,timestamp:e.timestamp||new Date().toISOString()}),e.tokenId&&this.scannedTokens.add(e.tokenId),{success:!0,pending:!0}):(this.debug?.log("[NetworkedStorage] Cannot add transaction: socket not connected",!0),{success:!1,error:"Socket not connected"})}async removeTransaction(e){return this.isReady()?(this.debug?.log(`[NetworkedStorage] Removing transaction: ${e}`),this.socket.emit("gm:command",{event:"gm:command",data:{action:"transaction:delete",payload:{transactionId:e}},timestamp:new Date().toISOString()}),{success:!0,pending:!0}):(this.debug?.log("[NetworkedStorage] Cannot remove transaction: socket not connected",!0),{success:!1,error:"Socket not connected"})}getTransactions(){return this.transactions}getTeamScores(){return this.backendScores.size===0?[]:Array.from(this.backendScores.entries()).map(([e,t])=>({teamId:e,score:t.currentScore,baseScore:t.baseScore,bonusScore:t.bonusPoints,tokenCount:t.tokensScanned,completedGroups:t.completedGroups?.length||0,isFromBackend:!0})).sort((e,t)=>t.score-e.score)}async adjustTeamScore(e,t,s){return this.isReady()?(this.debug?.log(`[NetworkedStorage] Adjusting score for team ${e}: ${t>0?"+":""}${t} (${s})`),this.socket.emit("gm:command",{event:"gm:command",data:{action:"score:adjust",payload:{teamId:e,delta:t,reason:s}},timestamp:new Date().toISOString()}),{success:!0,pending:!0}):(this.debug?.log("[NetworkedStorage] Cannot adjust score: socket not connected",!0),{success:!1,error:"Socket not connected"})}getGameActivity(){return j({transactions:this.transactions,playerScans:this.playerScans,tokenManager:this.tokenManager,options:{transactionFilter:e=>!e.status||e.status==="accepted",pointsFallback:e=>L({valueRating:e.valueRating,memoryType:e.memoryType})}})}async createSession(e,t){return this.isReady()?(this.debug?.log(`[NetworkedStorage] Creating session: ${e}`),this.socket.emit("gm:command",{event:"gm:command",data:{action:"session:create",payload:{name:e,teams:t}},timestamp:new Date().toISOString()}),{pending:!0}):(this.debug?.log("[NetworkedStorage] Cannot create session: socket not connected",!0),{success:!1,error:"Socket not connected"})}async endSession(){if(!this.isReady()){this.debug?.log("[NetworkedStorage] Cannot end session: socket not connected",!0);return}this.debug?.log("[NetworkedStorage] Ending session"),this.socket.emit("gm:command",{event:"gm:command",data:{action:"session:end",payload:{}},timestamp:new Date().toISOString()})}getCurrentSession(){return this.currentSessionId?{sessionId:this.currentSessionId,status:"active"}:null}async pauseSession(){return this.isReady()?(this.debug?.log("[NetworkedStorage] Pausing session"),this.socket.emit("gm:command",{event:"gm:command",data:{action:"session:pause",payload:{}},timestamp:new Date().toISOString()}),{success:!0,pending:!0}):(this.debug?.log("[NetworkedStorage] Cannot pause session: socket not connected",!0),{success:!1,error:"Socket not connected"})}async resumeSession(){return this.isReady()?(this.debug?.log("[NetworkedStorage] Resuming session"),this.socket.emit("gm:command",{event:"gm:command",data:{action:"session:resume",payload:{}},timestamp:new Date().toISOString()}),{success:!0,pending:!0}):(this.debug?.log("[NetworkedStorage] Cannot resume session: socket not connected",!0),{success:!1,error:"Socket not connected"})}async resetScores(){return this.isReady()?(this.debug?.log("[NetworkedStorage] Resetting all scores"),this.socket.emit("gm:command",{event:"gm:command",data:{action:"scores:reset",payload:{}},timestamp:new Date().toISOString()}),{success:!0,pending:!0}):(this.debug?.log("[NetworkedStorage] Cannot reset scores: socket not connected",!0),{success:!1,error:"Socket not connected"})}setTransactions(e){this.transactions=e}addTransactionFromBroadcast(e){this.transactions.some(s=>s.id===e.id)||this.transactions.push(e)}setBackendScores(e,t){this.backendScores.set(e,t)}resetBackendScores(){const e=Array.from(this.backendScores.keys());for(const t of e){const s=this.backendScores.get(t);this.backendScores.set(t,{...s,currentScore:0,baseScore:0,bonusPoints:0,tokensScanned:0,completedGroups:[],adminAdjustments:[]})}return e}clearBackendScores(){this.backendScores.clear()}setScannedTokens(e){this.scannedTokens=new Set(e)}setPlayerScans(e){this.playerScans=e}addPlayerScan(e){this.playerScans.some(s=>s.id===e.id)||this.playerScans.push(e)}setSessionId(e){this.currentSessionId=e}dispose(){}}class re extends EventTarget{constructor({tokenManager:e,sessionModeManager:t,debug:s}={}){super(),this.tokenManager=e,this.sessionModeManager=t,this.debug=s,this._localStrategy=null,this._networkedStrategy=null,this._activeStrategy=null,this._strategyListeners=new Map,this.scannedTokens=new Set,this.SCORING_CONFIG=$,this.currentSessionId=null,this.videoState={nowPlaying:null,isPlaying:!1,progress:0,duration:0},this.cueState={cues:new Map,activeCues:new Map,disabledCues:new Set},this.environmentState={lighting:{connected:!1,activeScene:null,scenes:[]},audio:{routes:{},ducking:{},availableSinks:[]},bluetooth:{scanning:!1,foundedDevices:[],pairedDevices:[],connectedDevices:[]}},this.sessionState={id:null,name:null,status:"disconnected",teams:[],metadata:{}}}async initializeStandaloneMode(){this._log("Initializing standalone mode"),this._localStrategy=new ie({tokenManager:this.tokenManager,debug:this.debug}),await this._localStrategy.initialize(),this._activeStrategy=this._localStrategy,this._syncScannedTokens(),this._wireStrategyEvents(this._localStrategy),this._log("Standalone mode initialized")}async initializeNetworkedMode(e){this._log("Initializing networked mode");const t=e?.socket||e;this._networkedStrategy=new oe({tokenManager:this.tokenManager,socket:t,debug:this.debug}),await this._networkedStrategy.initialize(),this._activeStrategy=this._networkedStrategy,this._syncScannedTokens(),this._wireStrategyEvents(this._networkedStrategy),this._log("Networked mode initialized")}isReady(){return this._activeStrategy?.isReady()??!1}getActiveStrategyType(){return this._activeStrategy?this._activeStrategy===this._localStrategy?"local":this._activeStrategy===this._networkedStrategy?"networked":null:null}_syncScannedTokens(){this._activeStrategy?.scannedTokens&&(this.scannedTokens=this._activeStrategy.scannedTokens)}_wireStrategyEvents(e){const t=["transaction:added","transaction:deleted","team-score:updated","scores:cleared","data:cleared","game-state:updated","player-scan:added","session:updated"],s=[];t.forEach(n=>{const a=i=>{this.dispatchEvent(new CustomEvent(n,{detail:i.detail}))};e.addEventListener(n,a),s.push({eventName:n,handler:a})}),this._strategyListeners.set(e,s)}_unwireStrategyEvents(e){const t=this._strategyListeners.get(e);t&&(t.forEach(({eventName:s,handler:n})=>{e.removeEventListener(s,n)}),this._strategyListeners.delete(e))}_log(e){this.debug?.log&&this.debug.log(`[UnifiedDataManager] ${e}`)}async addTransaction(e){return this._requireActiveStrategy(),this._activeStrategy.addTransaction(e)}async removeTransaction(e){return this._requireActiveStrategy(),this._activeStrategy.removeTransaction(e)}addTransactionFromBroadcast(e){typeof this._activeStrategy?.addTransactionFromBroadcast=="function"&&(this._activeStrategy.addTransactionFromBroadcast(e),this.dispatchEvent(new CustomEvent("transaction:added",{detail:{transaction:e}})))}getTransactions(){return this._requireActiveStrategy(),this._activeStrategy.getTransactions()}getTeamScores(){return this._requireActiveStrategy(),this._activeStrategy.getTeamScores()}getSessionData(){return this.sessionState?.id?this.sessionState:null}getPlayerScans(){return this._networkedStrategy?.playerScans||[]}async adjustTeamScore(e,t,s){return this._requireActiveStrategy(),this._activeStrategy.adjustTeamScore(e,t,s)}getGameActivity(){return this._requireActiveStrategy(),this._activeStrategy.getGameActivity()}getCurrentSession(){return this._activeStrategy?.getCurrentSession()??null}async createSession(e,t){return this._requireActiveStrategy(),this._activeStrategy.createSession(e,t)}async endSession(){return this._requireActiveStrategy(),this._activeStrategy.endSession()}async pauseSession(){return this._requireActiveStrategy(),this._activeStrategy.pauseSession()}async resumeSession(){return this._requireActiveStrategy(),this._activeStrategy.resumeSession()}async resetScores(){return this._requireActiveStrategy(),this._activeStrategy.resetScores()}dispose(){this._localStrategy&&(this._unwireStrategyEvents(this._localStrategy),this._localStrategy.dispose()),this._networkedStrategy&&(this._unwireStrategyEvents(this._networkedStrategy),this._networkedStrategy.dispose()),this._activeStrategy=null,this._localStrategy=null,this._networkedStrategy=null,this._strategyListeners.clear(),this.scannedTokens=new Set,this._log("Disposed")}_requireActiveStrategy(){if(!this._activeStrategy)throw new Error("UnifiedDataManager: No active strategy. Call initializeStandaloneMode() or initializeNetworkedMode() first.")}isTokenScanned(e){return this.scannedTokens.has(e)}markTokenAsScanned(e){this.scannedTokens.add(e)}unmarkTokenAsScanned(e){this.scannedTokens.delete(e)}calculateTokenValue(e){return L(e)}getTeamTransactions(e){return this.getTransactions().filter(s=>s.teamId===e)}parseGroupInfo(e){return D(e)}normalizeGroupName(e){return ae(e)}resetForNewSession(e=null){this.currentSessionId=e,this.scannedTokens.clear(),this._localStrategy&&this._localStrategy.scannedTokens?.clear(),this._networkedStrategy&&(this._networkedStrategy.scannedTokens?.clear(),this._networkedStrategy.transactions=[],this._networkedStrategy.playerScans=[],this._networkedStrategy.backendScores?.clear(),this._networkedStrategy.setSessionId?.(e)),this._log(`Reset for new session: ${e||"none"}`),this.dispatchEvent(new CustomEvent("data:cleared"))}getTeamCompletedGroups(e){return this._activeStrategy?.getTeamCompletedGroups?this._activeStrategy.getTeamCompletedGroups(e):[]}getEnhancedTeamTransactions(e){const t=this.getTeamTransactions(e),s=this.tokenManager?.getGroupInventory()||{},n=this.getTeamCompletedGroups(e),a=new Set(n.map(m=>m.normalizedName)),i={};n.forEach(m=>{i[m.normalizedName]={displayName:m.name,multiplier:m.multiplier,tokens:[],totalBaseValue:0,bonusValue:0}});const o={},r={},d=[],l=[];t.forEach(m=>{if(m.isUnknown){l.push(m);return}const f=this.parseGroupInfo(m.group),S=this.normalizeGroupName(f.name),w=s[S];if(!w||w.tokens.size<=1){d.push(m);return}const E=this.calculateTokenValue(m);a.has(S)?(o[S]||(o[S]=[]),o[S].push(m),i[S]&&(i[S].tokens.push(m),i[S].totalBaseValue+=E,i[S].bonusValue+=E*(f.multiplier-1))):(r[S]||(r[S]={displayName:w.displayName,multiplier:w.multiplier,tokens:[],totalTokens:w.tokens.size,collectedTokens:0}),r[S].tokens.push(m))}),Object.keys(r).forEach(m=>{const f=r[m];f.collectedTokens=f.tokens.length,f.progress=`${f.collectedTokens}/${f.totalTokens}`,f.percentage=Math.round(f.collectedTokens/f.totalTokens*100)});const u=Object.entries(o).map(([m,f])=>({...i[m],normalizedName:m,tokens:f})).sort((m,f)=>f.bonusValue-m.bonusValue),g=Object.values(r).sort((m,f)=>f.percentage-m.percentage);return{completedGroups:u,incompleteGroups:g,ungroupedTokens:d,unknownTokens:l,hasCompletedGroups:u.length>0,hasIncompleteGroups:g.length>0,hasUngroupedTokens:d.length>0,hasUnknownTokens:l.length>0}}calculateTeamScoreWithBonuses(e){const t=this.getTeamTransactions(e).filter(r=>r.mode==="blackmarket"&&!r.isUnknown),s=this.getTeamCompletedGroups(e),n=new Set(s.map(r=>r.normalizedName));let a=0,i=0;const o={};return s.forEach(r=>{o[r.name]={tokens:0,baseValue:0,bonusValue:0,multiplier:r.multiplier}}),t.forEach(r=>{const d=this.calculateTokenValue(r);a+=d;const l=this.parseGroupInfo(r.group),u=this.normalizeGroupName(l.name);if(n.has(u)){const g=d*(l.multiplier-1);i+=g,o[l.name]&&(o[l.name].tokens++,o[l.name].baseValue+=d,o[l.name].bonusValue+=g)}}),this._log(`Team ${e}: Base=$${a}, Bonus=$${i}`),{baseScore:a,bonusScore:i,totalScore:a+i,completedGroups:s.length,groupBreakdown:o}}getSessionStats(){const e=this.app?.currentTeamId;if(!e)return{count:0,totalValue:0,totalScore:0};const t=this.getTeamTransactions(e),s=t.length,a=t.filter(d=>!d.isUnknown).reduce((d,l)=>d+(l.valueRating||0),0),r=this.getTeamScores().find(d=>d.teamId===e)?.score||0;return{count:s,totalValue:a,totalScore:r}}getGlobalStats(){const e=this.getTransactions(),t=e.length,n=[...new Set(e.map(l=>l.teamId))].length,i=this.getTeamScores().reduce((l,u)=>l+(u.score||0),0),o=Math.floor(i/1e3),r=e.filter(l=>!l.isUnknown),d=r.length>0?(o/r.length).toFixed(1):0;return{total:t,teams:n,totalValue:o,avgValue:d,blackMarketScore:i}}updateTeamScoreFromBackend(e){if(!this._networkedStrategy){this._log("updateTeamScoreFromBackend called but no networked strategy active",!0);return}this._networkedStrategy.setBackendScores(e.teamId,{currentScore:e.currentScore,baseScore:e.baseScore,bonusPoints:e.bonusPoints,tokensScanned:e.tokensScanned,completedGroups:e.completedGroups,adminAdjustments:e.adminAdjustments||[],lastUpdate:e.lastUpdate}),this.dispatchEvent(new CustomEvent("team-score:updated",{detail:{teamId:e.teamId,scoreData:e,transactions:this.getTeamTransactions(e.teamId)}})),this._log(`Score updated from backend for team ${e.teamId}: $${e.currentScore}`)}handlePlayerScan(e){if(!this._networkedStrategy){this._log("handlePlayerScan called but no networked strategy active",!0);return}const t={id:e.scanId,tokenId:e.tokenId,deviceId:e.deviceId,timestamp:e.timestamp,memoryType:e.memoryType||null,videoQueued:e.videoQueued||!1,tokenData:e.tokenData||null};this._networkedStrategy.addPlayerScan(t),this.dispatchEvent(new CustomEvent("player-scan:added",{detail:{playerScan:t}})),this._log(`Player scan added: ${e.tokenId} from ${e.deviceId}`)}setPlayerScansFromServer(e){if(!this._networkedStrategy){this._log("setPlayerScansFromServer called but no networked strategy active",!0);return}if(!Array.isArray(e)){this._log("setPlayerScansFromServer: invalid input (not array)",!0);return}this._networkedStrategy.setPlayerScans(e),this._log(`Synced ${e.length} player scans from server`),this.dispatchEvent(new CustomEvent("player-scans:synced",{detail:{count:e.length}}))}setScannedTokensFromServer(e){if(!this._networkedStrategy){this._log("setScannedTokensFromServer called but no networked strategy active",!0);return}if(!Array.isArray(e)){this._log("setScannedTokensFromServer: invalid input (not array)",!0);return}this._networkedStrategy.setScannedTokens(e),this._syncScannedTokens(),this._log(`Synced ${e.length} scanned tokens from server`)}getVideoState(){return{...this.videoState}}updateVideoState(e){const t={...this.videoState,...e};if(e.status&&(t.isPlaying=e.status==="playing"||e.status==="loading"),e.tokenId){const n=this.tokenManager?.findToken(e.tokenId)?.token;n?t.nowPlaying=n.video||n.name||"Unknown Video":t.nowPlaying=`Token: ${e.tokenId}`}else e.status==="idle"&&(t.nowPlaying=null);this.videoState=t,this.dispatchEvent(new CustomEvent("video-state:updated",{detail:this.getVideoState()}))}clearBackendScores(){if(!this._networkedStrategy){this._log("clearBackendScores called but no networked strategy active",!0);return}const e=this._networkedStrategy.resetBackendScores();this._log(`Backend scores reset to zero for ${e.length} teams`);for(const t of e)this.dispatchEvent(new CustomEvent("team-score:updated",{detail:{teamId:t,scoreData:{teamId:t,currentScore:0},transactions:this.getTeamTransactions(t)}}))}getCueState(){return{cues:this.cueState.cues,activeCues:this.cueState.activeCues,disabledCues:this.cueState.disabledCues}}loadCues(e){this.cueState.cues.clear(),Array.isArray(e)&&e.forEach(t=>{this.cueState.cues.set(t.id,t)}),this._log(`Loaded ${this.cueState.cues.size} cue definitions`)}updateCueStatus(e){const{cueId:t,state:s}=e;s==="running"||s==="paused"?this.cueState.activeCues.set(t,e):(s==="completed"||s==="stopped"||s==="idle"||s==="error")&&this.cueState.activeCues.delete(t),this._dispatchCueUpdate(),this._log(`Cue status updated: ${t} -> ${s}`)}updateCueConfig(e){const{cueId:t,enabled:s}=e;s?this.cueState.disabledCues.delete(t):this.cueState.disabledCues.add(t),this._dispatchCueUpdate(),this._log(`Cue config updated: ${t} -> enabled=${s}`)}handleCueConflict(e){this.dispatchEvent(new CustomEvent("cue:conflict",{detail:e})),this._log(`Cue conflict reported: ${e.cueId} (${e.conflictType})`)}_dispatchCueUpdate(){this.dispatchEvent(new CustomEvent("cue-state:updated",{detail:this.getCueState()}))}updateLightingState(e){const{lighting:t}=this.environmentState;let s=!1;e.connected!==void 0&&t.connected!==e.connected&&(t.connected=e.connected,s=!0),e.sceneId&&(t.activeScene={id:e.sceneId,name:e.sceneName||e.sceneId},s=!0),Array.isArray(e.scenes)&&(t.scenes=e.scenes,s=!0),s&&this.dispatchEvent(new CustomEvent("lighting-state:updated",{detail:{lighting:{...t}}}))}updateAudioState(e){let t=!1;e.availableSinks&&(this.environmentState.audio.availableSinks=e.availableSinks,t=!0),e.routes&&(this.environmentState.audio.routes={...e.routes},t=!0),e.stream&&e.sink&&(this.environmentState.audio.routes[e.stream]=e.sink,t=!0),t&&this.dispatchEvent(new CustomEvent("audio-state:updated",{detail:{audio:{...this.environmentState.audio}}}))}updateAudioDucking(e){e.stream&&(this.environmentState.audio.ducking[e.stream]={ducked:e.ducked,volume:e.volume},this.dispatchEvent(new CustomEvent("audio-state:updated",{detail:{audio:{...this.environmentState.audio}}})))}updateBluetoothScan(e){e.scanning!==void 0&&(this.environmentState.bluetooth.scanning=e.scanning,this.dispatchEvent(new CustomEvent("bluetooth-state:updated",{detail:{bluetooth:{...this.environmentState.bluetooth}}})))}updateBluetoothDevice(e){const{type:t,device:s}=e,n=this.environmentState.bluetooth;if(!(!s||!s.address)){if(t==="discovered"){const a=n.foundedDevices.findIndex(i=>i.address===s.address);a>=0?n.foundedDevices[a]=s:n.foundedDevices.push(s)}else if(t==="connected"){const a=n.connectedDevices.findIndex(i=>i.address===s.address);a>=0?n.connectedDevices[a]=s:n.connectedDevices.push(s)}else if(t==="disconnected")n.connectedDevices=n.connectedDevices.filter(a=>a.address!==s.address);else if(t==="paired"){const a=n.pairedDevices.findIndex(i=>i.address===s.address);a>=0?n.pairedDevices[a]=s:n.pairedDevices.push(s)}else t==="unpaired"&&(n.pairedDevices=n.pairedDevices.filter(a=>a.address!==s.address),n.connectedDevices=n.connectedDevices.filter(a=>a.address!==s.address));this.dispatchEvent(new CustomEvent("bluetooth-state:updated",{detail:{bluetooth:{...n}}}))}}updateBluetoothState(e){if(!e)return;const t=this.environmentState.bluetooth;let s=!1;e.scanning!==void 0&&(t.scanning=e.scanning,s=!0),Array.isArray(e.pairedDevices)&&(t.pairedDevices=e.pairedDevices,s=!0),Array.isArray(e.connectedDevices)&&(t.connectedDevices=e.connectedDevices,s=!0),s&&this.dispatchEvent(new CustomEvent("bluetooth-state:updated",{detail:{bluetooth:{...t}}}))}updateSessionState(e){if(!e){this.sessionState={},this.currentSessionId=null,this.dispatchEvent(new CustomEvent("session-state:updated",{detail:{session:this.sessionState}}));return}this.sessionState={...this.sessionState,...e},e.id&&(this.currentSessionId=e.id),this.dispatchEvent(new CustomEvent("session-state:updated",{detail:{session:this.sessionState}}))}}let ce=class extends EventTarget{constructor(){super(),this.teams=new Map,this.mode=null,this.sessionModeManager=null,this.orchestratorClient=null}setMode(e){this.mode=e}getTeams(){return Array.from(this.teams.values())}getTeam(e){return this.teams.get(e)}hasTeam(e){return this.teams.has(e)}addTeam(e,t={}){if(!e||typeof e!="string")return console.warn("[TeamRegistry] Invalid teamId:",e),!1;const s=e.trim();if(!s)return console.warn("[TeamRegistry] Empty teamId after trim"),!1;const n=this.teams.get(s);return n?this.teams.set(s,{...n,...t,teamId:s}):(this.teams.set(s,{teamId:s,score:0,tokensScanned:0,...t}),this.dispatchEvent(new CustomEvent("team:added",{detail:{teamId:s,teamInfo:this.teams.get(s)}}))),this.dispatchEvent(new CustomEvent("teams:updated",{detail:{teams:this.getTeams()}})),!0}removeTeam(e){const t=this.teams.delete(e);return t&&this.dispatchEvent(new CustomEvent("teams:updated",{detail:{teams:this.getTeams()}})),t}clear(){this.teams.clear(),this.dispatchEvent(new CustomEvent("teams:updated",{detail:{teams:[]}}))}populateFromSession(e){e&&(this.teams.clear(),e.scores&&Array.isArray(e.scores)&&e.scores.forEach(t=>{this.teams.set(t.teamId,{teamId:t.teamId,score:t.currentScore||t.score||0,tokensScanned:t.tokensScanned||0,baseScore:t.baseScore||0,bonusPoints:t.bonusPoints||0})}),e.teams&&Array.isArray(e.teams)&&e.teams.forEach(t=>{this.teams.has(t)||this.teams.set(t,{teamId:t,score:0,tokensScanned:0})}),this.dispatchEvent(new CustomEvent("teams:updated",{detail:{teams:this.getTeams()}})))}populateFromStandaloneSession(e){e?.teams&&(this.teams.clear(),Object.entries(e.teams).forEach(([t,s])=>{this.teams.set(t,{teamId:t,score:s.score||0,tokensScanned:s.tokensScanned||0,baseScore:s.baseScore||0,bonusPoints:s.bonusPoints||0})}),this.dispatchEvent(new CustomEvent("teams:updated",{detail:{teams:this.getTeams()}})))}populateDropdown(e,t={}){if(!e)return;const{placeholder:s="Select Team...",selectedTeamId:n=null}=t;e.innerHTML="";const a=document.createElement("option");a.value="",a.textContent=s,a.disabled=!0,a.selected=!n,e.appendChild(a),this.getTeams().sort((o,r)=>o.teamId.localeCompare(r.teamId)).forEach(o=>{const r=document.createElement("option");r.value=o.teamId,r.textContent=o.teamId,o.teamId===n&&(r.selected=!0),e.appendChild(r)})}async selectTeam(e){if(!e?.trim())return{success:!1,error:"Team name required"};const t=e.trim();if(this.sessionModeManager?.isStandalone())return this._addToRecentTeams(t),{success:!0};if(!this.hasTeam(t)){const s=await this._createTeamOnBackend(t);if(!s.success)return s}return{success:!0}}getTeamsForDisplay(){return this.sessionModeManager?.isStandalone()?this._getRecentTeams():this.getTeams().map(e=>e.teamId)}getTeamListLabel(){return this.sessionModeManager?.isStandalone()?"Recent Teams:":"Session Teams:"}_getRecentTeams(){try{return JSON.parse(localStorage.getItem("aln_recent_teams")||"[]")}catch{return[]}}_addToRecentTeams(e){const t=this._getRecentTeams().filter(n=>n!==e);t.unshift(e);const s=t.slice(0,10);localStorage.setItem("aln_recent_teams",JSON.stringify(s))}async _createTeamOnBackend(e){if(!this.orchestratorClient)return{success:!1,error:"Not connected"};try{const t=await this.orchestratorClient.sendCommand("session:addTeam",{teamId:e},1e4);return t.success?(this.addTeam(e),{success:!0}):{success:!1,error:t.message||"Failed to create team"}}catch(t){return{success:!1,error:t.message}}}};class de{constructor(){this.reader=null,this.isScanning=!1,this.lastRead=null,this.debounceMs=2e3}async init(){return"NDEFReader"in window}async startScan(e,t){if(!("NDEFReader"in window))throw new Error("NFC not supported");try{this.reader=new NDEFReader,this.reader.addEventListener("reading",({message:s,serialNumber:n})=>{try{const a=this.extractTokenId(s,n),i=Date.now(),o=a.id||n;if(o){if(this.lastRead&&this.lastRead.id===o&&i-this.lastRead.timestamp<this.debounceMs){h.log(`Debounced duplicate ${a.id?"read":"error"}: ${o}`);return}this.lastRead={id:o,timestamp:i}}e(a)}catch(a){console.error("Exception in NFC reading handler:",a),h.log(`Exception in NFC reading handler: ${a.message}`,!0)}}),this.reader.addEventListener("readingerror",s=>{h.log(`NFC Read Error: ${s}`,!0),t&&t(s)}),await this.reader.scan(),this.isScanning=!0}catch(s){throw h.log(`Error starting NFC: ${s.message}`,!0),s}}extractTokenId(e,t){if(h.log("‚ïê‚ïê‚ïê NFC TAG DETECTED ‚ïê‚ïê‚ïê"),h.log(`Serial: ${t}`),h.log(`Records: ${e.records?.length||0}`),!e.records||e.records.length===0)return h.log("No NDEF records found - returning error"),{id:null,source:"error",error:"no-ndef-records",raw:t};for(const s of e.records){if(h.log(`Record type: ${s.recordType}`),s.recordType==="text"){const a=new TextDecoder(s.encoding||"utf-8").decode(s.data);return h.log(`‚úÖ Text record: ${a}`),{id:a.trim(),source:"text-record",raw:a}}if(s.recordType==="url"){const a=new TextDecoder().decode(s.data);return h.log(`‚úÖ URL record: ${a}`),{id:a,source:"url-record",raw:a}}if(s.data)try{const n=new TextDecoder().decode(s.data);if(n&&n.trim())return h.log(`‚úÖ Generic decode: ${n}`),{id:n.trim(),source:"generic-decode",raw:n}}catch(n){h.log(`Decode failed: ${n.message}`)}}return h.log("No readable records found - returning error"),{id:null,source:"error",error:"unreadable-records",raw:t}}stopScan(){this.isScanning=!1}simulateScan(){const e=["a1b2c3d4","deadbeef","cafe1234","babe2468","feed5678","unknown_"+Math.random().toString(36).substr(2,9)],t=e[Math.floor(Math.random()*e.length)];return{id:t,source:"simulated",raw:t}}}const Q=new de;function N(c){if(!c)return!1;try{const e=c.split(".");if(e.length!==3)return!1;const s=JSON.parse((typeof atob<"u"?i=>atob(i):i=>Buffer.from(i,"base64").toString())(e[1]));if(!s.exp)return!1;const n=Math.floor(Date.now()/1e3);return s.exp-60>n}catch{return!1}}class le{constructor(e={}){this.timeout=e.timeout||5e3}async validateAll(e){h.log("[StateValidation] Starting full validation...");const t={valid:!1,reason:null,details:{tokenValid:!1,orchestratorReachable:!1,sessionExists:!1}},s=localStorage.getItem("aln_auth_token");return s?this.isTokenValid(s)?(t.details.tokenValid=!0,h.log("[StateValidation] Token valid"),e?await this.checkOrchestratorHealth(e)?(t.details.orchestratorReachable=!0,h.log("[StateValidation] Orchestrator reachable"),await this.checkSessionExists(e)?(t.details.sessionExists=!0,h.log("[StateValidation] Session exists"),t.valid=!0,h.log("[StateValidation] All validations PASSED"),t):(t.reason="No active session on orchestrator",h.log(`[StateValidation] FAIL: ${t.reason}`),t)):(t.reason="Orchestrator unreachable",h.log(`[StateValidation] FAIL: ${t.reason}`),t):(t.reason="No orchestrator URL configured",h.log(`[StateValidation] FAIL: ${t.reason}`),t)):(t.reason="Authentication token expired",h.log(`[StateValidation] FAIL: ${t.reason}`),t):(t.reason="No authentication token found",h.log(`[StateValidation] FAIL: ${t.reason}`),t)}isTokenValid(e){return N(e)}async checkOrchestratorHealth(e){try{const t=new AbortController,s=setTimeout(()=>t.abort(),this.timeout),n=await fetch(`${e}/health`,{method:"GET",signal:t.signal});return clearTimeout(s),n.ok}catch(t){return h.log(`[StateValidation] Health check error: ${t.message}`),!1}}async checkSessionExists(e){try{const t=new AbortController,s=setTimeout(()=>t.abort(),this.timeout),n=await fetch(`${e}/api/session`,{method:"GET",signal:t.signal});if(clearTimeout(s),!n.ok)return!1;const a=await n.json();return!!(a&&a.id)}catch(t){return h.log(`[StateValidation] Session check error: ${t.message}`),!1}}clearStaleState(){h.log("[StateValidation] Clearing stale state..."),localStorage.removeItem("aln_auth_token"),localStorage.removeItem("aln_game_session_mode"),localStorage.removeItem("aln_session_data"),h.log("[StateValidation] Stale state cleared")}}const z=new le;function ue(c){c.init()}function he(c){const e=new c;return h.log("SessionModeManager initialized"),e}function me(c){c.init()}function ge(c){c.load()}function pe(c,e){e.updateHistoryBadge()}async function fe(c){const e=await c.init();return h.log(`NFC support: ${e}`),e}async function Se(c,e){if(!("serviceWorker"in c))return!1;try{const t=new URL("sw.js",window.location.href).pathname,s=await c.serviceWorker.register(t);return h.log("Service Worker registered successfully"),console.log("Service Worker registration successful:",s.scope),!0}catch(t){return t.name==="SecurityError"&&t.message.includes("SSL certificate error")?(h.log("Service Worker registration skipped due to SSL certificate (self-signed cert)"),console.warn("Service Worker not available due to self-signed certificate. Offline features disabled."),!1):(h.log("Service Worker registration failed"),console.error("Service Worker registration failed:",t),e.showError("Service Worker registration failed. Offline features may not work."),!1)}}async function ve(c,e){if(!await c.loadDatabase()){const s="CRITICAL: Token database failed to load. Cannot initialize scanner.";throw h.log(s,!0),e.showError(s),new Error("Token database initialization failed")}return h.log("Token database loaded successfully"),!0}function ye(c,e){const s=new URLSearchParams(c).get("mode");return s==="blackmarket"||s==="black-market"?(e.mode="blackmarket",e.save(),h.log("Station mode set to blackmarket via URL parameter"),!0):!1}function be(c){const e=c.restoreMode();if(!e)return{screen:"gameModeScreen",action:null,savedMode:null};if(e==="standalone")return{screen:"teamEntry",action:"initStandalone",savedMode:e};if(e==="networked"){const t=localStorage.getItem("aln_auth_token");return t&&N(t)?{screen:"loading",action:"autoConnect",savedMode:e}:{screen:"gameModeScreen",action:"clearModeAndShowWizard",savedMode:e}}return{screen:"gameModeScreen",action:null,savedMode:null}}async function we(c){const e=c.restoreMode();if(!e)return{screen:"gameModeScreen",action:null,savedMode:null,validationResult:null};if(e==="standalone")return{screen:"teamEntry",action:"initStandalone",savedMode:e,validationResult:null};if(e==="networked"){const t=localStorage.getItem("aln_orchestrator_url");h.log("[InitSteps] Performing full state validation for networked mode...");const s=await z.validateAll(t);return s.valid?(h.log("[InitSteps] Validation passed - attempting auto-connect"),{screen:"loading",action:"autoConnect",savedMode:e,validationResult:s}):(h.log(`[InitSteps] Validation failed: ${s.reason}`),z.clearStaleState(),{screen:"gameModeScreen",action:"clearModeAndShowWizard",savedMode:e,validationResult:s})}return{screen:"gameModeScreen",action:null,savedMode:null,validationResult:null}}async function ke(c,e,t,s,n=null){if(h.log(`Applying screen decision: screen=${c.screen}, action=${c.action}`),c.action==="clearModeAndShowWizard")h.log("Networked mode restored but no valid token - showing wizard"),e.clearMode(),t.showScreen(c.screen),s();else if(c.action==="initStandalone")h.log("Restoring standalone mode"),e.setMode("standalone"),t.showScreen(c.screen);else if(c.action==="autoConnect"){h.log("Valid token found - attempting auto-connect"),t.showScreen(c.screen);try{if(e.setMode("networked"),n)await n(),h.log("Auto-connect successful - showing team entry"),t.showScreen("teamEntry");else throw new Error("initNetworkedModeFn not provided for auto-connect")}catch(a){h.log("Auto-connect failed - showing wizard"),console.error("Auto-connect error:",a),e.clearMode(),t.showScreen("gameModeScreen"),s()}}else h.log(`Showing initial screen: ${c.screen}`),t.showScreen(c.screen)}async function Me(c){c.showScreen("loading"),await new Promise(e=>setTimeout(e,100)),h.log("Loading screen displayed")}const W={initializeUIManager:ue,createSessionModeManager:he,initializeViewController:me,loadSettings:ge,loadDataManager:pe,detectNFCSupport:fe,registerServiceWorker:Se,loadTokenDatabase:ve,applyURLModeOverride:ye,determineInitialScreen:be,validateAndDetermineInitialScreen:we,applyInitialScreenDecision:ke,showLoadingScreen:Me},Ie="modulepreload",Ce=function(c){return"/ALNScanner/"+c},O={},Te=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){let r=function(d){return Promise.all(d.map(l=>Promise.resolve(l).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),o=i?.nonce||i?.getAttribute("nonce");n=r(t.map(d=>{if(d=Ce(d),d in O)return;O[d]=!0;const l=d.endsWith(".css"),u=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${u}`))return;const g=document.createElement("link");if(g.rel=l?"stylesheet":Ie,l||(g.as="script"),g.crossOrigin="",g.href=d,o&&g.setAttribute("nonce",o),document.head.appendChild(g),l)return new Promise((m,f)=>{g.addEventListener("load",m),g.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${d}`)))})}))}function a(i){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=i,window.dispatchEvent(o),!o.defaultPrevented)throw i}return n.then(i=>{for(const o of i||[])o.status==="rejected"&&a(o.reason);return e().catch(a)})};class Ee{constructor(){this.mode=null,this.locked=!1}setMode(e){if(this.locked)throw new Error("Cannot change session mode after it is locked");if(e!=="networked"&&e!=="standalone")throw new Error(`Invalid session mode: ${e}. Must be 'networked' or 'standalone'`);this.mode=e,this.locked=!0,this._persistMode(e)}isNetworked(){return this.mode==="networked"}isStandalone(){return this.mode==="standalone"}restoreMode(){const e=this._getPersistedMode();return e&&(e==="networked"||e==="standalone")?(this.mode=e,e):null}clearMode(){this.mode=null,this.locked=!1,this._clearPersistedMode()}getMode(){return this.mode}isLocked(){return this.locked}_persistMode(e){try{localStorage.setItem("gameSessionMode",e)}catch(t){console.error("Failed to persist session mode:",t)}}_getPersistedMode(){try{return localStorage.getItem("gameSessionMode")}catch(e){return console.error("Failed to read persisted session mode:",e),null}}_clearPersistedMode(){try{localStorage.removeItem("gameSessionMode")}catch(e){console.error("Failed to clear persisted session mode:",e)}}}class _e extends EventTarget{constructor(e={}){super(),this.config={url:e.url||"https://localhost:3000",deviceId:e.deviceId||"GM_STATION_UNKNOWN",version:"1.0.0",transports:["websocket"]},this.socket=null,this.isConnected=!1,this.connectionTimeout=null}async connect(e,t){return this.socket?.connected&&console.warn("OrchestratorClient: Already connected, cleaning up old socket"),this._cleanup(),this.socket=io(this.config.url,{transports:this.config.transports,reconnection:!1,timeout:1e4,auth:{token:e,deviceId:t.deviceId,deviceType:t.deviceType,version:this.config.version}}),this._setupSocketHandlers(),new Promise((s,n)=>{const a=()=>{this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=null),this.isConnected=!0,this.dispatchEvent(new CustomEvent("socket:connected")),s()},i=o=>{this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=null),this.dispatchEvent(new CustomEvent("socket:error",{detail:{error:o}})),n(o)};this.connectionTimeout=setTimeout(()=>{this.socket&&(this.socket.off("connect",a),this.socket.off("connect_error",i)),this.connectionTimeout=null,n(new Error("Connection timeout"))},1e4),this.socket.once("connect",a),this.socket.once("connect_error",i)})}send(e,t){if(!this.socket?.connected)throw new Error("Socket not connected");this.socket.emit(e,{event:e,data:t,timestamp:new Date().toISOString()})}async sendCommand(e,t={},s=5e3){if(!this.socket?.connected)throw new Error("Socket not connected");return new Promise((n,a)=>{const i=setTimeout(()=>{r(),a(new Error(`Command ${e} timed out`))},s),o=d=>{const l=d.data||d;l.action===e&&(r(),n({success:l.success,message:l.message||""}))},r=()=>{clearTimeout(i),this.socket.off("gm:command:ack",o)};this.socket.on("gm:command:ack",o),this.socket.emit("gm:command",{event:"gm:command",data:{action:e,payload:t},timestamp:new Date().toISOString()})})}async disconnect(){if(this.socket)return new Promise(e=>{if(!this.socket.connected){this._cleanup(),e();return}this.socket.once("disconnect",t=>{this.dispatchEvent(new CustomEvent("socket:disconnected",{detail:{reason:t}})),this._cleanup(),e()}),this.socket.disconnect(),setTimeout(()=>{this._cleanup(),e()},1e3)})}destroy(){this._cleanup()}_setupSocketHandlers(){this.socket&&(this.socket.on("connect",()=>{this.isConnected=!0,this.dispatchEvent(new CustomEvent("socket:connected"))}),this.socket.on("disconnect",e=>{this.isConnected=!1,this.dispatchEvent(new CustomEvent("socket:disconnected",{detail:{reason:e}}))}),this.socket.on("connect_error",e=>{this.dispatchEvent(new CustomEvent("socket:error",{detail:{error:e}}))}),this._setupMessageHandlers())}_setupMessageHandlers(){["sync:full","transaction:result","transaction:new","transaction:deleted","score:updated","scores:reset","video:status","session:update","session:overtime","device:connected","device:disconnected","group:completed","display:mode","video:progress","video:queue:update","gm:command:ack","offline:queue:processed","batch:ack","error","player:scan","bluetooth:device","bluetooth:scan","audio:routing","audio:routing:fallback","lighting:scene","lighting:status","gameclock:status","cue:fired","cue:status","cue:completed","cue:error","cue:conflict","sound:status","spotify:status","audio:ducking:status","audio:sinks"].forEach(t=>{this.socket.on(t,s=>{const n=s.data||s;this.dispatchEvent(new CustomEvent("message:received",{detail:{type:t,payload:n}}))})})}_cleanup(){this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=null),this.socket&&(this.socket.removeAllListeners(),this.socket.connected&&this.socket.disconnect(),this.socket=null),this.isConnected=!1}}class $e extends EventTarget{constructor(e={}){super(),this.config={url:e.url||"https://localhost:3000",deviceId:e.deviceId||"GM_STATION_UNKNOWN",deviceType:"gm"},this.client=e.client,this.token=e.token||null,this.state="disconnected",this.retryCount=0,this.maxRetries=e.maxRetries||5,this.retryTimer=null,this.disconnectHandler=null,this.addEventListener("connecting",()=>this._updateGlobalConnectionStatus("connecting")),this.addEventListener("connected",()=>this._updateGlobalConnectionStatus("connected")),this.addEventListener("disconnected",()=>this._updateGlobalConnectionStatus("disconnected"))}isTokenValid(){return N(this.token)}async checkHealth(){try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),s=await fetch(`${this.config.url}/health`,{method:"GET",mode:"cors",signal:e.signal});return clearTimeout(t),s.ok}catch{return!1}}async connect(){if(!this.isTokenValid())throw this.dispatchEvent(new CustomEvent("auth:required",{detail:{reason:"invalid_token"}})),new Error("Invalid or expired token");if(!await this.checkHealth())throw new Error("Orchestrator unreachable");this._clearRetryTimer(),this.state="connecting",this.dispatchEvent(new CustomEvent("connecting"));try{await this.client.connect(this.token,{deviceId:this.config.deviceId,deviceType:this.config.deviceType}),this.state="connected",this.retryCount=0,this.dispatchEvent(new CustomEvent("connected")),this._setupReconnectionHandler()}catch(t){throw this.state="disconnected",this.retryCount++,this.retryCount<this.maxRetries?this._scheduleRetry():this.dispatchEvent(new CustomEvent("auth:required",{detail:{reason:"max_retries"}})),t}}async disconnect(){this._clearRetryTimer(),this._removeReconnectionHandler(),this.client&&await this.client.disconnect(),this.state="disconnected"}updateToken(e){this.token=e}_setupReconnectionHandler(){this.disconnectHandler&&this._removeReconnectionHandler(),this.disconnectHandler=e=>{const t=e.detail?.reason;if(this.state="disconnected",this.dispatchEvent(new CustomEvent("disconnected",{detail:{reason:t}})),t==="io server disconnect"){if(!this.isTokenValid()){this.dispatchEvent(new CustomEvent("auth:required",{detail:{reason:"token_expired"}}));return}setTimeout(()=>{this.connect().catch(()=>{})},1e3)}},this.client.addEventListener("socket:disconnected",this.disconnectHandler)}_removeReconnectionHandler(){this.disconnectHandler&&(this.client.removeEventListener("socket:disconnected",this.disconnectHandler),this.disconnectHandler=null)}_scheduleRetry(){const e=this._calculateRetryDelay();this.retryTimer=setTimeout(()=>{this.connect().catch(()=>{})},e)}_calculateRetryDelay(){const s=1e3*Math.pow(2,this.retryCount);return Math.min(s,3e4)}_clearRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}_updateGlobalConnectionStatus(e){const t=document.getElementById("connectionStatus");if(!t)return;t.classList.remove("connected","connecting","disconnected"),t.classList.add(e);const s=t.querySelector(".status-text");if(s){const n={connecting:"Connecting...",connected:"Connected",disconnected:"Disconnected"};s.textContent=n[e]||"Unknown"}}}class De extends EventTarget{constructor(e={}){super(),this.client=e.client,this.debug=e.debug||console,this.deviceId=e.deviceId||"GM_STATION_UNKNOWN",this.tempQueue=[],this.syncing=!1,this.activeHandlers=new Map,this.loadQueue()}queueTransaction(e){!this.client||!this.client.isConnected?(this.tempQueue.push(e),this.saveQueue(),this.debug.log("Transaction queued for later submission",{tokenId:e.tokenId,queueSize:this.tempQueue.length}),this.dispatchEvent(new CustomEvent("queue:changed",{detail:this.getStatus()}))):(this.client.send("transaction:submit",e),this.debug.log("Transaction sent immediately",{tokenId:e.tokenId}))}async syncQueue(){if(this.syncing||this.tempQueue.length===0||!this.client||!this.client.isConnected)return;this.syncing=!0,this.debug.log("Starting queue sync via WebSocket replay",{queueSize:this.tempQueue.length});const e=[...this.tempQueue],t=[];try{for(let a=0;a<e.length;a++){const i=e[a];this.debug.log(`Replaying transaction ${a+1}/${e.length}`,{tokenId:i.tokenId,teamId:i.teamId});try{const o=await this.replayTransaction(i);t.push({success:!0,transaction:i,result:o})}catch(o){this.debug.error?.("Transaction replay failed",{tokenId:i.tokenId,error:o.message}),t.push({success:!1,transaction:i,error:o.message})}}const s=t.filter(a=>a.success).length,n=t.length-s;this.debug.log("Queue sync complete",{total:e.length,success:s,failed:n}),this.tempQueue=[],this.saveQueue()}catch(s){this.debug.error?.("Queue sync failed - keeping queue for retry",{error:s.message,queueSize:this.tempQueue.length})}finally{this.syncing=!1,this.dispatchEvent(new CustomEvent("queue:changed",{detail:this.getStatus()}))}}replayTransaction(e){return new Promise((t,s)=>{const n=`${e.tokenId}-${e.teamId}`,a=(r,d)=>{clearTimeout(r),this.client.removeEventListener("message:received",d),this.activeHandlers.delete(n)},i=setTimeout(()=>{const r=this.activeHandlers.get(n);r&&a(i,r),s(new Error(`Transaction replay timeout after 30s: ${e.tokenId}`))},3e4),o=r=>{const{type:d,payload:l}=r.detail;d==="transaction:result"&&l.tokenId===e.tokenId&&l.teamId===e.teamId&&(a(i,o),l.status==="error"?s(new Error(l.message||"Transaction failed")):t(l))};this.activeHandlers.set(n,o),this.client.addEventListener("message:received",o),this.client.send("transaction:submit",e),this.debug.log("Transaction submitted for replay",{tokenId:e.tokenId,teamId:e.teamId})})}saveQueue(){try{this.tempQueue.length>0?localStorage.setItem("networkedTempQueue",JSON.stringify(this.tempQueue)):localStorage.removeItem("networkedTempQueue")}catch(e){e.name==="QuotaExceededError"?(this.debug.error?.("localStorage quota exceeded - unable to save queue",{queueSize:this.tempQueue.length,error:e.message}),alert("Storage full: Unable to queue transactions offline. Please sync or clear data.")):this.debug.error?.("Failed to save queue to localStorage",e)}}loadQueue(){try{const e=localStorage.getItem("networkedTempQueue");e&&(this.tempQueue=JSON.parse(e),this.debug.log("Loaded queued transactions",{count:this.tempQueue.length}))}catch(e){this.debug.error?.("Failed to load queue",e),this.tempQueue=[]}}clearQueue(){this.tempQueue=[],localStorage.removeItem("networkedTempQueue"),this.debug.log("Queue cleared")}getStatus(){return{queuedCount:this.tempQueue.length,syncing:this.syncing}}destroy(){for(const[e,t]of this.activeHandlers.entries())this.client.removeEventListener("message:received",t);this.activeHandlers.clear(),this.client=null}}function p(c,e,t,s=5e3){return new Promise((n,a)=>{const i=setTimeout(()=>{c.removeEventListener("message:received",o),a(new Error(`${e} timeout after ${s}ms`))},s),o=r=>{const{type:d,payload:l}=r.detail;d==="gm:command:ack"&&(clearTimeout(i),c.removeEventListener("message:received",o),l.success?n(l):a(new Error(l.message||`Command failed: ${e}`)))};c.addEventListener("message:received",o),c.send("gm:command",{action:e,payload:t})})}class Le{constructor(e){this.connection=e,this.currentSession=null,this._messageHandler=this._handleMessage.bind(this),this.connection.addEventListener("message:received",this._messageHandler)}_handleMessage(e){const{type:t,payload:s}=e.detail;t==="session:update"&&(this.currentSession=s),t==="sync:full"&&s.session&&(this.currentSession=s.session)}async createSession(e,t=[]){return p(this.connection,"session:create",{name:e,teams:t})}async startGame(){if(this.currentSession)return p(this.connection,"session:start",{})}async pauseSession(){if(this.currentSession)return p(this.connection,"session:pause",{})}async resumeSession(){if(this.currentSession)return p(this.connection,"session:resume",{})}async endSession(){if(this.currentSession)return p(this.connection,"session:end",{})}getSession(){return this.currentSession}isActive(){return this.currentSession?.status==="active"}isPaused(){return this.currentSession?.status==="paused"}destroy(){this.connection&&this._messageHandler&&this.connection.removeEventListener("message:received",this._messageHandler)}}class Ae{constructor(e){this.connection=e,this.currentVideo=null,this.queueLength=0}async playVideo(){return p(this.connection,"video:play",{})}async pauseVideo(){return p(this.connection,"video:pause",{})}async stopVideo(){return p(this.connection,"video:stop",{})}async skipVideo(){return p(this.connection,"video:skip",{})}async addToQueue(e){return p(this.connection,"video:queue:add",{videoFile:e})}async reorderQueue(e,t){return p(this.connection,"video:queue:reorder",{fromIndex:e,toIndex:t})}async clearQueue(){return p(this.connection,"video:queue:clear",{})}destroy(){}}class xe{constructor(e){this.connection=e}async setIdleLoop(){return p(this.connection,"display:idle-loop",{})}async setScoreboard(){return p(this.connection,"display:scoreboard",{})}async toggleDisplayMode(){return p(this.connection,"display:toggle",{})}async getDisplayStatus(){return p(this.connection,"display:status",{})}destroy(){}}class Ne{constructor(e){this.connection=e,this.backendHealth=null,this.vlcHealth=null}async checkHealth(){try{const e=this.connection?.config?.url||"http://localhost:3000",t=await fetch(`${e}/health`);return this.backendHealth=t.ok?"healthy":"unhealthy",this.backendHealth}catch(e){throw this.backendHealth="error",e}}getBackendHealth(){return this.backendHealth}getVlcHealth(){return this.vlcHealth}setVlcHealth(e){this.vlcHealth=e}destroy(){}}class Be{constructor(e){this.connection=e,this._messageHandler=this._handleMessage.bind(this),this.connection.addEventListener("message:received",this._messageHandler)}_handleMessage(e){const{type:t}=e.detail;t==="scores:reset"&&h.log("[AdminOperations] Scores reset broadcast received")}async restartSystem(){return p(this.connection,"system:restart",{})}async clearData(){return p(this.connection,"system:clear",{})}async resetScores(){return p(this.connection,"score:reset",{})}async adjustScore(e,t,s="Admin adjustment"){return p(this.connection,"score:adjust",{teamId:e,delta:t,reason:s})}async deleteTransaction(e){return p(this.connection,"transaction:delete",{transactionId:e})}destroy(){this.connection&&this._messageHandler&&this.connection.removeEventListener("message:received",this._messageHandler)}}class Re{constructor(e={}){this.gridEl=e.quickFireGrid||document.getElementById("quick-fire-grid"),this.standingListEl=e.standingCuesList||document.getElementById("standing-cues-list"),this.activeListEl=e.activeCuesList||document.getElementById("active-cues-list")}render(e){!e||!e.cues||(this._renderQuickFireGrid(e.cues),this._renderStandingCuesList(e.cues,e.disabledCues),this._renderActiveCues(e.cues,e.activeCues))}_renderQuickFireGrid(e){if(!this.gridEl)return;const t=Array.from(e.values()).filter(s=>s.quickFire===!0);if(t.length===0){this.gridEl.innerHTML='<p class="empty-state">No Quick Fire cues available</p>';return}this.gridEl.innerHTML=t.map(s=>{const n=s.icon||"default",a=s.label||s.id;return`
        <button 
          class="cue-tile cue-tile--${n}" 
          data-action="admin.fireCue" 
          data-cue-id="${this._escapeHtml(s.id)}"
          title="${this._escapeHtml(a)}"
        >
          <span class="cue-tile__icon cue-icon--${n}"></span>
          <span class="cue-tile__label">${this._escapeHtml(a)}</span>
        </button>
      `}).join("")}_renderStandingCuesList(e,t){if(!this.standingListEl)return;const s=Array.from(e.values()).filter(n=>n.triggerType&&!n.quickFire);if(s.length===0){this.standingListEl.innerHTML='<p class="empty-state">No standing cues configured</p>';return}this.standingListEl.innerHTML=s.map(n=>{const a=t.has(n.id)||n.enabled===!1,i=a?"standing-cue-item--disabled":"standing-cue-item--enabled",o=n.triggerType==="clock"?"‚è± clock":"‚ö° event";return`
        <div class="standing-cue-item ${i}">
          <div class="standing-cue-item__info">
            <span class="standing-cue-item__label">${this._escapeHtml(n.label||n.id)}</span>
            <span class="standing-cue-item__trigger">${this._escapeHtml(o)}</span>
          </div>
          <div class="standing-cue-item__actions">
            ${a?`<button class="btn btn-sm btn-success" data-action="admin.enableCue" data-cue-id="${this._escapeHtml(n.id)}">Enable</button>`:`<button class="btn btn-sm btn-secondary" data-action="admin.disableCue" data-cue-id="${this._escapeHtml(n.id)}">Disable</button>`}
          </div>
        </div>
      `}).join("")}_renderActiveCues(e,t){if(!this.activeListEl)return;const s=t instanceof Map?Array.from(t.entries()):[];if(s.length===0){this.activeListEl.innerHTML='<p class="empty-state">No active cues</p>';return}this.activeListEl.innerHTML=s.map(([n,a])=>{const{state:i,progress:o,duration:r}=a||{state:"running",progress:0,duration:0},d=Math.round(o*100),l=i==="paused",u=e.get(n),g=u&&(u.label||u.name)||n;return`
        <div class="active-cue-item" data-cue-id="${this._escapeHtml(n)}">
          <div class="active-cue-item__header">
            <span class="active-cue-item__label">${this._escapeHtml(g)}</span>
            <span class="active-cue-item__state ${l?"state-paused":"state-running"}">
              ${l?"Paused":"Running"}
            </span>
          </div>
          <div class="active-cue-item__progress">
            <div class="progress-bar">
              <div class="progress-bar__fill" style="width: ${d}%"></div>
            </div>
            <span class="progress-bar__text">${d}%</span>
          </div>
          <div class="active-cue-item__actions">
            ${l?`<button class="btn btn-sm btn-primary" data-action="admin.resumeCue" data-cue-id="${this._escapeHtml(n)}">Resume</button>`:`<button class="btn btn-sm btn-secondary" data-action="admin.pauseCue" data-cue-id="${this._escapeHtml(n)}">Pause</button>`}
            <button class="btn btn-sm btn-danger" data-action="admin.stopCue" data-cue-id="${this._escapeHtml(n)}">Stop</button>
          </div>
        </div>
      `}).join("")}_escapeHtml(e){return e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}renderConflict(e){const{cueId:t,reason:s,currentVideo:n,autoCancelMs:a=1e4}=e;let i=document.getElementById("cue-conflict-container");if(!i){console.warn("[CueRenderer] No conflict container found");return}i.innerHTML=`
          <div class="cue-conflict-banner" data-cue-id="${this._escapeHtml(t)}">
            <div class="cue-conflict-banner__info">
              <span class="cue-conflict-banner__icon">‚ö†Ô∏è</span>
              <div class="cue-conflict-banner__text">
                <strong>Video Conflict</strong>
                <p>Cue wants to play video, but "${this._escapeHtml(n||"a video")}" is playing.</p>
              </div>
            </div>
            <div class="cue-conflict-banner__actions">
              <button class="btn btn-sm btn-warning" data-action="admin.resolveConflictCue" data-decision="override" data-cue-id="${this._escapeHtml(t)}">Override</button>
              <button class="btn btn-sm btn-secondary" data-action="admin.resolveConflictCue" data-decision="cancel" data-cue-id="${this._escapeHtml(t)}">Cancel</button>
            </div>
            <div class="cue-conflict-banner__timer" style="animation-duration: ${a}ms"></div>
          </div>
        `,setTimeout(()=>{const o=i.querySelector(`.cue-conflict-banner[data-cue-id="${t}"]`);o&&o.remove()},a)}}class Fe{constructor(){this.lightingSection=document.getElementById("lighting-section"),this.lightingNotConnected=document.getElementById("lighting-not-connected"),this.sceneGrid=document.getElementById("lighting-scenes"),this.audioRoutingContainer=document.getElementById("audio-routing-dropdowns"),this.btWarning=document.getElementById("bt-warning"),this.btDeviceList=document.getElementById("bt-device-list"),this.btSpeakerCount=document.getElementById("bt-speaker-count"),this.btScanBtn=document.getElementById("btn-bt-scan"),this.btScanStatus=document.getElementById("bt-scan-status"),this.STREAM_LABELS={video:"Video Audio",spotify:"Spotify Music",sound:"Sound Effects"}}render(e){e&&(e.lighting&&this.renderLighting(e.lighting),e.audio&&this.renderAudio(e.audio),e.bluetooth&&this.renderBluetooth(e.bluetooth))}renderLighting(e){if(!this.lightingSection)return;const{connected:t,activeScene:s,scenes:n}=e;if(this.lightingSection.style.display="",!t){this.lightingNotConnected&&(this.lightingNotConnected.style.display="block"),this.sceneGrid&&(this.sceneGrid.style.display="none");return}this.lightingNotConnected&&(this.lightingNotConnected.style.display="none"),this.sceneGrid&&(this.sceneGrid.style.display="grid",this.sceneGrid.innerHTML=n.map(a=>{const i=s&&a.id===s.id,o=this._escapeHtml(a.id),r=this._escapeHtml(a.name);return`
          <button class="scene-tile ${i?"scene-tile--active":""}"
                  data-scene-id="${o}"
                  data-action="admin.activateScene">
            ${r}
          </button>
        `}).join(""))}renderAudio(e){const{routes:t,availableSinks:s}=e;s&&s.length>0&&this.audioRoutingContainer&&(this.audioRoutingContainer.querySelectorAll("select").length===0||this._sinksChanged(s))&&(this._renderAudioDropdowns(s),this._lastKnownSinks=s),t&&Object.entries(t).forEach(([n,a])=>{const i=document.querySelector(`select[data-stream="${n}"]`);i&&(i.value=a,!i.value&&i.options.length>0&&(i.value=i.options[0].value))}),this.btWarning&&(this.btWarning.style.display="none")}_sinksChanged(e){return!this._lastKnownSinks||this._lastKnownSinks.length!==e.length?!0:!e.every((t,s)=>t.name===this._lastKnownSinks[s].name)}_renderAudioDropdowns(e){if(!this.audioRoutingContainer)return;const t=[{id:"video",label:this.STREAM_LABELS.video},{id:"spotify",label:this.STREAM_LABELS.spotify},{id:"sound",label:this.STREAM_LABELS.sound}];this.audioRoutingContainer.innerHTML=t.map(s=>`
            <div class="audio-control-item">
                <label>${s.label}</label>
                <select class="form-select" data-stream="${s.id}" data-action="admin.setAudioRoute">
                    ${e.map(n=>`
                        <option value="${n.name}">${n.label||n.description||n.name}</option>
                    `).join("")}
                </select>
            </div>
        `).join("")}renderBluetooth(e){const{scanning:t,foundedDevices:s=[],connectedDevices:n=[]}=e;if(this.btScanBtn&&(t?(this.btScanBtn.textContent="Stop Scan",this.btScanBtn.dataset.action="admin.stopBtScan"):(this.btScanBtn.textContent="Scan for Speakers",this.btScanBtn.dataset.action="admin.startBtScan")),this.btScanStatus&&(this.btScanStatus.style.display=t?"inline-block":"none"),this.btDeviceList){const a=[];n.forEach(i=>{a.push({...i,status:"connected"})}),e.pairedDevices&&e.pairedDevices.forEach(i=>{a.some(r=>r.address===i.address)||a.push({...i,status:"paired"})}),s.forEach(i=>{a.some(r=>r.address===i.address)||a.push({...i,status:"discovered"})}),a.length===0?this.btDeviceList.innerHTML='<p class="empty-state">No devices found</p>':this.btDeviceList.innerHTML=a.map(i=>this._renderDeviceItem(i)).join(""),this.btSpeakerCount&&(this.btSpeakerCount.textContent=a.length>0?String(a.length):"")}}_renderDeviceItem(e){const t=this._escapeHtml(e.name||e.address),s=this._escapeHtml(e.address),n=e.status==="connected",a=e.status==="paired"||n;let i="bt-device-item";n?i+=" bt-device-item--connected":a&&(i+=" bt-device-item--paired");let o="";return n?o=`
                <span class="bt-device-status status-connected">Connected</span>
                <button class="btn btn-xs btn-outline-danger"
                        data-action="admin.disconnectBtDevice"
                        data-bt-address="${s}">
                    Disconnect
                </button>
            `:a?o=`
                <button class="btn btn-xs btn-primary" 
                        data-action="admin.connectBtDevice" 
                        data-bt-address="${s}">
                    Connect
                </button>
            `:o=`
                <button class="btn btn-xs btn-outline" 
                        data-action="admin.pairBtDevice" 
                        data-bt-address="${s}">
                    Pair
                </button>
            `,`
      <div class="${i}" data-bt-address="${s}">
        <div class="bt-device-info">
            <span class="bt-device-name">${t}</span>
            <span class="bt-device-mac">${s}</span>
        </div>
        <div class="bt-device-actions">
            ${o}
        </div>
      </div>
    `}_escapeHtml(e){return e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}}class He{constructor(){this.container=document.getElementById("session-status-container"),this.lastStatus=null}render(e){if(!this.container)return;let t="no-session";e&&(t=e.status||"setup"),this.lastStatus!==t&&(this.container.innerHTML=this._getTemplate(t,e),this.lastStatus=t);const s=document.getElementById("session-name"),n=document.getElementById("session-status-badge");e&&(s&&(s.textContent=e.name||"Untitled Session"),n&&(e.status==="active"?(n.textContent="Active",n.className="badge badge-success"):e.status==="paused"?(n.textContent="Paused",n.className="badge badge-warning"):e.status==="ended"?(n.textContent="Ended",n.className="badge badge-danger"):(n.textContent=e.status||"Offline",n.className="badge")))}renderGameClock(e){const t=document.getElementById("game-clock-display");if(!t)return;const{state:s,elapsed:n}=e,a=this._formatClockTime(n);t.textContent=a,t.classList.remove("clock-running","clock-paused","clock-stopped"),t.classList.add(`clock-${s}`)}renderOvertime(e){const t=document.getElementById("session-overtime-container"),s=document.getElementById("session-overtime-text");!t||!s||(e&&e.overtimeDuration>0?(t.style.display="block",s.textContent=`+${Math.round(e.overtimeDuration)}m`):t.style.display="none")}_formatClockTime(e){if(e==null)return"--:--";const t=Math.floor(e/60),s=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}_getTemplate(e,t){const s=t?.name||"New Session";return e==="no-session"?`
                <div class="session-status session-status--empty">
                    <div class="session-info">
                        <h4>No Active Session</h4>
                        <p>Create a session to start tracking games.</p>
                    </div>
                    <div class="session-controls">
                        <button class="btn btn-primary" data-action="app.adminCreateSession">
                            Create New Session
                        </button>
                    </div>
                </div>
            `:e==="setup"?`
                <div class="session-status session-status--setup">
                    <div class="session-header">
                        <h4 id="session-name">${s}</h4>
                        <span id="session-status-badge" class="badge">Setup</span>
                    </div>
                    <div class="session-body">
                         <div id="game-clock-container" class="clock-container">
                            <span id="game-clock-display" class="clock-display">00:00</span>
                        </div>
                    </div>
                    <div class="session-controls">
                        <button class="btn btn-success" data-action="admin.startGame">Start Game</button>
                        <button class="btn btn-danger" data-action="app.adminEndSession">End Session</button>
                    </div>
                </div>
            `:e==="active"?`
                <div class="session-status session-status--active">
                    <div class="session-header">
                        <h4 id="session-name">${s}</h4>
                        <span id="session-status-badge" class="badge badge-success">Active</span>
                    </div>
                    <div class="session-body">
                        <div id="game-clock-container" class="clock-container">
                            <span id="game-clock-display" class="clock-display">--:--</span>
                        </div>
                        <div id="session-overtime-container" style="display:none; color: #ffc107; font-weight: bold; margin-top: 5px;">
                            Overtime: <span id="session-overtime-text"></span>
                        </div>
                    </div>
                    <div class="session-controls">
                        <button class="btn btn-warning" data-action="app.adminPauseSession">Pause</button>
                        <button class="btn btn-danger" data-action="app.adminEndSession">End Session</button>
                    </div>
                </div>
            `:e==="paused"?`
                <div class="session-status session-status--paused">
                    <div class="session-header">
                        <h4 id="session-name">${s}</h4>
                        <span id="session-status-badge" class="badge badge-warning">Paused</span>
                    </div>
                    <div class="session-body">
                         <div id="game-clock-container" class="clock-container">
                            <span id="game-clock-display" class="clock-display">--:--</span>
                        </div>
                    </div>
                    <div class="session-controls">
                        <button class="btn btn-success" data-action="app.adminResumeSession">Resume</button>
                        <button class="btn btn-danger" data-action="app.adminEndSession">End Session</button>
                    </div>
                </div>
            `:e==="ended"?`
                <div class="session-status session-status--ended">
                     <div class="session-header">
                        <h4 id="session-name">${s}</h4>
                        <span id="session-status-badge" class="badge badge-danger">Ended</span>
                    </div>
                     <div class="session-body">
                        <p>Session completed.</p>
                     </div>
                    <div class="session-controls">
                        <button class="btn btn-secondary" data-action="app.downloadSessionReport">
                            Download Report
                        </button>
                        <button class="btn btn-primary" data-action="app.adminResetAndCreateNew">
                            Reset & New Session
                        </button>
                    </div>
                </div>
            `:`<div>Unknown State: ${e}</div>`}}class K{constructor(){this.container=document.getElementById("video-control-panel"),this.nowPlayingEl=document.getElementById("now-showing-value"),this.nowPlayingIcon=document.getElementById("now-showing-icon"),this.statusBadge=document.getElementById("video-status-badge"),this.progressContainer=document.getElementById("video-progress-container"),this.progressBar=document.getElementById("video-progress-fill"),this.queueContainer=document.getElementById("video-queue-list")}render(e){if(!this.nowPlayingEl)return;const{nowPlaying:t,isPlaying:s,progress:n}=e;if(t?(this.nowPlayingEl.textContent=t,this.nowPlayingIcon&&(this.nowPlayingIcon.textContent=s?"‚ñ∂Ô∏è":"‚è∏Ô∏è")):(this.nowPlayingEl.textContent="Idle Loop",this.nowPlayingIcon&&(this.nowPlayingIcon.textContent="üîÑ")),this.statusBadge&&(s?(this.statusBadge.textContent="Playing",this.statusBadge.className="badge badge-success"):(this.statusBadge.textContent="Idle",this.statusBadge.className="badge")),this.progressContainer&&this.progressBar)if(s){this.progressContainer.style.display="block";const a=Math.min(100,Math.max(0,n*100));this.progressBar.style.width=`${a}%`}else this.progressContainer.style.display="none",this.progressBar.style.width="0%"}renderQueue(e){if(this.queueContainer){if(!e||e.length===0){this.queueContainer.innerHTML='<div class="empty-state">Queue empty</div>',this._updateQueueCount(0);return}this.queueContainer.innerHTML=e.map(t=>`
            <div class="queue-item">
                <span class="queue-item__token">${t.tokenId}</span>
                <span class="queue-item__duration">${Math.round(t.duration||0)}s</span>
            </div>
        `).join(""),this._updateQueueCount(e.length)}}_updateQueueCount(e){const t=document.getElementById("queue-count"),s=document.getElementById("pending-queue-count");t&&(t.textContent=e),s&&(s.textContent=e)}}class Ge{constructor(e,t,s=null){this.client=e,this.dataManager=t,this.teamRegistry=s,this.devices=[],this._currentIdleMode="IDLE_LOOP",this.cueRenderer=new Re,this.envRenderer=new Fe,this.sessionRenderer=new He,this.videoRenderer=new K,this._messageHandler=this._handleMessage.bind(this),this.client.addEventListener("message:received",this._messageHandler),this._wireDataManagerEvents(),this._requestInitialState()}_wireDataManagerEvents(){this.dataManager.addEventListener("cue-state:updated",e=>this.cueRenderer.render(e.detail)),this.dataManager.addEventListener("cue:conflict",e=>this.cueRenderer.renderConflict(e.detail)),this.dataManager.addEventListener("lighting-state:updated",e=>this.envRenderer.renderLighting(e.detail.lighting)),this.dataManager.addEventListener("audio-state:updated",e=>this.envRenderer.renderAudio(e.detail.audio)),this.dataManager.addEventListener("bluetooth-state:updated",e=>this.envRenderer.renderBluetooth(e.detail.bluetooth)),this.dataManager.addEventListener("session-state:updated",e=>{this.sessionRenderer.render(e.detail.session),this.teamRegistry&&this.teamRegistry.populateFromSession(e.detail.session)})}_requestInitialState(){this.client?.socket?.connected&&(this.client.socket.emit("sync:request"),console.log("[MonitoringDisplay] Requested initial state via sync:request"))}_sendMessage(e,t){this.client?.socket?.connected&&this.client.socket.emit(e,t)}_handleMessage(e){const{type:t,payload:s}=e.detail;switch(h.log(`[MonitoringDisplay] _handleMessage: ${t}`),t){case"session:update":case"session:overtime":t==="session:overtime"&&this.sessionRenderer.renderOvertime(s);break;case"sync:full":this.updateAllDisplays(s);break;case"gameclock:status":this.sessionRenderer.renderGameClock(s);break;case"device:connected":case"device:disconnected":this._updateDeviceList(s,t);break;case"cue:fired":this.showToast(`Cue fired: ${s.cueId}`,"info",3e3);break;case"cue:error":this.showToast(`Cue error: ${s.cueId} ‚Äî ${s.error||s.action}`,"error",5e3);break;case"cue:conflict":this.showToast(`Cue conflict: ${s.cueId} ‚Äî ${s.reason||"Video conflict"}`,"warning",1e4);break;case"sound:status":break;case"transaction:new":case"transaction:deleted":this._updateTransactionLog(s,t);break;case"display:mode":this._handleDisplayMode(s);break;case"video:status":this._handleVideoStatus(s);break;case"audio:routing:fallback":this._handleAudioFallback(s);break;case"video:queue:update":this.updateQueueDisplay(s);break;case"spotify:status":this._renderNowPlaying(s);break}}_updateDeviceList(e,t){t==="device:connected"?this.devices.findIndex(n=>n.deviceId===e.deviceId)===-1&&this.devices.push(e):this.devices=this.devices.filter(s=>s.deviceId!==e.deviceId),this._renderDeviceList()}_updateTransactionLog(e,t){const s=e.transaction||(t==="transaction:deleted"?e:null);if(!s)return;const n=document.getElementById("admin-transaction-log");if(!n)return;if(t==="transaction:deleted"){const o=n.querySelector(`[data-transaction-id="${e.transactionId}"]`);o&&o.remove();return}const a=s.timestamp?new Date(s.timestamp).toLocaleTimeString():"-",i=`
        <div class="transaction-item" data-transaction-id="${s.id}">
            <span class="tx-time">${a}</span>
            <span class="tx-team">${s.teamId}</span>
            <span class="tx-token">${s.tokenId}</span>
            <span class="tx-type">${s.memoryType||"UNKNOWN"}</span>
        </div>`;for(n.insertAdjacentHTML("afterbegin",i);n.children.length>10;)n.lastElementChild.remove()}_handleDisplayMode(e){this._currentIdleMode=e.mode;const t=document.getElementById("now-showing-value"),s=document.getElementById("now-showing-icon"),n=document.getElementById("btn-idle-loop"),a=document.getElementById("btn-scoreboard");e.mode==="SCOREBOARD"?(t&&(t.textContent="Scoreboard"),s&&(s.textContent="üèÜ")):(t&&(t.textContent="Idle Loop"),s&&(s.textContent="üîÑ")),n&&n.classList.toggle("active",e.mode==="IDLE_LOOP"),a&&a.classList.toggle("active",e.mode==="SCOREBOARD")}_handleVideoStatus(e){const t=document.getElementById("now-showing-value"),s=document.getElementById("now-showing-icon"),n=document.getElementById("returns-to-container"),a=document.getElementById("returns-to-mode"),i=document.getElementById("pending-queue-count");if(e.status==="playing"&&e.tokenId)t&&(t.textContent=`${e.tokenId}.mp4`),s&&(s.textContent="‚ñ∂Ô∏è"),n&&(n.style.display="block"),a&&(a.textContent=this._currentIdleMode==="SCOREBOARD"?"Scoreboard":"Idle Loop");else{const o=this._currentIdleMode||"IDLE_LOOP";t&&(t.textContent=o==="SCOREBOARD"?"Scoreboard":"Idle Loop"),s&&(s.textContent=o==="SCOREBOARD"?"üèÜ":"üîÑ"),n&&(n.style.display="none")}i&&e.queueLength!==void 0&&(i.textContent=String(e.queueLength))}_handleAudioFallback(e){if(!e)return;const t=document.getElementById("bt-warning");if(t&&(t.style.display="block",t.textContent=e.reason||"Audio route fallback"),e.stream&&e.sink){const s=document.querySelector(`select[data-stream="${e.stream}"]`);s&&(s.value=e.sink)}}updateQueueDisplay(e){this.videoRenderer&&this.videoRenderer.renderQueue(e.items||[])}_renderNowPlaying(e){const t=document.getElementById("now-playing-section");if(!t)return;if(!e||!e.connected){t.innerHTML='<div class="now-playing--disconnected">Spotify Disconnected</div>';return}const n=e.state==="playing"?'<button class="btn btn-sm btn-icon" data-action="admin.spotifyPause" title="Pause">&#10074;&#10074;</button>':'<button class="btn btn-sm btn-icon" data-action="admin.spotifyPlay" title="Play">&#9654;</button>';t.innerHTML=`
        <div class="now-playing--connected">
            <div class="now-playing__track">
                <strong>${e.track?.title||""}</strong>
                <span>${e.track?.artist||""}</span>
            </div>
            <div class="now-playing__controls">
                <button class="btn btn-sm btn-icon" data-action="admin.spotifyPrevious" title="Previous">&#9664;&#9664;</button>
                ${n}
                <button class="btn btn-sm btn-icon" data-action="admin.spotifyNext" title="Next">&#9654;&#9654;</button>
            </div>
        </div>`}loadAvailableVideos(){}updateAllDisplays(e){if(e){if(h.log("[MonitoringDisplay] updateAllDisplays (Sync Full)",e),this.sessionRenderer.render(e.session||null),e.session&&this.teamRegistry&&this.teamRegistry.populateFromSession(e.session),e.cueEngine&&e.cueEngine.loaded&&this.cueRenderer.render({cues:new Map((e.cueEngine.cues||[]).map(t=>[t.id,t])),activeCues:new Map((e.cueEngine.activeCues||[]).map(t=>[t.cueId,t])),disabledCues:new Set(e.cueEngine.disabledCues||[])}),e.gameClock&&this.sessionRenderer.renderGameClock({state:e.gameClock.status,elapsed:e.gameClock.elapsed}),e.spotify&&this._renderNowPlaying(e.spotify),this.updateSystemDisplay(),e.systemStatus?.vlc){const t=document.getElementById("vlc-status");t&&(t.className=`status-dot status-dot--${e.systemStatus.vlc}`)}if(e.recentTransactions){const t=document.getElementById("admin-transaction-log");t&&(t.innerHTML=""),e.recentTransactions.slice(-10).reverse().forEach(s=>this._updateTransactionLog({transaction:s},"transaction:new"))}e.devices&&this._setDeviceList(e.devices)}}_setDeviceList(e){e&&(this.devices=[...e],this._renderDeviceList())}_renderDeviceList(){const e=document.getElementById("device-count"),t=document.getElementById("device-list");e&&(e.textContent=String(this.devices.length)),t&&(this.devices.length===0?t.innerHTML='<p class="text-muted text-sm">No devices</p>':t.innerHTML=this.devices.map(s=>`
            <div class="device-item"><span>${s.deviceId}</span><span class="device-type">${s.type}</span></div>
         `).join(""))}refreshAllDisplays(){h.log("[MonitoringDisplay] refreshAllDisplays called"),this.updateSystemDisplay(),this.loadAvailableVideos(),this._requestInitialState()}resume(){console.log("[MonitoringDisplay] Resuming monitoring..."),this._requestInitialState()}updateSystemDisplay(){if(!this.client)return;const e=document.getElementById("orchestrator-status");if(e){const t=this.client.isConnected?"connected":"disconnected";e.className=`status-dot status-dot--${t}`,e.title=t}}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}formatClockTime(e){if(e==null||e<0)return"00:00:00";const t=Math.floor(e),s=String(Math.floor(t/3600)).padStart(2,"0"),n=String(Math.floor(t%3600/60)).padStart(2,"0"),a=String(t%60).padStart(2,"0");return`${s}:${n}:${a}`}showToast(e,t="info",s=3e3){const n={error:"var(--color-accent-danger, #dc3545)",success:"var(--color-accent-success, #28a745)",warning:"var(--color-accent-warning, #ffc107)",info:"var(--color-accent-info, #007bff)"},a=document.createElement("div");a.className=`toast toast-${t}`,a.textContent=e,a.style.cssText=`
        position: fixed; top: 20px; right: 20px; padding: 12px 20px;
        background: ${n[t]||n.info}; color: white;
        border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;
      `,document.body.appendChild(a),setTimeout(()=>a.remove(),s)}destroy(){this.client&&this._messageHandler&&this.client.removeEventListener("message:received",this._messageHandler)}}class Pe{constructor(e){this.connection=e}async startScan(e){return p(this.connection,"bluetooth:scan:start",e?{timeout:e}:{})}async stopScan(){return p(this.connection,"bluetooth:scan:stop",{})}async pairDevice(e){return p(this.connection,"bluetooth:pair",{address:e},45e3)}async unpairDevice(e){return p(this.connection,"bluetooth:unpair",{address:e},15e3)}async connectDevice(e){return p(this.connection,"bluetooth:connect",{address:e},3e4)}async disconnectDevice(e){return p(this.connection,"bluetooth:disconnect",{address:e},15e3)}destroy(){}}class ze{constructor(e){this.connection=e}async setVideoOutput(e,t="video"){return p(this.connection,"audio:route:set",{stream:t,sink:e})}destroy(){}}class Oe{constructor(e){this.connection=e}async activateScene(e){return p(this.connection,"lighting:scene:activate",{sceneId:e})}async refreshScenes(){return p(this.connection,"lighting:scenes:refresh",{})}destroy(){}}class Ve{constructor(e){this.connection=e}async fireCue(e,t=5e3){return p(this.connection,"cue:fire",{cueId:e},t)}async enableCue(e,t=5e3){return p(this.connection,"cue:enable",{cueId:e},t)}async disableCue(e,t=5e3){return p(this.connection,"cue:disable",{cueId:e},t)}async pauseCue(e,t=5e3){return p(this.connection,"cue:pause",{cueId:e},t)}async stopCue(e,t=5e3){return p(this.connection,"cue:stop",{cueId:e},t)}async resumeCue(e,t=5e3){return p(this.connection,"cue:resume",{cueId:e},t)}async resolveConflict(e,t,s=5e3){return p(this.connection,"cue:conflict:resolve",{cueId:e,decision:t},s)}destroy(){}}class qe{constructor(e){this.connection=e}async playSound(e,t=null,s=null,n=5e3){const a={file:e};return t!==null&&(a.target=t),s!==null&&(a.volume=s),p(this.connection,"sound:play",a,n)}async stopSound(e=null,t=5e3){const s=e!==null?{file:e}:{};return p(this.connection,"sound:stop",s,t)}destroy(){}}class Ue{constructor(e){this.connection=e}async play(e=5e3){return p(this.connection,"spotify:play",{},e)}async pause(e=5e3){return p(this.connection,"spotify:pause",{},e)}async stop(e=5e3){return p(this.connection,"spotify:stop",{},e)}async next(e=5e3){return p(this.connection,"spotify:next",{},e)}async previous(e=5e3){return p(this.connection,"spotify:previous",{},e)}async setPlaylist(e,t=5e3){return p(this.connection,"spotify:playlist",{uri:e},t)}async setVolume(e,t=5e3){return p(this.connection,"spotify:volume",{volume:e},t)}async verifyCacheStatus(e=1e4){return p(this.connection,"spotify:cache:verify",{},e)}destroy(){}}class je extends EventTarget{constructor(e,t,s=null){super(),this.client=e,this.dataManager=t,this.teamRegistry=s,this.modules=null,this.initialized=!1}initialize(){if(this.initialized){console.warn("AdminController: Already initialized");return}this.modules={sessionManager:new Le(this.client),videoController:new Ae(this.client),displayController:new xe(this.client),systemMonitor:new Ne(this.client),adminOperations:new Be(this.client),monitoringDisplay:new Ge(this.client,this.dataManager,this.teamRegistry),bluetoothController:new Pe(this.client),audioController:new ze(this.client),lightingController:new Oe(this.client),cueController:new Ve(this.client),soundController:new qe(this.client),spotifyController:new Ue(this.client)},this.initialized=!0,this.dispatchEvent(new CustomEvent("initialized"))}getModule(e){if(!this.initialized)throw new Error("Admin modules not initialized");if(!this.modules[e])throw new Error(`Unknown module: ${e}`);return this.modules[e]}pause(){this.modules&&(this.modules.sessionManager?.pause&&this.modules.sessionManager.pause(),this.modules.videoController?.pause&&this.modules.videoController.pause())}resume(){this.modules&&(this.modules.sessionManager?.resume&&this.modules.sessionManager.resume(),this.modules.videoController?.resume&&this.modules.videoController.resume(),this.modules.monitoringDisplay?.resume&&this.modules.monitoringDisplay.resume())}destroy(){this.modules&&(Object.values(this.modules).forEach(e=>{e?.destroy&&e.destroy()}),this.modules=null,this.initialized=!1)}}class Qe extends EventTarget{constructor(e,t,s=null){super(),this.config=e,this.dataManager=t,this.teamRegistry=s,this.services=null,this.state="disconnected"}async initialize(){if(this.services)throw new Error("Session already initialized");try{this._createServices(),this._wireEventHandlers(),await this._initiateConnection(),this.state="connected",this.dispatchEvent(new CustomEvent("session:ready",{detail:{services:this.services}}))}catch(e){throw this.state="error",await this.destroy(),this.dispatchEvent(new CustomEvent("session:error",{detail:{error:e}})),e}}getService(e){if(!this.services)throw new Error("Session not initialized");if(!this.services[e])throw new Error(`Unknown service: ${e}`);return this.services[e]}async destroy(){this.services&&(this.services.adminController&&this.services.adminController.destroy(),this.services.queueManager&&this.services.queueManager.destroy(),this.services.connectionManager&&(this._connectedHandler&&this.services.connectionManager.removeEventListener("connected",this._connectedHandler),this._disconnectedHandler&&this.services.connectionManager.removeEventListener("disconnected",this._disconnectedHandler),this._authRequiredHandler&&this.services.connectionManager.removeEventListener("auth:required",this._authRequiredHandler),await this.services.connectionManager.disconnect()),this.services.client&&(this._messageHandler&&this.services.client.removeEventListener("message:received",this._messageHandler),this.services.client.destroy()),this.services=null,this.state="disconnected")}_createServices(){this.services={},this.services.client=new _e({url:this.config.url,deviceId:this.config.deviceId}),this.services.connectionManager=new $e({url:this.config.url,deviceId:this.config.deviceId,token:this.config.token,client:this.services.client}),this.services.queueManager=new De({client:this.services.client,deviceId:this.config.deviceId,debug:console}),this.services.adminController=new je(this.services.client,this.dataManager,this.teamRegistry)}_wireEventHandlers(){this._connectedHandler=()=>{this.services.adminController&&this.services.adminController.initialize(),this.services.queueManager&&this.services.queueManager.syncQueue()},this._disconnectedHandler=()=>{this.services.adminController&&this.services.adminController.pause()},this._authRequiredHandler=()=>{this.dispatchEvent(new CustomEvent("auth:required"))},this._messageHandler=e=>{const{type:t,payload:s}=e.detail;switch(t){case"score:updated":this.dataManager.updateTeamScoreFromBackend(s);break;case"sync:full":this._handleSessionBoundary(s.session?.id),s.deviceScannedTokens&&this.dataManager.setScannedTokensFromServer(s.deviceScannedTokens),s.scores&&s.scores.forEach(n=>this.dataManager.updateTeamScoreFromBackend(n)),s.recentTransactions&&s.recentTransactions.forEach(n=>this.dataManager.addTransaction(n)),s.playerScans&&this.dataManager.setPlayerScansFromServer(s.playerScans),s.session?this.dataManager.updateSessionState(s.session):"session"in s&&s.session===null&&this.dataManager.updateSessionState(null),s.environment&&(s.environment.audio&&this.dataManager.updateAudioState(s.environment.audio),s.environment.lighting&&this.dataManager.updateLightingState(s.environment.lighting),s.environment.bluetooth&&this.dataManager.updateBluetoothState(s.environment.bluetooth));break;case"session:update":s.status==="ended"?this.dataManager.resetForNewSession(null):this._handleSessionBoundary(s.id),this.dataManager.updateSessionState(s);break;case"transaction:new":s.transaction&&this.dataManager.addTransactionFromBroadcast(s.transaction);break;case"transaction:deleted":s.transactionId&&this.dataManager.removeTransaction(s.transactionId);break;case"scores:reset":this.dataManager.clearBackendScores();break;case"player:scan":this.dataManager.handlePlayerScan(s);break;case"group:completed":this.dispatchEvent(new CustomEvent("group:completed",{detail:s}));break;case"video:status":case"video:progress":this.dataManager.updateVideoState(s);break;case"cue:fired":this.dataManager.updateCueStatus({cueId:s.cueId,state:"running"});break;case"cue:completed":this.dataManager.updateCueStatus({cueId:s.cueId,state:"completed"});break;case"cue:error":this.dataManager.updateCueStatus({cueId:s.cueId,state:"error"});break;case"cue:status":this.dataManager.updateCueStatus(s);break;case"cue:conflict":this.dataManager.handleCueConflict(s);break;case"lighting:scene":case"lighting:status":this.dataManager.updateLightingState(s);break;case"audio:routing":this.dataManager.updateAudioState(s);break;case"audio:routing:fallback":this.dataManager.updateAudioState(s);break;case"audio:ducking:status":this.dataManager.updateAudioDucking(s);break;case"audio:sinks":s.availableSinks&&this.dataManager.updateAudioState({availableSinks:s.availableSinks});break;case"bluetooth:scan":this.dataManager.updateBluetoothScan(s);break;case"bluetooth:device":this.dataManager.updateBluetoothDevice(s);break;case"sound:status":this.dispatchEvent(new CustomEvent("sound:status",{detail:s}));break}},this.services.connectionManager.addEventListener("connected",this._connectedHandler),this.services.connectionManager.addEventListener("disconnected",this._disconnectedHandler),this.services.connectionManager.addEventListener("auth:required",this._authRequiredHandler),this.services.client.addEventListener("message:received",this._messageHandler)}_handleSessionBoundary(e){const t=this.dataManager.currentSessionId;e&&e!==t&&this.dataManager.resetForNewSession(e)}async _initiateConnection(){await this.services.connectionManager.connect()}}class J{constructor(e={}){this.debug=e.debug||h,this.uiManager=e.uiManager||q,this.settings=e.settings||x,this.tokenManager=e.tokenManager||H,this.dataManager=e.dataManager,this.teamRegistry=e.teamRegistry||null,this.nfcHandler=e.nfcHandler||Q,this.config=e.config||F,this.initializationSteps=e.initializationSteps||W,this.sessionModeManager=e.sessionModeManager||null,this.networkedSession=e.networkedSession||null,this.showConnectionWizard=e.showConnectionWizard||(typeof window<"u"?window.showConnectionWizard:null),this.currentTeamId="",this.nfcSupported=!1,this.currentInterventionTeamId=null,this.viewController=this._createViewController()}async init(){this.debug.log("App initializing..."),this.initializationSteps.initializeUIManager(this.uiManager),await this.initializationSteps.showLoadingScreen(this.uiManager),this.sessionModeManager=this.initializationSteps.createSessionModeManager(Ee),this.uiManager.sessionModeManager=this.sessionModeManager,this.uiManager.app=this,this.initializationSteps.initializeViewController(this.viewController),this.initializationSteps.loadSettings(this.settings),this.initializationSteps.loadDataManager(this.dataManager,this.uiManager),this.nfcSupported=await this.initializationSteps.detectNFCSupport(this.nfcHandler),await this.initializationSteps.loadTokenDatabase(this.tokenManager,this.uiManager),this.initializationSteps.applyURLModeOverride(window.location.search,this.settings),await this.initializationSteps.registerServiceWorker(navigator,this.uiManager);const e=await this.initializationSteps.validateAndDetermineInitialScreen(this.sessionModeManager);e.validationResult&&(e.validationResult.valid?this.debug.log("[App] State validation passed - proceeding with auto-connect"):this.debug.log(`[App] State validation failed: ${e.validationResult.reason}`)),await this.initializationSteps.applyInitialScreenDecision(e,this.sessionModeManager,this.uiManager,this.showConnectionWizard,this._initializeNetworkedMode.bind(this))}_wireNetworkedSessionEvents(){if(!this.networkedSession){this.debug.log("Cannot wire networked session events: session is null");return}this.networkedSession.addEventListener("session:ready",()=>{this.debug.log("NetworkedSession ready - initializing admin modules"),this.viewController&&this.viewController.initAdminModules()}),this.networkedSession.addEventListener("auth:required",()=>{this.debug.log("Authentication required - showing connection wizard"),this.showConnectionWizard&&this.showConnectionWizard()}),this.networkedSession.addEventListener("group:completed",e=>{const{teamId:t,bonus:s}=e.detail||{},n=s?` +$${s.toLocaleString()}`:"";this.uiManager.showToast(`Group completed by ${t||"team"}${n}`)})}_createViewController(){const e=this;return{currentView:"scanner",views:["scanner","admin","debug"],adminInstances:null,init(){const t=document.getElementById("viewSelector");t&&(t.style.display="flex")},switchView(t){if(!this.views.includes(t)){console.error("Invalid view:",t),e.uiManager.showError(`Invalid view: ${t}`);return}document.querySelectorAll(".view-content").forEach(a=>{a.style.display="none"});const s=document.getElementById(`${t}-view`);s&&(s.style.display="block"),document.querySelectorAll(".view-tab").forEach(a=>{a.classList.remove("active")});const n=document.querySelector(`[data-view="${t}"]`);n&&n.classList.add("active"),this.currentView=t,t==="admin"&&(this.adminInstances||this.initAdminModules(),e.updateAdminPanel())},initAdminModules(){if(!e.sessionModeManager?.isNetworked()){console.log("Admin modules only available in networked mode");return}if(!e.networkedSession){console.error("NetworkedSession not initialized"),e.uiManager.showError("Network session not available. Check connection.");return}const t=e.networkedSession.getService("adminController");t.initialized||(console.log("Initializing admin modules..."),t.initialize()),this.adminInstances={sessionManager:t.getModule("sessionManager"),videoController:t.getModule("videoController"),displayController:t.getModule("displayController"),systemMonitor:t.getModule("systemMonitor"),adminOps:t.getModule("adminOperations"),monitoring:t.getModule("monitoringDisplay")},console.log("Admin modules referenced from AdminController")}}}toggleMode(){this.settings.mode=this.settings.mode==="detective"?"blackmarket":"detective",this.uiManager.updateModeDisplay(this.settings.mode);const e=document.getElementById("scanScreen");e&&e.classList.contains("active")&&this.uiManager.updateSessionStats();const t=document.getElementById("modeIndicator");t&&(t.style.transform=`scale(${this.config.MODE_TOGGLE_SCALE})`,setTimeout(()=>{t.style.transform="scale(1)"},this.config.ANIMATION_DURATION))}initTeamEntryUI(){const e=document.getElementById("teamNameInput"),t=document.getElementById("teamList"),s=document.getElementById("teamListLabel");s&&this.teamRegistry&&(s.textContent=this.teamRegistry.getTeamListLabel()),this.teamRegistry&&t&&this._renderTeamList(t),e&&(e.value="",e.focus()),this.teamRegistry&&!this._teamsListenerAdded&&(this._teamsListenerAdded=!0,this.teamRegistry.addEventListener("teams:updated",()=>{const n=document.getElementById("teamList");n&&this._renderTeamList(n)}))}_renderTeamList(e){e.innerHTML="",this.teamRegistry.getTeamsForDisplay().forEach(s=>{const n=document.createElement("div");n.className="team-list-item",n.textContent=s,n.setAttribute("role","option"),n.addEventListener("click",()=>{document.getElementById("teamNameInput").value=s,this.confirmTeamId()}),e.appendChild(n)})}async confirmTeamId(){const t=document.getElementById("teamNameInput")?.value?.trim();if(!t){this.uiManager.showError("Please enter a team name");return}const s=await this.teamRegistry.selectTeam(t);if(!s.success){this.uiManager.showError(s.error||"Failed to select team");return}this.currentTeamId=t;const n=document.getElementById("currentTeam");n&&(n.textContent=t),this.uiManager.updateSessionStats(),this.uiManager.showScreen("scan"),await this._startNFCScanning()}async selectGameMode(e){if(!this.sessionModeManager){console.error("SessionModeManager not initialized"),this.uiManager.showError("System error: SessionModeManager not initialized. Please reload the page.");return}try{if(e==="networked"){const t=localStorage.getItem("aln_auth_token");if(!t||!this._isTokenValid(t)){this.debug.log("Networked mode selected - showing connection wizard (mode not locked yet)"),this.showConnectionWizard?this.showConnectionWizard():this.uiManager.showError("Connection wizard not available");return}this.sessionModeManager.setMode(e),this.debug.log(`Game mode locked: ${e}`),await this._initializeNetworkedMode()}else if(e==="standalone"){this.sessionModeManager.setMode(e),this.debug.log(`Game mode locked: ${e}`),document.body.classList.add("standalone-mode"),document.body.classList.remove("networked-mode"),localStorage.removeItem("standaloneSession"),this.dataManager.sessionModeManager=this.sessionModeManager,await this.dataManager.initializeStandaloneMode(),this.debug.log("UnifiedDataManager initialized for standalone mode"),this.viewController.init();const t=document.getElementById("session-status-container");t&&this.uiManager.renderSessionStatus(t),this.teamRegistry&&(this.teamRegistry.sessionModeManager=this.sessionModeManager),this.initTeamEntryUI(),this.uiManager.showScreen("teamEntry")}}catch(t){throw console.error("Failed to set game mode:",t),this.uiManager.showError(`Failed to set game mode: ${t.message}`),t}}async _initializeNetworkedMode(){document.body.classList.add("networked-mode"),document.body.classList.remove("standalone-mode");const e=localStorage.getItem("aln_orchestrator_url")||"https://localhost:3000",t=this.settings?.deviceId||"GM_STATION_UNKNOWN",s=localStorage.getItem("aln_auth_token");if(s&&this._isTokenValid(s)){this.debug.log("Valid token found - creating NetworkedSession..."),this.uiManager.showToast("Reconnecting to orchestrator...","info",3e3),this.networkedSession=new Qe({url:e,deviceId:t,stationName:this.settings?.stationName||"GM Station",token:s},this.dataManager,this.teamRegistry);try{this._wireNetworkedSessionEvents(),this.dataManager.sessionModeManager=this.sessionModeManager,await this.dataManager.initializeNetworkedMode(null),this.debug.log("UnifiedDataManager initialized for networked mode (socket pending)"),await this.networkedSession.initialize(),this.debug.log("NetworkedSession initialized - session:ready will fire");const n=this.networkedSession.getService("client");n?.socket&&this.dataManager._networkedStrategy&&(this.dataManager._networkedStrategy.socket=n.socket,this.debug.log("NetworkedStorage socket reference updated")),this.teamRegistry&&(this.teamRegistry.sessionModeManager=this.sessionModeManager,n&&(this.teamRegistry.orchestratorClient=n));const a=document.getElementById("connectionModal");a&&a.style.display!=="none"&&(a.style.display="none",this.debug.log("Connection wizard closed after successful initialization"));const i=document.getElementById("viewSelector");i&&(i.style.display="flex"),this.uiManager.showScreen("teamEntry"),this.debug.log("UI transitioned to team entry screen")}catch(n){throw console.error("NetworkedSession initialization failed:",n),this.networkedSession&&(await this.networkedSession.destroy(),this.networkedSession=null),n}}else this.debug.log("No valid token - showing connection wizard"),this.showConnectionWizard?this.showConnectionWizard():this.uiManager.showError("Connection wizard not available")}_isTokenValid(e){return N(e)}switchView(e){this.viewController.switchView(e)}async startScan(){console.warn("startScan() is deprecated - NFC now auto-starts on team confirmation"),await this._startNFCScanning()}async _startNFCScanning(){if(!this.nfcSupported){this.debug.log("NFC not supported - scan simulation available via Manual Entry");return}const e=document.getElementById("scanStatus");try{e&&(e.textContent="Scanning... Tap a token"),await this.nfcHandler.startScan(t=>this.processNFCRead(t),t=>{this.debug.log(`NFC read error: ${t?.message||t}`,!0),e&&(e.textContent="Read error. Tap token again.")}),this.debug.log("NFC scanning started automatically")}catch(t){this.debug.log(`NFC start error: ${t.message}`,!0),e&&(e.textContent="NFC unavailable. Use Manual Entry.")}}simulateScan(){const e=document.getElementById("scanStatus");e&&(e.textContent="Demo Mode: Simulating scan..."),setTimeout(()=>{const t=this.nfcHandler.simulateScan();this.processNFCRead(t)},this.config.SCAN_SIMULATION_DELAY)}async processNFCRead(e){if(e.source==="error"){this.debug.log(`NFC read failed: ${e.error}`,!0),this.uiManager.showError("Could not read token - please re-tap");return}if(this.debug.log(`Processing token: "${e.id}" (from ${e.source})`),this.debug.log(`Token ID length: ${e.id.length} characters`),!this.currentTeamId||this.currentTeamId.trim()===""){this.debug.log("ERROR: No team selected - cannot process token",!0),this.uiManager.showError("Please select a team before scanning tokens");return}const t=e.id.trim();this.debug.log(`Cleaned ID: "${t}" (length: ${t.length})`);const s=this.tokenManager.findToken(t),n=s?s.matchedId:t;if(this.dataManager.isTokenScanned(n)){this.debug.log(`Duplicate token detected: ${n}`,!0),this.showDuplicateError(n);return}s?await this.recordTransaction(s.token,s.matchedId,!1):await this.recordTransaction(null,t,!0)}showDuplicateError(e){const t=document.getElementById("resultStatus");t&&(t.className="status-message error",t.innerHTML=`
        <h2>Token Already Scanned</h2>
        <p style="font-size: 14px;">This token has been used</p>
        <p style="font-size: 12px; color: #666;">ID: ${e}</p>
      `);const s=document.getElementById("resultRfid");s&&(s.textContent=e);const n=document.getElementById("resultType");n&&(n.textContent="DUPLICATE",n.style.color="#FF5722");const a=document.getElementById("resultGroup");a&&(a.textContent="Previously scanned");const i=document.getElementById("resultValue");i&&(i.textContent="No points awarded"),this.uiManager.showScreen("result")}async recordTransaction(e,t,s){const n={timestamp:new Date().toISOString(),deviceId:this.settings.deviceId,mode:this.settings.mode,teamId:this.currentTeamId,rfid:t,tokenId:t,memoryType:s?"UNKNOWN":e?.SF_MemoryType||"UNKNOWN",group:s?`Unknown: ${t}`:e?.SF_Group||"",tokenGroup:s?"":e?.SF_Group||"",valueRating:s?0:e?.SF_ValueRating||0,isUnknown:s};if(this.settings.mode==="blackmarket"&&!s?n.points=this.dataManager.calculateTokenValue(n):n.points=0,this.sessionModeManager&&this.sessionModeManager.isNetworked()){if(this.dataManager.markTokenAsScanned(t),!this.networkedSession)throw new Error("Cannot scan: NetworkedSession not initialized. Please reconnect.");const i=this.networkedSession.getService("queueManager").queueTransaction({tokenId:t,teamId:this.currentTeamId,deviceId:this.settings.deviceId,deviceType:"gm",mode:this.settings.mode,summary:e?.summary||null,timestamp:n.timestamp});this.debug.log(`Transaction queued for orchestrator: ${i}`)}else if(this.sessionModeManager&&this.sessionModeManager.isStandalone())await this.dataManager.addTransaction(n),this.dataManager.markTokenAsScanned(t),this.debug.log("Transaction stored via UnifiedDataManager (standalone mode)");else{this.debug.log("Warning: No session mode selected - cannot process transaction",!0),this.uiManager.showError("Please select a game mode first");return}this.settings.mode==="blackmarket"&&!s&&this.debug.log(`Token scored: $${n.points.toLocaleString()}`),this.uiManager.updateSessionStats(),this.uiManager.showTokenResult(e,t,s)}manualEntry(){const e=prompt("Enter RFID manually:");e&&e.trim()&&this.processNFCRead({id:e.trim(),source:"manual",raw:e.trim()})}cancelScan(){this.nfcHandler.stopScan(),this.currentTeamId="",this.uiManager.updateTeamDisplay(""),this.uiManager.showScreen("teamEntry")}continueScan(){this.uiManager.updateSessionStats(),this.uiManager.showScreen("scan")}finishTeam(){this.currentTeamId="",this.uiManager.updateTeamDisplay(""),this.uiManager.showScreen("teamEntry")}showHistory(){this.uiManager.updateHistoryStats();const e=document.getElementById("historyContainer");e&&this.uiManager.renderGameActivity(e,{showSummary:!0,showFilters:!0}),this.uiManager.showScreen("history")}closeHistory(){const e=this.uiManager.previousScreen||"teamEntry";this.uiManager.showScreen(e)}showScoreboard(){if(this.settings.mode!=="blackmarket"){this.debug.log("Scoreboard only available in Black Market mode");return}this.uiManager.renderScoreboard(),this.uiManager.showScreen("scoreboard")}closeScoreboard(){const e=this.uiManager.previousScreen||"teamEntry";this.uiManager.showScreen(e)}showTeamDetails(e){this.viewController&&this.viewController.currentView==="admin"&&this.viewController.switchView("scanner"),this.currentInterventionTeamId=e;const t=this.dataManager.getTeamTransactions(e);this.uiManager.renderTeamDetails(e,t),this.uiManager.showScreen("teamDetails")}closeTeamDetails(){this.uiManager.showScreen("scoreboard")}async adminCreateSession(){const e=prompt("Enter session name:");if(!e)return;if(this.sessionModeManager?.isStandalone()){try{await this.dataManager.createSession(e.trim(),[]),this.debug.log(`Session created (standalone): ${e}`),this.uiManager.showToast("Session created","success"),this._refreshAdminSessionDisplay()}catch(s){console.error("Failed to create session (standalone):",s),this.uiManager.showError(`Failed to create session: ${s.message}`)}return}if(!this.viewController.adminInstances?.sessionManager){alert("Admin functions not available. Please ensure you are connected.");return}try{await this.viewController.adminInstances.sessionManager.createSession(e),this.debug.log(`Session created: ${e}`)}catch(s){console.error("Failed to create session:",s),this.uiManager.showError("Failed to create session. Check connection.")}}async adminPauseSession(){if(this.sessionModeManager?.isStandalone()){try{const t=await this.dataManager.pauseSession();t.success?(this.debug.log("Session paused (standalone)"),this.uiManager.showToast("Session paused","info"),this._refreshAdminSessionDisplay()):this.uiManager.showError(t.error||"Failed to pause session")}catch(t){console.error("Failed to pause session (standalone):",t),this.uiManager.showError(`Failed to pause session: ${t.message}`)}return}if(!this.viewController.adminInstances?.sessionManager){alert("Admin functions not available.");return}try{await this.viewController.adminInstances.sessionManager.pauseSession(),this.debug.log("Session paused")}catch(t){console.error("Failed to pause session:",t),this.uiManager.showError("Failed to pause session.")}}async adminResumeSession(){if(this.sessionModeManager?.isStandalone()){try{const t=await this.dataManager.resumeSession();t.success?(this.debug.log("Session resumed (standalone)"),this.uiManager.showToast("Session resumed","success"),this._refreshAdminSessionDisplay()):this.uiManager.showError(t.error||"Failed to resume session")}catch(t){console.error("Failed to resume session (standalone):",t),this.uiManager.showError(`Failed to resume session: ${t.message}`)}return}if(!this.viewController.adminInstances?.sessionManager){alert("Admin functions not available.");return}try{await this.viewController.adminInstances.sessionManager.resumeSession(),this.debug.log("Session resumed")}catch(t){console.error("Failed to resume session:",t),this.uiManager.showError("Failed to resume session.")}}async adminEndSession(){if(!confirm("Are you sure you want to end the session?"))return;if(this.sessionModeManager?.isStandalone()){try{await this.dataManager.endSession(),this.debug.log("Session ended (standalone)"),this.uiManager.showToast("Session ended","info"),this._refreshAdminSessionDisplay()}catch(t){console.error("Failed to end session (standalone):",t),this.uiManager.showError(`Failed to end session: ${t.message}`)}return}if(!this.viewController.adminInstances?.sessionManager){alert("Admin functions not available.");return}try{await this.viewController.adminInstances.sessionManager.endSession(),this.debug.log("Session ended")}catch(t){console.error("Failed to end session:",t),this.uiManager.showError("Failed to end session.")}}async downloadSessionReport(){try{const{SessionReportGenerator:e}=await Te(async()=>{const{SessionReportGenerator:S}=await import("./sessionReportGenerator-BGWQ2qjU.js");return{SessionReportGenerator:S}},[]),t=this.dataManager.getSessionData(),s=this.dataManager.getTeamScores(),n=this.dataManager.getTransactions(),a=this.dataManager.getPlayerScans(),i=this.tokenManager?.database||{};if(!t){this.uiManager.showError("No session data available for report.");return}const r=new e(i).generate({session:t,scores:s,transactions:n,playerScans:a}),d=t.startTime?new Date(t.startTime).toISOString().split("T")[0]:"unknown",u=`session-report-${(t.name||"session").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"")}-${d}.md`,g=new Blob([r],{type:"text/markdown"}),m=URL.createObjectURL(g),f=document.createElement("a");f.href=m,f.download=u,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(m),this.uiManager.showToast("Report downloaded","info")}catch(e){console.error("Failed to generate session report:",e),this.uiManager.showError("Failed to generate report.")}}async adminResetAndCreateNew(){if(!confirm(`Reset system and start new session?

This will:
‚Ä¢ Archive the current completed session
‚Ä¢ Clear all current data
‚Ä¢ Prepare system for a new game

Continue?`))return;const t=prompt("Enter new session name:");if(!t||t.trim()===""){alert("Session name is required");return}if(!this.viewController.adminInstances?.sessionManager){alert("Admin functions not available. Please ensure you are connected to the orchestrator.");return}try{this.debug.log("Sending system:reset command..."),await new Promise((s,n)=>{const a=setTimeout(()=>{n(new Error("System reset timeout (5s)"))},5e3),i=this.viewController.adminInstances.sessionManager.connection.socket;i.once("gm:command:ack",o=>{if(clearTimeout(a),o.data&&o.data.success)this.debug.log("System reset successful"),s();else{const r=o.data?.message||"Reset failed";n(new Error(r))}}),i.emit("gm:command",{event:"gm:command",data:{action:"system:reset",payload:{}},timestamp:new Date().toISOString()})}),this.debug.log("System reset complete, creating new session..."),await this.viewController.adminInstances.sessionManager.createSession(t.trim()),this.debug.log(`New session created: ${t}`),this.uiManager.showToast?this.uiManager.showToast(`Session "${t}" started successfully`,"success",5e3):alert(`Session "${t}" created successfully!`)}catch(s){console.error("Failed to reset and create session:",s);const n=`Failed to reset and create session: ${s.message}`;this.uiManager.showError?this.uiManager.showError(n):alert(n)}}async adminViewSessionDetails(){const e=this.viewController.adminInstances?.sessionManager?.currentSession;if(!e){alert("No session data available");return}const t=e.startTime?new Date(e.startTime).toLocaleString():"Unknown",s=e.endTime?new Date(e.endTime).toLocaleString():"Ongoing",n=e.getDuration?this.formatSessionDuration(e.getDuration()):"Unknown",a=`
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SESSION DETAILS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Name: ${e.name||"Unnamed Session"}
ID: ${e.id}
Status: ${e.status.toUpperCase()}

TIMING
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Started: ${t}
${e.endTime?"Ended: "+s:"Status: In Progress"}
Duration: ${n}

STATISTICS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total Scans: ${e.metadata?.totalScans||0}
Unique Tokens: ${e.metadata?.uniqueTokensScanned?.length||0}
Teams: ${e.scores?.length||0}
GM Stations: ${e.connectedDevices?.filter(i=>i.type==="gm").length||0}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    `.trim();alert(a)}formatSessionDuration(e){if(e==null||e<0)return"Unknown";const t=Math.floor(e/1e3),s=Math.floor(t/60),n=Math.floor(s/60),a=Math.floor(n/24),i=[];return a>0&&i.push(`${a}d`),n%24>0&&i.push(`${n%24}h`),s%60>0&&i.length<2&&i.push(`${s%60}m`),t%60>0&&i.length<2&&i.push(`${t%60}s`),i.length>0?i.join(" "):"0s"}async _adminVideoAction(e){if(!this.viewController.adminInstances?.videoController){alert("Video controls not available.");return}try{await this.viewController.adminInstances.videoController[e]()}catch(t){const s=e.replace("Video"," video");console.error(`Failed to ${s}:`,t),this.uiManager.showError(`Failed to ${s}.`)}}async adminPlayVideo(){return this._adminVideoAction("playVideo")}async adminPauseVideo(){return this._adminVideoAction("pauseVideo")}async adminStopVideo(){return this._adminVideoAction("stopVideo")}async adminSkipVideo(){return this._adminVideoAction("skipVideo")}async adminAddVideoToQueue(){if(!this.viewController.adminInstances?.videoController){alert("Video controls not available.");return}const e=document.getElementById("manual-video-input"),t=e?.value;if(!t){alert("Enter a video filename (e.g., jaw001.mp4)");return}try{await this.viewController.adminInstances.videoController.addToQueue(t),this.uiManager.showToast(`Added ${t} to queue`,"success"),e&&(e.value="")}catch(s){console.error("Failed to add video to queue:",s),this.uiManager.showError(`Failed to add video: ${s.message}`)}}async adminClearQueue(){if(!this.viewController.adminInstances?.videoController){alert("Video controls not available.");return}if(confirm("Clear entire video queue?"))try{await this.viewController.adminInstances.videoController.clearQueue(),this.uiManager.showToast("Queue cleared","success")}catch(e){console.error("Failed to clear queue:",e),this.uiManager.showError(`Failed to clear queue: ${e.message}`)}}updateAdminPanel(){this.viewController?.adminInstances?.monitoring&&this.viewController.adminInstances.monitoring.refreshAllDisplays();const e=document.getElementById("admin-game-activity");e&&this.uiManager.renderGameActivity(e,{showSummary:!0,showFilters:!0});const t=document.getElementById("admin-score-board");if(t&&this.viewController?.adminInstances?.monitoring)this.uiManager.renderScoreboard(t);else if(t){const s={};this.dataManager.getTransactions().forEach(a=>{if(s[a.teamId]||(s[a.teamId]={score:0,count:0}),s[a.teamId].count++,a.mode==="blackmarket"){const i=this.dataManager.calculateTokenValue(a);s[a.teamId].score+=i}});let n='<table class="score-table"><tr><th>Team</th><th>Tokens</th><th>Score</th></tr>';Object.keys(s).forEach(a=>{n+=`<tr>
          <td style="cursor: pointer; color: #007bff; text-decoration: underline;"
              data-action="app.showTeamDetails" data-arg="${a}">
            ${a}
          </td>
          <td>${s[a].count}</td>
          <td>${s[a].score.toLocaleString()}</td>
        </tr>`}),n+="</table>",t.innerHTML=n}}async adminResetScores(){if(!confirm("Reset all team scores to zero? Transactions will be preserved."))return;if(this.sessionModeManager?.isStandalone()){try{const t=await this.dataManager.resetScores();t.success?(this.debug.log("Scores reset (standalone)"),this.uiManager.showToast("All scores reset to zero","success")):this.uiManager.showError(t.error||"Failed to reset scores")}catch(t){console.error("Failed to reset scores (standalone):",t),this.uiManager.showError(`Failed to reset scores: ${t.message}`)}return}if(!this.viewController.adminInstances?.adminOps){alert("Admin functions not available.");return}try{await this.viewController.adminInstances.adminOps.resetScores(),this.debug.log("Scores reset"),this.uiManager.showToast("All scores reset","success")}catch(t){console.error("Failed to reset scores:",t),this.uiManager.showError("Failed to reset scores.")}}viewFullScoreboard(){this.switchView("scanner"),this.showScoreboard()}viewFullHistory(){this.switchView("scanner"),this.showHistory()}_refreshAdminSessionDisplay(){const e=document.getElementById("session-status-container");e&&this.uiManager&&this.uiManager.renderSessionStatus(e)}async adjustTeamScore(){const e=this.currentInterventionTeamId;if(!e){alert("No team selected. Please open team details first.");return}const t=document.getElementById("scoreAdjustmentInput"),s=document.getElementById("scoreAdjustmentReason"),n=parseInt(t?.value||"0");if(isNaN(n)||n===0){alert("Please enter a valid positive or negative number.");return}const a=s?.value.trim()||"Manual GM adjustment";if(this.sessionModeManager?.isStandalone()){try{await this.dataManager.adjustTeamScore(e,n,a),this.debug.log(`Score adjusted (standalone): Team ${e} ${n>0?"+":""}${n} (${a})`),t&&(t.value=""),s&&(s.value="");const o=this.dataManager.getTeamTransactions(e);this.uiManager.renderTeamDetails(e,o),this.uiManager.showToast(`Score adjusted: ${n>0?"+":""}${n} points`,"success")}catch(o){console.error("Failed to adjust score (standalone):",o),this.uiManager.showError(`Failed to adjust score: ${o.message}`)}return}if(!this.viewController?.adminInstances?.adminOps){alert("Admin functions not available. Ensure you are in networked mode.");return}try{await this.viewController.adminInstances.adminOps.adjustScore(e,n,a),this.debug.log(`Score adjusted (networked): Team ${e} ${n>0?"+":""}${n} (${a})`),t&&(t.value=""),s&&(s.value=""),this.uiManager.showToast(`Score adjusted: ${n>0?"+":""}${n} points`,"success")}catch(o){console.error("Failed to adjust score (networked):",o),this.uiManager.showError(`Failed to adjust score: ${o.message}`)}}async deleteTeamTransaction(e){if(!confirm("Delete this transaction? This cannot be undone."))return;if(this.sessionModeManager?.isStandalone()){try{if((await this.dataManager.removeTransaction(e)).success){this.debug.log(`Transaction deleted (standalone): ${e}`);const n=this.currentInterventionTeamId;if(n){const a=this.dataManager.getTeamTransactions(n);this.uiManager.renderTeamDetails(n,a)}this.uiManager.showToast("Transaction deleted","success")}else this.uiManager.showError("Transaction not found")}catch(s){console.error("Failed to delete transaction (standalone):",s),this.uiManager.showError(`Failed to delete transaction: ${s.message}`)}return}if(!this.viewController?.adminInstances?.adminOps){alert("Admin functions not available. Ensure you are in networked mode.");return}try{await this.viewController.adminInstances.adminOps.deleteTransaction(e),this.debug.log(`Transaction deleted (networked): ${e}`),this.uiManager.showToast("Transaction deleted","success")}catch(s){console.error("Failed to delete transaction (networked):",s),this.uiManager.showError(`Failed to delete transaction: ${s.message}`)}}async _adminDisplayAction(e,t){if(!this.sessionModeManager?.isNetworked()){this.debug.log("Display control only available in networked mode");return}const s=this.viewController?.adminInstances?.displayController;if(!s){this.debug.log("DisplayController not available - admin modules not initialized"),this.uiManager.showError("Admin functions not available. Please ensure connection is established.");return}try{const n=await s[e]();this.debug.log(`Display mode set to ${t}: ${JSON.stringify(n)}`)}catch(n){console.error("Failed to set display mode:",n),this.uiManager.showError(`Failed to set display mode: ${n.message}`)}}async adminSetIdleLoop(){return this._adminDisplayAction("setIdleLoop","Idle Loop")}async adminSetScoreboard(){return this._adminDisplayAction("setScoreboard","Scoreboard")}}new J;class We{constructor(e){this.app=e,this.scanForServers=this.scanForServers.bind(this),this.handleConnectionSubmit=this.handleConnectionSubmit.bind(this),this.cancelNetworkedMode=this.cancelNetworkedMode.bind(this),this.showConnectionWizard=this.showConnectionWizard.bind(this)}init(){const e=document.getElementById("connectionForm");e&&e.addEventListener("submit",this.handleConnectionSubmit),this._setupServerUrlHandler()}async scanForServers(){const e=document.getElementById("discoveryStatus"),t=document.getElementById("discoveredServers"),s=document.getElementById("scanServersBtn");s.disabled=!0,s.textContent="üîç Scanning...",e.textContent="Looking for orchestrators on the network...",e.style.color="#2196F3",t.innerHTML="";try{const n=window.location.hostname;let a="192.168.1";if(n&&n!=="localhost"&&n!=="127.0.0.1"){const u=n.split(".");u.length>=3&&(a=u.slice(0,3).join("."))}const i=[3e3,8080],o=window.location.protocol.replace(":",""),r=[];for(let u=1;u<=254;u++)for(const g of i){const m=`${o}://${a}.${u}:${g}`;r.push(fetch(`${m}/health`,{method:"GET",mode:"cors",signal:AbortSignal.timeout(500)}).then(f=>f.ok?m:null).catch(()=>null))}r.push(fetch(`${o}://localhost:3000/health`,{signal:AbortSignal.timeout(1e3)}).then(u=>u.ok?`${o}://localhost:3000`:null).catch(()=>null)),window.location.pathname.startsWith("/gm-scanner/")&&r.push(Promise.resolve(window.location.origin));const d=await Promise.all(r),l=[...new Set(d.filter(u=>u!==null))];l.length>0?(e.textContent=`‚úÖ Found ${l.length} orchestrator(s)`,e.style.color="#4CAF50",this.displayDiscoveredServers(l.map(u=>({url:u})))):(e.textContent="‚ö†Ô∏è No orchestrators found. Please enter URL manually below.",e.style.color="#ff9800")}catch(n){e.textContent="‚ùå Discovery failed. Please enter URL manually below.",e.style.color="#f44336",console.error("Server discovery error:",n)}finally{s.disabled=!1,s.textContent="üîç Scan for Game Servers"}}displayDiscoveredServers(e){const t=document.getElementById("discoveryStatus"),s=document.getElementById("discoveredServers");t.textContent=`‚úÖ Found ${e.length} game server(s)`,s.innerHTML="",e.forEach(n=>{const a=document.createElement("div");a.className="server-item",a.innerHTML=`
        <span>üéÆ Game Server at ${n.ip||n.url}</span>
        <button data-action="connectionWizard.selectServer" data-arg="${n.url}">Select</button>
      `,s.appendChild(a)})}_setupServerUrlHandler(){const e=document.getElementById("serverUrl");if(!e)return;let t;const s=500;e.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{const n=e.value.trim();if(n){let a=n;a.match(/^https?:\/\//i)||(a=`http://${a}`),this.assignStationName(a)}},s)})}async assignStationName(e){const t=document.getElementById("stationNameDisplay");if(t)try{const s=await fetch(`${e}/api/state`,{method:"GET",mode:"cors",signal:AbortSignal.timeout(3e3)});if(!s.ok)throw new Error("Server unreachable");const i=((await s.json()).devices||[]).filter(r=>r.type==="gm").map(r=>r.deviceId),o=this._findNextStationId(i);t.textContent=o,t.dataset.deviceId=o,console.log(`[ConnectionWizard] Auto-assigned station name: ${o}`)}catch(s){console.warn("[ConnectionWizard] Failed to query /api/state, using localStorage fallback:",s.message);const a=`GM_Station_${localStorage.getItem("lastStationNum")||"1"}`;t&&(t.textContent=a,t.dataset.deviceId=a)}}_findNextStationId(e){const t=e.filter(n=>n&&n.startsWith("GM_Station_")).map(n=>{const a=n.match(/GM_Station_(\d+)$/);return a?parseInt(a[1],10):null}).filter(n=>n!==null).sort((n,a)=>n-a);let s=1;for(const n of t)if(n===s)s++;else if(n>s)break;return`GM_Station_${s}`}selectServer(e){document.getElementById("serverUrl").value=e,document.getElementById("discoveryStatus").textContent="‚úÖ Server selected",this.assignStationName(e)}async handleConnectionSubmit(e){e.preventDefault();const t=document.getElementById("serverUrl").value,s=document.getElementById("gmPassword").value,n=document.getElementById("connectionStatusMsg"),a=document.getElementById("stationNameDisplay"),i=a?a.dataset.deviceId:null;if(!t||!i||!s){n.textContent="‚ö†Ô∏è Please fill in all fields",n.style.color="#ff9800";return}n.textContent="‚è≥ Connecting...",n.style.color="#2196F3";try{let o=t.trim();if(o.match(/^https?:\/\//i)||(o=`http://${o}`,n.textContent=`üîß Using ${o}`),!(await fetch(`${o}/health`,{method:"GET",mode:"cors",signal:AbortSignal.timeout(3e3)})).ok)throw new Error("Server not responding");const d=await fetch(`${o}/api/admin/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:s})});if(!d.ok){n.textContent="‚ùå Invalid password",n.style.color="#f44336";return}const{token:l}=await d.json();localStorage.setItem("aln_orchestrator_url",o),localStorage.setItem("aln_auth_token",l),localStorage.setItem("aln_station_name",i);const u=this.app.settings;u.deviceId=i,u.stationName=i,u.save();const g=i.match(/GM_Station_(\d+)$/);if(g){const m=parseInt(g[1],10)+1;localStorage.setItem("lastStationNum",m.toString())}n.textContent="‚úÖ Authenticated! Connecting...",n.style.color="#4CAF50",await this.app.selectGameMode("networked")}catch(o){n.textContent=`‚ùå Connection failed: ${o.message}`,n.style.color="#f44336"}}cancelNetworkedMode(){document.getElementById("connectionModal").style.display="none";const e=this.app.sessionModeManager;e&&e.clearMode(),this.app.uiManager.showScreen("gameModeScreen")}showConnectionWizard(){const e=document.getElementById("connectionModal");e.style.display="flex",setTimeout(()=>this.scanForServers(),100)}}class Ke{constructor(e){this.app=e,this.updateQueueIndicator=this.updateQueueIndicator.bind(this)}init(){this.updateQueueIndicator();const e=this.app.networkedSession?.services?.queueManager;e&&e.addEventListener("queue:changed",t=>{console.log("Queue changed:",t.detail),this.updateQueueIndicator()})}updateQueueIndicator(){const e=document.getElementById("queueStatusIndicator"),t=document.getElementById("queueCount");if(!e||!t)return;const n=this.app.networkedSession?.services?.queueManager?.getStatus(),a=n?n.queuedCount:0;t.textContent=a,e.classList.toggle("visible",a>0)}}function Je(c){window.addEventListener("beforeunload",()=>{c.networkedSession?.services?.client&&(console.log("Page unloading - disconnecting socket"),c.networkedSession.services.client.disconnect())})}function Ye(c,e,t,s,n,a,i){function o(r,d){const l=c.networkedSession?.getService("adminController");if(!l?.initialized){s.log("Admin action ignored: admin not initialized",!0);return}switch(r){case"startGame":l.getModule("sessionManager").startGame();break;case"fireCue":{const u=d.dataset.cueId;u&&l.getModule("cueController").fireCue(u);break}case"enableCue":{const u=d.dataset.cueId;u&&l.getModule("cueController").enableCue(u);break}case"disableCue":{const u=d.dataset.cueId;u&&l.getModule("cueController").disableCue(u);break}case"pauseCue":{const u=d.dataset.cueId;u&&l.getModule("cueController").pauseCue(u);break}case"stopCue":{const u=d.dataset.cueId;u&&l.getModule("cueController").stopCue(u);break}case"resumeCue":{const u=d.dataset.cueId;u&&l.getModule("cueController").resumeCue(u);break}case"resolveConflictCue":{const u=d.dataset.cueId,g=d.dataset.decision;u&&g&&l.getModule("cueController").resolveConflict(u,g);break}case"spotifyPlay":l.getModule("spotifyController").play();break;case"spotifyPause":l.getModule("spotifyController").pause();break;case"spotifyNext":l.getModule("spotifyController").next();break;case"spotifyPrevious":l.getModule("spotifyController").previous();break;case"startBtScan":l.getModule("bluetoothController").startScan();break;case"stopBtScan":l.getModule("bluetoothController").stopScan();break;case"pairBtDevice":{const u=d.dataset.btAddress;u&&l.getModule("bluetoothController").pairDevice(u);break}case"connectBtDevice":{const u=d.dataset.btAddress;u&&l.getModule("bluetoothController").connectDevice(u);break}case"disconnectBtDevice":{const u=d.dataset.btAddress;u&&l.getModule("bluetoothController").disconnectDevice(u);break}case"setAudioRoute":{const u=d.dataset.stream||"video",g=d.value;l.getModule("audioController").setVideoOutput(g,u);break}case"lightingRetry":l.getModule("lightingController").refreshScenes();break;case"activateScene":{const u=d.dataset.sceneId;u&&l.getModule("lightingController").activateScene(u);break}default:s.log(`Unknown admin action: ${r}`,!0)}}document.addEventListener("click",r=>{const d=r.target.closest("[data-action]");if(!d)return;d.tagName==="A"&&r.preventDefault();const l=d.dataset.action,u=d.dataset.arg,[g,m]=l.split(".");try{switch(g){case"app":typeof c[m]=="function"?c[m](u):s.log(`Action method not found: app.${m}`,!0);break;case"dataManager":typeof e[m]=="function"?e[m](u):s.log(`Action method not found: dataManager.${m}`,!0);break;case"settings":typeof t[m]=="function"?t[m](u):s.log(`Action method not found: settings.${m}`,!0);break;case"debug":typeof s[m]=="function"?s[m](u):s.log(`Action method not found: debug.${m}`,!0);break;case"uiManager":typeof n[m]=="function"?n[m](u):s.log(`Action method not found: uiManager.${m}`,!0);break;case"connectionWizard":typeof a[m]=="function"?a[m](u):s.log(`Action method not found: connectionWizard.${m}`,!0);break;case"queueStatusManager":typeof i[m]=="function"?i[m](u):s.log(`Action method not found: queueStatusManager.${m}`,!0);break;case"admin":o(m,d);break;default:s.log(`Unknown action target: ${g}`,!0)}}catch(f){s.log(`Action handler error: ${l} - ${f.message}`,!0),console.error(`Action handler error: ${l}`,f)}}),document.addEventListener("change",r=>{const d=r.target.closest("[data-action]");if(!d)return;const l=d.dataset.action,[u,g]=l.split(".");try{u==="admin"&&o(g,d)}catch(m){s.log(`Action handler error: ${l} - ${m.message}`,!0),console.error(`Action handler error: ${l}`,m)}})}class Xe{constructor({uiManager:e,dataManager:t,debug:s}={}){this.uiManager=e,this.dataManager=t,this.debug=s,this.appContext=null,this.globalHandlers={},this.screenHandlers=new Map,this.containerHandlers={},this.connectedSources=new Map}setAppContext(e){this.appContext=e,this.debug?.log("[ScreenUpdateManager] App context set")}registerGlobalHandler(e,t){this.globalHandlers[e]||(this.globalHandlers[e]=[]),this.globalHandlers[e].push(t),this.debug?.log(`[ScreenUpdateManager] Registered global handler for ${e}`)}registerScreen(e,t){if(!t||typeof t!="object"||Array.isArray(t))throw new TypeError(`[ScreenUpdateManager] registerScreen('${e}'): handlers must be an object, got ${typeof t}`);this.screenHandlers.set(e,t);const s=Object.keys(t).join(", ");this.debug?.log(`[ScreenUpdateManager] Registered screen '${e}' for events: ${s}`)}registerContainer(e,t){this.containerHandlers[e]=t;const s=Object.keys(t).join(", ");this.debug?.log(`[ScreenUpdateManager] Registered container '${e}' for events: ${s}`)}getActiveScreenId(){const e=document.querySelector(".screen.active");if(!e)return null;const t=e.id;return t.endsWith("Screen")?t.replace("Screen",""):(console.warn(`[ScreenUpdateManager] Unexpected screen ID pattern: '${t}' (expected 'xxxScreen' format). Screen handlers may not work correctly.`),t)}onDataUpdate(e,t){this.debug?.log(`[ScreenUpdateManager] ${e} event received`);const s=this.globalHandlers[e]||[];for(const o of s)try{o(t)}catch(r){console.error(`[ScreenUpdateManager] Global handler error for ${e}:`,r)}for(const[o,r]of Object.entries(this.containerHandlers)){const d=document.getElementById(o);if(d&&r[e])try{r[e](t,d)}catch(l){console.error(`[ScreenUpdateManager] Container handler error for ${o}/${e}:`,l)}}const n=this.getActiveScreenId();if(!n){this.debug?.log("[ScreenUpdateManager] No active screen, skipping screen handler");return}const i=this.screenHandlers.get(n)?.[e];if(i){this.debug?.log(`[ScreenUpdateManager] Running ${e} handler for screen '${n}'`);try{i(t,this.appContext)}catch(o){console.error(`[ScreenUpdateManager] Screen handler error for ${n}/${e}:`,o)}}}connectToDataSource(e,t){this.connectedSources.has(e)||this.connectedSources.set(e,new Map);const s=this.connectedSources.get(e);for(const n of t){const a=i=>{this.onDataUpdate(n,i.detail)};s.set(n,a),e.addEventListener(n,a)}this.debug?.log(`[ScreenUpdateManager] Connected to data source for events: ${t.join(", ")}`)}disconnectFromDataSource(e){const t=this.connectedSources.get(e);if(!t){this.debug?.log("[ScreenUpdateManager] No listeners found for data source, skipping disconnect");return}for(const[s,n]of t)e.removeEventListener(s,n);this.connectedSources.delete(e),this.debug?.log(`[ScreenUpdateManager] Disconnected from data source (${t.size} listeners removed)`)}disconnectAll(){for(const e of this.connectedSources.keys())this.disconnectFromDataSource(e);this.debug?.log("[ScreenUpdateManager] Disconnected from all data sources")}}const I=new re({tokenManager:H,sessionModeManager:null,debug:h}),Ze=new ce,v=new q({settings:x,dataManager:I}),b=new Xe({uiManager:v,dataManager:I,debug:h});b.registerGlobalHandler("transaction:added",()=>{v.updateHistoryBadge(),v.updateSessionStats()});b.registerGlobalHandler("transaction:deleted",()=>{v.updateHistoryBadge(),v.updateSessionStats()});b.registerGlobalHandler("data:cleared",()=>{v.updateHistoryBadge()});b.registerGlobalHandler("game-state:updated",()=>{v.updateHistoryBadge(),v.updateSessionStats()});const R=(c=!0)=>{c&&v.updateHistoryStats();const e=document.getElementById("historyContainer");e&&v.renderGameActivity(e,{showSummary:!0,showFilters:!0})};b.registerScreen("history",{"transaction:added":()=>R(),"transaction:deleted":()=>R(),"player-scan:added":()=>R(!1)});b.registerScreen("teamDetails",{"transaction:added":(c,e)=>{const t=e?.currentInterventionTeamId;if(t){h.log(`[main.js] Team details active - re-rendering for team ${t}`);const s=I.getTeamTransactions(t);v.renderTeamDetails(t,s)}},"transaction:deleted":(c,e)=>{const t=e?.currentInterventionTeamId;if(t){h.log(`[main.js] Team details active - re-rendering after deletion for team ${t}`);const s=I.getTeamTransactions(t);v.renderTeamDetails(t,s)}},"team-score:updated":(c,e)=>{const{teamId:t,transactions:s}=c||{},n=e?.currentInterventionTeamId;n&&n===t&&(h.log(`[main.js] Team details active - score update for team ${t}`),v.renderTeamDetails(t,s))}});const Y={"team-score:updated":(c,e)=>v.renderScoreboard(e),"scores:cleared":(c,e)=>{e.innerHTML=""},"data:cleared":(c,e)=>{e.innerHTML=""}};b.registerContainer("scoreboardContainer",Y);b.registerContainer("admin-score-board",Y);b.registerContainer("admin-game-activity",{"transaction:added":(c,e)=>{h.log("[main.js] Updating admin-game-activity (transaction added)"),v.renderGameActivity(e,{showSummary:!0,showFilters:!0})},"transaction:deleted":(c,e)=>{h.log("[main.js] Updating admin-game-activity (transaction deleted)"),v.renderGameActivity(e,{showSummary:!0,showFilters:!0})},"player-scan:added":(c,e)=>{h.log("[main.js] Updating admin-game-activity (player scan)"),v.renderGameActivity(e,{showSummary:!0,showFilters:!0})},"data:cleared":(c,e)=>{h.log("[main.js] Session reset - clearing admin-game-activity"),e.innerHTML=""}});b.registerContainer("session-status-container",{"session:updated":(c,e)=>{h.log("[main.js] Updating session-status-container (session updated)"),v.renderSessionStatus(e)},"data:cleared":(c,e)=>{h.log("[main.js] Session reset - re-rendering session-status-container"),v.renderSessionStatus(e)}});const et=new K;b.registerContainer("video-control-panel",{"video-state:updated":(c,e)=>{et.render(c)}});b.connectToDataSource(I,["transaction:added","transaction:deleted","scores:cleared","data:cleared","game-state:updated","team-score:updated","player-scan:added","session:updated","video-state:updated"]);const C=new J({debug:h,uiManager:v,settings:x,tokenManager:H,dataManager:I,teamRegistry:Ze,nfcHandler:Q,config:F,initializationSteps:W});I.app=C;b.setAppContext(C);const A=new We(C),X=new Ke(C);C.showConnectionWizard=A.showConnectionWizard.bind(A);Ye(C,I,x,h,v,A,X);Je(C);async function V(){h.log("=== ALNScanner ES6 Module Architecture ==="),h.log("Main entry point loaded"),h.log("Initializing application...");try{await C.init(),h.log("Application initialization complete"),A.init(),h.log("Connection wizard initialized"),X.init(),h.log("Queue status manager initialized")}catch(c){h.log(`Initialization error: ${c.message}`,!0),console.error("App initialization failed:",c),v&&v.showError(`Failed to initialize: ${c.message}`)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",V):V();export{$ as S};
//# sourceMappingURL=main-D1p0yGME.js.map
