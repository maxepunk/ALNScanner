
> alnscanner@1.0.0 test
> jest

  console.warn
    OrchestratorClient: Already connected, cleaning up old socket

      47 |     // Cleanup old socket first (allows reconnection)
      48 |     if (this.socket?.connected) {
    > 49 |       console.warn('OrchestratorClient: Already connected, cleaning up old socket');
         |               ^
      50 |     }
      51 |
      52 |     this._cleanup();

      at OrchestratorClient.connect (js/network/OrchestratorClient.js:49:15)
      at Object.<anonymous> (tests/unit/OrchestratorClient.test.js:122:38)

PASS tests/unit/ConnectionManager.test.js
  ConnectionManager - Connection Lifecycle
    constructor
      ✓ should initialize with disconnected state (11 ms)
      ✓ should store config (2 ms)
      ✓ should store token (1 ms)
      ✓ should initialize retry count to 0 (1 ms)
      ✓ should extend EventTarget for event emission (1 ms)
    token validation
      ✓ should validate token expiry with 1 minute buffer (1 ms)
      ✓ should reject expired tokens (1 ms)
      ✓ should reject tokens expiring within 1 minute (1 ms)
      ✓ should reject null token (2 ms)
      ✓ should reject malformed token (4 ms)
      ✓ should reject token without exp claim (1 ms)
    health check
      ✓ should check orchestrator reachability before connecting (3 ms)
      ✓ should return false if orchestrator unreachable (1 ms)
      ✓ should return false if health check returns non-ok status (1 ms)
      ✓ should timeout after 5 seconds (1 ms)
    connect
      ✓ should validate token before connecting (8 ms)
      ✓ should check health before connecting (5 ms)
      ✓ should call client.connect with token and auth (3 ms)
      ✓ should emit connecting event before connection attempt (1 ms)
      ✓ should emit connected event on success (2 ms)
      ✓ should reset retry count on successful connection (1 ms)
      ✓ should emit auth:required on token expiry (2 ms)
      ✓ should setup reconnection handler after successful connect (2 ms)
    reconnection handling
      ✓ should auto-reconnect on server-initiated disconnect if token valid (1005 ms)
      ✓ should emit auth:required on disconnect if token expired (2 ms)
      ✓ should NOT reconnect on client-initiated disconnect (3 ms)
      ✓ should emit disconnected event on disconnect (3 ms)
    retry logic
      ✓ should retry with exponential backoff on connection failure (8 ms)
      ✓ should use exponential backoff delays (1s, 2s, 4s, 8s, 16s, 30s max) (2 ms)
      ✓ should emit auth:required after max retries (2 ms)
      ✓ should clear retry timer on successful connection (1 ms)
      ✓ should NOT retry if token expired (5 ms)
    disconnect
      ✓ should cleanup retry timer and disconnect client (2 ms)
      ✓ should remove client event listeners (2 ms)
      ✓ should not throw if not connected (2 ms)
    updateToken
      ✓ should update token (1 ms)
      ✓ should allow reconnection with new token (1 ms)

  console.warn
    AdminController: Already initialized

      30 |     // Guard against re-initialization
      31 |     if (this.initialized) {
    > 32 |       console.warn('AdminController: Already initialized');
         |               ^
      33 |       return;
      34 |     }
      35 |

      at AdminController.initialize (js/app/AdminController.js:32:15)
      at Object.<anonymous> (tests/unit/AdminController.test.js:96:18)

PASS tests/unit/AdminController.test.js
  AdminController - Admin Module Lifecycle
    constructor
      ✓ should initialize with not-initialized state (2 ms)
      ✓ should store client reference (1 ms)
      ✓ should extend EventTarget for event emission (1 ms)
    initialize
      ✓ should create all admin modules once (3 ms)
      ✓ should store module references (2 ms)
      ✓ should not re-initialize if already initialized (39 ms)
      ✓ should emit initialized event (2 ms)
    getModule
      ✓ should return specific admin module (1 ms)
      ✓ should throw if not initialized (3 ms)
      ✓ should throw if module name invalid (2 ms)
    pause
      ✓ should pause all pausable modules (1 ms)
      ✓ should not throw if not initialized (1 ms)
    resume
      ✓ should resume all pausable modules (7 ms)
      ✓ should not throw if not initialized
    destroy
      ✓ should cleanup all modules (2 ms)
      ✓ should reset state after destroy (1 ms)
      ✓ should not throw if not initialized

PASS tests/unit/NetworkedSession.test.js
  NetworkedSession - Service Orchestration
    constructor
      ✓ should initialize with disconnected state (2 ms)
      ✓ should store config (1 ms)
      ✓ should extend EventTarget for event emission (1 ms)
    initialize
      ✓ should create services in correct order (7 ms)
      ✓ should wire event handlers between services (1 ms)
      ✓ should initiate connection after services created (1 ms)
      ✓ should emit session:ready on successful initialization (1 ms)
      ✓ should emit session:error on initialization failure (3 ms)
      ✓ should cleanup event listeners if initialization fails (2 ms)
      ✓ should throw if already initialized (1 ms)
    service coordination
      ✓ should initialize admin controller on connected event (2 ms)
      ✓ should sync queue on connected event (2 ms)
      ✓ should pause admin controller on disconnected event (2 ms)
      ✓ should forward auth:required event (1 ms)
    getService
      ✓ should return requested service (1 ms)
      ✓ should throw if session not initialized (2 ms)
      ✓ should throw if service name invalid (2 ms)
    destroy
      ✓ should destroy services in reverse order (1 ms)
      ✓ should reset state after destroy (1 ms)
      ✓ should not throw if not initialized (1 ms)
      ✓ should remove all event listeners (1 ms)

  console.warn
    OrchestratorClient: Already connected, cleaning up old socket

      47 |     // Cleanup old socket first (allows reconnection)
      48 |     if (this.socket?.connected) {
    > 49 |       console.warn('OrchestratorClient: Already connected, cleaning up old socket');
         |               ^
      50 |     }
      51 |
      52 |     this._cleanup();

      at OrchestratorClient.connect (js/network/OrchestratorClient.js:49:15)
      at Object.<anonymous> (tests/unit/OrchestratorClient.test.js:344:37)

PASS tests/unit/OrchestratorClient.test.js
  OrchestratorClient - Dumb Pipe
    constructor
      ✓ should initialize with null socket (10 ms)
      ✓ should store config (2 ms)
      ✓ should NOT create socket until connect() called (2 ms)
      ✓ should extend EventTarget for event emission (2 ms)
    connect
      ✓ should create socket with provided token and auth (5 ms)
      ✓ should emit socket:connected event when connection succeeds (2 ms)
      ✓ should emit socket:error event on connection failure (7 ms)
      ✓ should timeout after 10 seconds if no response (6 ms)
      ✓ should cleanup old socket before creating new one (37 ms)
      ✓ should NOT validate token (that is ConnectionManager responsibility) (2 ms)
      ✓ should NOT handle reconnection logic (that is ConnectionManager responsibility) (1 ms)
    send
      ✓ should wrap message in AsyncAPI envelope (4 ms)
      ✓ should throw if socket not connected (4 ms)
      ✓ should throw if socket is null (1004 ms)
    message forwarding
      ✓ should emit message:received event for all orchestrator messages (2 ms)
      ✓ should forward all AsyncAPI message types (3 ms)
      ✓ should NOT process messages (just forward them) (3 ms)
    disconnect
      ✓ should cleanup socket and listeners (1004 ms)
      ✓ should wait for disconnect event before resolving (12 ms)
      ✓ should emit socket:disconnected event (4 ms)
      ✓ should not throw if socket already null (1003 ms)
      ✓ should timeout after 1 second if no disconnect event (1 ms)
      ✓ should handle disconnect when socket exists but not connected (4 ms)
    destroy
      ✓ should cleanup all resources (1 ms)
      ✓ should not throw if never connected (2 ms)
      ✓ should cleanup connection timeout if destroyed during connection (2 ms)
      ✓ should handle destroy when socket disconnected but exists (1 ms)
    socket event handling
      ✓ should emit socket:disconnected on disconnect (1 ms)
      ✓ should update isConnected on disconnect (1 ms)
      ✓ should NOT auto-reconnect on disconnect (ConnectionManager handles that) (2 ms)
      ✓ should NOT handle auth:required (ConnectionManager handles that) (1 ms)

PASS tests/integration/service-wiring.test.js (7.522 s)
  Service Wiring Integration
    full initialization flow
      ✓ should initialize all services and emit session:ready (1020 ms)
      ✓ should wire services so connected event triggers admin initialization (1007 ms)
      ✓ should wire services so connected event triggers queue sync (1005 ms)
      ✓ should use real ConnectionManager for token validation (5 ms)
      ✓ should use real ConnectionManager for health checks (4 ms)
      ✓ should use real OrchestratorClient for WebSocket connection (1005 ms)
    error propagation
      ✓ should propagate connection errors to session:error (9 ms)
      ✓ should emit auth:required on token expiry during initialization (3 ms)
      ✓ should handle disconnect events after initialization (5 ms)
    cleanup
      ✓ should cleanup all services on destroy (1004 ms)
      ✓ should cleanup in reverse order (LIFO) (4 ms)
      ✓ should remove event listeners on destroy (1005 ms)
    event-driven coordination
      ✓ should coordinate admin pause on disconnect via events (8 ms)
      ✓ should forward auth:required events from ConnectionManager to Session (1004 ms)

Test Suites: 5 passed, 5 total
Tests:       120 passed, 120 total
Snapshots:   0 total
Time:        8.396 s
Ran all test suites.
