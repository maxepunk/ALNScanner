<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Memory Transaction Station</title>
    <link rel="stylesheet" href="/src/styles/main.css">
</head>
<body>
    <!-- Connection Wizard Modal -->
    <div id="connectionModal" class="modal">
        <div class="modal-content">
            <h2>üéÆ Connect to Game Server</h2>

            <!-- Discovery Section (PRIMARY) -->
            <div id="discoverySection">
                <button id="scanServersBtn" class="primary-btn" data-action="connectionWizard.scanForServers">
                    üîç Scan for Game Servers
                </button>
                <div id="discoveryStatus"></div>
                <div id="discoveredServers"></div>
            </div>

            <div class="divider">‚îÄ‚îÄ‚îÄ OR Enter Manually ‚îÄ‚îÄ‚îÄ</div>

            <!-- Manual Configuration -->
            <form id="connectionForm">
                <div class="form-group">
                    <label>Server Address:</label>
                    <input type="text" id="serverUrl" placeholder="http://10.0.0.135:3000">
                </div>

                <div class="form-group">
                    <label>Station Name:</label>
                    <div id="stationNameDisplay" class="station-display" data-device-id="">
                        <span class="loading-text">Select a server first...</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>GM Password:</label>
                    <input type="password" id="gmPassword" placeholder="Enter password">
                </div>

                <div id="connectionStatusMsg"></div>

                <div class="button-group">
                    <button type="submit" class="primary-btn">Connect</button>
                    <button type="button" data-action="connectionWizard.cancelNetworkedMode" class="secondary-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <div class="header-nav" id="headerNav">
                <!-- Connection Status Indicator -->
                <a href="#" data-action="connectionWizard.showConnectionWizard" id="connectionStatus" class="connection-status disconnected" title="Click to configure connection">
                    <span class="status-dot"></span>
                    <span class="status-text">Disconnected</span>
                </a>
                <button class="nav-button" data-action="app.showHistory" title="View transaction history">
                    üìã<span id="historyBadge" class="badge" style="display: none;">0</span>
                </button>
                <button class="nav-button" id="scoreboardButton" data-action="app.showScoreboard" title="View scoreboard" style="display: none;">
                    üèÜ
                </button>
                <button class="nav-button" data-action="app.showSettings" title="Settings">
                    ‚öôÔ∏è
                </button>
            </div>
            <div class="header-content">
                <h1>Transaction Station</h1>
                <div id="modeIndicator" class="mode-indicator mode-detective" data-action="app.toggleMode" title="Click to switch mode">Detective Mode</div>
                <div class="device-id">Device ID: <span id="deviceIdDisplay">001</span></div>
            </div>
        </div>

        <!-- View Selector Tabs (Only visible in networked mode) -->
        <div id="viewSelector" class="view-selector" style="display: none;">
            <button class="view-tab active" data-view="scanner" data-action="app.switchView" data-arg="scanner">
                <span class="tab-icon">üì±</span>
                <span class="tab-text">Scanner</span>
            </button>
            <button class="view-tab" data-view="admin" data-action="app.switchView" data-arg="admin">
                <span class="tab-icon">‚öôÔ∏è</span>
                <span class="tab-text">Admin</span>
            </button>
            <button class="view-tab" data-view="debug" data-action="app.switchView" data-arg="debug">
                <span class="tab-icon">üêõ</span>
                <span class="tab-text">Debug</span>
            </button>
        </div>

        <!-- Scanner View (Default) -->
        <div id="scanner-view" class="view-content">

        <!-- Loading Screen -->
        <div id="loadingScreen" class="screen">
            <div class="status-message">
                <div class="scan-icon">‚è≥</div>
                <p>Loading token database...</p>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <div class="settings-panel">
                <h3>Station Configuration</h3>
                <div class="settings-group">
                    <label for="deviceId">Device ID</label>
                    <input type="text" id="deviceId" placeholder="001" maxlength="10">
                </div>
                <div class="toggle-switch">
                    <label>Station Mode</label>
                    <label class="switch">
                        <input type="checkbox" id="modeToggle" onchange="App.updateModeFromToggle()">
                        <span class="slider"></span>
                    </label>
                </div>
                <p style="text-align: center; color: #666; margin-top: 10px;">
                    <span id="modeText">Detective Mode</span>
                </p>
            </div>

            <!-- Network configuration removed - use connection wizard instead -->

            <button class="btn btn-primary" data-action="app.saveSettings">Save & Start Station</button>
            <div class="settings-panel" style="margin-top: 20px;">
                <h3>Data Management</h3>
                <button class="btn btn-secondary" data-action="dataManager.exportData" data-arg="json">Export JSON</button>
                <button class="btn btn-secondary" data-action="dataManager.exportData" data-arg="csv">Export CSV</button>
                <button class="btn btn-secondary" data-action="dataManager.clearData">Clear All Data</button>
                <button class="btn btn-secondary" data-action="app.testTokenMatch">Test Token Match</button>
                <button class="btn btn-secondary" data-action="app.testGroupParsing">Test Group Parsing</button>
                <button class="btn btn-secondary" data-action="app.testGroupInventory">Test Group Inventory</button>
                <button class="btn btn-secondary" data-action="app.testCompletionDetection">Test Completions</button>
                <button class="btn btn-secondary" data-action="app.testBonusCalculations">Test Bonuses</button>
                <button class="btn btn-secondary" data-action="app.testEnhancedUI">Test Enhanced UI</button>
            </div>
        </div>

        <!-- Game Mode Selection Screen -->
        <div id="gameModeScreen" class="screen">
            <div class="mode-selection" style="
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                padding: 20px;
            ">
                <h2 style="color: white; margin-bottom: 40px; font-size: 28px;">How are you playing today?</h2>

                <div style="display: flex; gap: 30px; flex-wrap: wrap; justify-content: center;">
                    <button class="mode-option" data-action="app.selectGameMode" data-arg="networked" style="
                        background: rgba(255, 255, 255, 0.1);
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        border-radius: 20px;
                        padding: 40px;
                        min-width: 250px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        color: white;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
                        <span class="mode-icon" style="font-size: 48px; display: block; margin-bottom: 20px;">üåê</span>
                        <h3 style="margin: 10px 0;">Networked Game</h3>
                        <p style="opacity: 0.8; margin-top: 10px;">With orchestrator server for<br>multi-device coordination</p>
                    </button>

                    <button class="mode-option" data-action="app.selectGameMode" data-arg="standalone" style="
                        background: rgba(255, 255, 255, 0.1);
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        border-radius: 20px;
                        padding: 40px;
                        min-width: 250px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        color: white;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
                        <span class="mode-icon" style="font-size: 48px; display: block; margin-bottom: 20px;">üì±</span>
                        <h3 style="margin: 10px 0;">Standalone Game</h3>
                        <p style="opacity: 0.8; margin-top: 10px;">Scanner only,<br>no server required</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- Team Entry Screen -->
        <div id="teamEntryScreen" class="screen">
            <div class="team-display" id="teamDisplay">_</div>
            <div class="numpad">
                <button data-action="app.appendNumber" data-arg="1">1</button>
                <button data-action="app.appendNumber" data-arg="2">2</button>
                <button data-action="app.appendNumber" data-arg="3">3</button>
                <button data-action="app.appendNumber" data-arg="4">4</button>
                <button data-action="app.appendNumber" data-arg="5">5</button>
                <button data-action="app.appendNumber" data-arg="6">6</button>
                <button data-action="app.appendNumber" data-arg="7">7</button>
                <button data-action="app.appendNumber" data-arg="8">8</button>
                <button data-action="app.appendNumber" data-arg="9">9</button>
                <button class="clear" data-action="app.clearTeamId">Clear</button>
                <button data-action="app.appendNumber" data-arg="0">0</button>
                <button class="enter" data-action="app.confirmTeamId">Enter</button>
            </div>
        </div>

        <!-- Scan Screen -->
        <div id="scanScreen" class="screen">
            <div class="status-message">
                Team <strong id="currentTeam"></strong> Ready
            </div>
            <div class="scan-area">
                <div class="scan-icon">üì°</div>
                <h2>Tap Memory Token</h2>
                <p id="scanStatus">Waiting for NFC tag...</p>
            </div>
            <button id="scanButton" class="btn btn-primary" data-action="app.startScan">Start Scanning</button>
            <button class="btn btn-secondary" data-action="app.manualEntry">Manual Entry (Debug)</button>
            <button class="btn btn-secondary" data-action="app.cancelScan">Back to Team Entry</button>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="teamTokenCount">0</div>
                    <div class="stat-label">Tokens</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="teamTotalValue">0</div>
                    <div class="stat-label" id="teamValueLabel">Total Value</div>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="resultScreen" class="screen">
            <div id="resultStatus" class="status-message success">
                <h2>Transaction Complete!</h2>
            </div>
            <div class="transaction-result">
                <h3>Token Details</h3>
                <div class="transaction-detail">
                    <label>RFID:</label>
                    <span class="value" id="resultRfid">-</span>
                </div>
                <div class="transaction-detail">
                    <label>Memory Type:</label>
                    <span class="value" id="resultType">-</span>
                </div>
                <div class="transaction-detail">
                    <label>Group:</label>
                    <span class="value" id="resultGroup">-</span>
                </div>
                <div class="transaction-detail">
                    <label>Value Rating:</label>
                    <span class="value" id="resultValue">-</span>
                </div>
                <div class="transaction-detail" id="resultSummaryContainer" style="display: none;">
                    <label>Summary:</label>
                    <span class="value summary-text" id="resultSummary">-</span>
                </div>
            </div>
            <button class="btn btn-primary" data-action="app.continueScan">Scan Another Token</button>
            <button class="btn btn-secondary" data-action="app.finishTeam">Finish Team</button>
        </div>

        <!-- History Screen -->
        <div id="historyScreen" class="screen">
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="value" id="totalScans">0</div>
                    <div class="label">Total Scans</div>
                </div>
                <div class="summary-stat">
                    <div class="value" id="uniqueTeams">0</div>
                    <div class="label">Teams</div>
                </div>
                <div class="summary-stat">
                    <div class="value" id="totalValue">0</div>
                    <div class="label">Total Value</div>
                </div>
                <div class="summary-stat">
                    <div class="value" id="avgValue">0</div>
                    <div class="label">Avg Value</div>
                </div>
            </div>
            
            <div class="filter-bar">
                <input type="text" id="searchFilter" placeholder="Search..." onkeyup="UIManager.filterTransactions()">
                <select id="modeFilter" onchange="UIManager.filterTransactions()">
                    <option value="">All Modes</option>
                    <option value="detective">Detective Only</option>
                    <option value="blackmarket">Black Market Only</option>
                </select>
            </div>
            
            <div id="historyContainer" class="history-container">
                <div class="empty-state">
                    <h3>No Transactions Yet</h3>
                </div>
            </div>
            
            <button class="btn btn-primary" data-action="app.closeHistory">Back</button>
        </div>

        <!-- Scoreboard Screen -->
        <div id="scoreboardScreen" class="screen">
            <div class="header" style="margin-bottom: 20px;">
                <h2>üèÜ Black Market Scoreboard</h2>
                <p style="color: #666; font-size: 14px;">Team Rankings</p>
            </div>
            
            <div id="scoreboardContainer" class="scoreboard-container">
                <!-- Populated by JavaScript -->
            </div>
            
            <button class="btn btn-primary" data-action="app.closeScoreboard">Back</button>
        </div>

        <!-- Team Details Screen -->
        <div id="teamDetailsScreen" class="screen">
            <div class="header" style="margin-bottom: 20px;">
                <h2 id="teamDetailsTitle">Team Details</h2>
                <p id="teamDetailsSummary" style="color: #666; font-size: 14px;"></p>
            </div>
            
            <div id="teamDetailsContainer" class="history-container">
                <!-- Populated by JavaScript -->
            </div>
            
            <div class="transaction-result">
                <h3>Score Breakdown</h3>
                <div class="transaction-detail">
                    <label>Base Score:</label>
                    <span class="value" id="teamBaseScore">$0</span>
                </div>
                <div class="transaction-detail">
                    <label>Group Bonuses:</label>
                    <span class="value" id="teamBonusScore">$0</span>
                </div>
                <!-- Admin Adjustments Display (populated by JS) -->
                <div id="teamAdminAdjustmentsSection" style="display: none;"></div>
                <div class="transaction-detail" style="font-weight: bold; font-size: 18px; margin-top: 10px; padding-top: 10px; border-top: 2px solid #667eea;">
                    <label>Total Score:</label>
                    <span class="value" id="teamTotalScore">$0</span>
                </div>
            </div>

            <!-- GM Intervention Controls (Both Modes) -->
            <div id="teamInterventionControls" style="display: none; margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è GM Intervention</h4>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <input type="number" id="scoreAdjustmentInput" placeholder="Amount (+ or -)" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="text" id="scoreAdjustmentReason" placeholder="Reason (optional)" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <button class="btn" data-action="app.adjustTeamScore" style="background: #ffc107; color: #000;">Adjust Score</button>
                </div>
                <p style="font-size: 12px; color: #856404; margin: 0;">Use positive numbers to add points, negative to subtract. In networked mode, changes sync across all scanners.</p>
            </div>

            <button class="btn btn-primary" data-action="app.closeTeamDetails">Back to Scoreboard</button>
        </div>
    </div>

        </div> <!-- End of scanner-view -->

        <!-- Admin View (Hidden by default) -->
        <div id="admin-view" class="view-content" style="display: none;">
            <!-- Session Management Section -->
            <section class="admin-section">
                <h3>Session Management</h3>
                <!-- Dynamic status container updated by MonitoringDisplay.updateSessionDisplay() -->
                <div id="session-status-container">
                    <!-- Content rendered by updateSessionDisplay() based on session state -->
                </div>
            </section>

            <!-- Video Controls Section -->
            <section class="admin-section">
                <h3>Video Controls</h3>

                <!-- Phase 4.2: Unified "Now Showing" display -->
                <div class="display-status">
                    <div class="display-status__now-showing">
                        <span class="display-status__label">Now Showing:</span>
                        <span class="display-status__value" id="now-showing-value">Idle Loop</span>
                        <span class="display-status__icon" id="now-showing-icon">üîÑ</span>
                    </div>
                    <div class="display-status__queue">
                        Queue: <span id="pending-queue-count">0</span> pending
                    </div>
                </div>

                <!-- Phase 4.2: "Returns to" indicator (hidden when no video playing) -->
                <div class="display-status__returns-to" id="returns-to-container" style="display: none;">
                    Returns to: <span id="returns-to-mode">Idle Loop</span> when complete
                </div>

                <!-- Phase 4.2: Idle Mode Toggle -->
                <div class="idle-mode-toggle">
                    <span class="idle-mode-toggle__label">Idle Mode:</span>
                    <div class="idle-mode-toggle__buttons">
                        <button class="btn btn-toggle active" id="btn-idle-loop" data-action="app.adminSetIdleLoop">üîÑ Idle Loop</button>
                        <button class="btn btn-toggle" id="btn-scoreboard" data-action="app.adminSetScoreboard">üèÜ Scoreboard</button>
                    </div>
                </div>

                <!-- Legacy display info (kept for backwards compatibility) -->
                <div id="video-info" class="info-row" style="display: none;">
                    <span>Current: <span id="admin-current-video">None</span></span>
                    <span>Queue: <span id="admin-queue-length">0</span></span>
                </div>

                <!-- Video Progress Bar -->
                <div id="video-progress-container" style="margin: 15px 0; display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="video-progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-time" id="video-progress-time" style="text-align: center; margin-top: 5px; font-size: 12px; color: #666;">0s / 0s</div>
                </div>

                <div class="video-controls">
                    <button class="btn" data-action="app.adminPlayVideo">Play</button>
                    <button class="btn" data-action="app.adminPauseVideo">Pause</button>
                    <button class="btn" data-action="app.adminStopVideo">Stop</button>
                    <button class="btn" data-action="app.adminSkipVideo">Skip</button>
                </div>

                <!-- Queue Display -->
                <div id="video-queue-container" style="margin-top: 20px; display: none;">
                    <h4 style="margin-bottom: 10px;">Pending Videos (<span id="queue-count">0</span>)</h4>
                    <div id="video-queue-list" class="queue-list" style="max-height: 200px; overflow-y: auto;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Manual Queue Management -->
                <div class="manual-queue-section" style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">Manual Queue Control</h4>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="manual-video-input" placeholder="jaw001.mp4" list="available-videos" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <datalist id="available-videos">
                            <!-- Populated by loadAvailableVideos() -->
                        </datalist>
                        <button class="btn" data-action="app.adminAddVideoToQueue">Add to Queue</button>
                    </div>
                    <button class="btn btn-secondary" data-action="app.adminClearQueue" style="width: 100%;">Clear Entire Queue</button>
                </div>
            </section>

            <!-- System Status Section -->
            <section class="admin-section">
                <h3>System Status</h3>
                <div class="status-grid">
                    <div class="status-item">
                        <span>Orchestrator:</span>
                        <span id="orchestrator-status" class="status-dot">‚óè</span>
                    </div>
                    <div class="status-item">
                        <span>VLC:</span>
                        <span id="vlc-status" class="status-dot">‚óè</span>
                    </div>
                    <div class="status-item">
                        <span>Devices:</span>
                        <span id="device-count">0</span>
                    </div>
                </div>
                <div id="device-list" class="device-list"></div>
            </section>

            <!-- Score Board Section -->
            <section class="admin-section">
                <h3>Team Scores</h3>
                <div id="admin-score-board" class="score-board">
                    <!-- Scores will be populated here -->
                </div>
                <button class="btn btn-secondary" data-action="app.viewFullScoreboard" style="margin-right: 10px;">
                    View Full Scoreboard
                </button>
                <button class="btn btn-danger" data-action="app.adminResetScores">Reset All Scores</button>
            </section>

            <!-- Transaction Log Section -->
            <section class="admin-section">
                <h3>Recent Transactions</h3>
                <div id="admin-transaction-log" class="transaction-log">
                    <!-- Transactions will be populated here -->
                </div>
                <button class="btn btn-secondary" data-action="app.viewFullHistory" style="margin-right: 10px;">
                    View Full History
                </button>
            </section>
        </div> <!-- End of admin-view -->

        <!-- Debug View -->
        <div id="debug-view" class="view-content" style="display: none;">
            <div id="debugContent" class="debug-content"></div>
        </div>

    </div> <!-- End of container -->

    <!-- Debug Panel (Legacy, replaced by debug-view) -->
    <!-- Debug toggle moved to tabs -->

    <!-- ============================================
         ES6 MODULE ENTRY POINT
         Vite handles all module loading
         ============================================ -->
    <script type="module" src="/src/main.js"></script>

    <!-- ============================================
         ORCHESTRATOR WEBSOCKET INTEGRATION
         ============================================ -->
    <!-- Socket.io v4 Client Library (auto-served by orchestrator at /socket.io/socket.io.js) -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- ============================================
         CONNECTION WIZARD (ES6 MODULES)
         ============================================ -->
    <!--
         Connection wizard functionality moved to ES6 module:
         src/ui/connectionWizard.js

         Functions now available via ConnectionWizard class:
         - scanForServers()
         - handleConnectionSubmit()
         - cancelNetworkedMode()
         - showConnectionWizard()
         - showAuthModal()

         Use data-action attributes for event binding:
         - data-action="connectionWizard.scanForServers"
         - data-action="connectionWizard.handleConnectionSubmit"
         - etc.

         See src/utils/domEventBindings.js for event delegation.
    -->

    <!-- ============================================
         WEBSOCKET CONTRACT TESTS (TDD)
         ============================================ -->
    <!-- QUnit Testing Framework -->
    <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.20.0.css">
    <script src="https://code.jquery.com/qunit/qunit-2.20.0.js"></script>

    <!-- Test Container -->
    <div id="websocket-tests" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000; overflow: auto;">
        <div style="padding: 20px;">
            <h2>WebSocket Integration Tests</h2>
            <button onclick="document.getElementById('websocket-tests').style.display='none'" style="position: absolute; top: 20px; right: 20px; padding: 10px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
            <div id="qunit"></div>
            <div id="qunit-fixture"></div>
        </div>
    </div>

    <!-- ============================================
         PHASE 2.4 (P1.4): CLEANUP ON PAGE UNLOAD
         ============================================ -->
    <!--
         Cleanup handler moved to ES6 module:
         src/ui/connectionWizard.js - setupCleanupHandlers()

         Automatically initialized in src/main.js
    -->

    <!-- P2.2.3: Queue Status Indicator Update Logic (Event-Driven) -->
    <!--
         Queue status indicator logic moved to ES6 module:
         src/ui/connectionWizard.js - QueueStatusManager class

         Automatically initialized in src/main.js with event-driven updates.
    -->

    <!-- P2.2.3: Queue Status Indicator -->
    <div id="queueStatusIndicator" class="queue-indicator" title="Offline scans queued for upload">
        <span class="queue-icon">üì§</span>
        <span class="queue-count" id="queueCount">0</span>
        <span>queued</span>
    </div>

</body>
</html>
