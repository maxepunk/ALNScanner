name: Test & Build

on:
  push:
    branches: [main, pr-4-review, pr-5-review]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm test -- --coverage --maxWorkers=2

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build with Vite
        run: npm run build

      - name: Verify dist artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "❌ dist/ directory not created"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "❌ dist/index.html not found"
            exit 1
          fi
          if [ ! -f "dist/assets/index.js" ] && [ ! -f "dist/assets/index-*.js" ]; then
            echo "❌ No JavaScript bundle found in dist/assets/"
            exit 1
          fi
          echo "✓ Build artifacts verified"

      - name: Check bundle size
        run: |
          SIZE=$(du -sk dist | cut -f1)
          echo "Bundle size: ${SIZE}KB"
          if [ $SIZE -gt 10240 ]; then
            echo "⚠️  Bundle size exceeds 10MB (${SIZE}KB)"
            exit 1
          fi
          echo "✓ Bundle size acceptable: ${SIZE}KB"

  integration-check:
    name: Integration Check
    runs-on: ubuntu-latest
    needs: [unit-tests, build-verification]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify critical files
        run: |
          files=(
            "babel.config.js"
            "vite.config.js"
            "src/main.js"
            "src/network/networkedSession.js"
            "src/network/networkedQueueManager.js"
            "tests/unit/network/networkedSession.test.js"
            "tests/unit/network/networkedQueueManager.test.js"
          )

          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Critical file missing: $file"
              exit 1
            fi
          done
          echo "✓ All critical files present"

      - name: Run smoke test
        run: |
          npm test -- tests/unit/network/networkedSession.test.js --silent
          npm test -- tests/unit/network/networkedQueueManager.test.js --silent
          echo "✓ Critical module tests passing"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, build-verification, integration-check]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "❌ Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.build-verification.result }}" != "success" ]; then
            echo "❌ Build verification failed"
            exit 1
          fi
          if [ "${{ needs.integration-check.result }}" != "success" ]; then
            echo "❌ Integration check failed"
            exit 1
          fi
          echo "✅ All checks passed"
